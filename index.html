<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Intraday Forecast Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    :root {
      --primary-color: #63AB8F;
      --secondary-color: #4A8C7D;
      --border-color: #DEE2E6;
      --light-bg: #F8F9FA;
      --card-bg: #FFFFFF;
      --text-color: #2C3E50;
      --text-light: #6C757D;
    }

    body {
      font-family: 'Aptos', 'Segoe UI', system-ui, -apple-system, Arial, sans-serif;
      margin: 20px;
      padding: 20px;
      max-width: 1400px;
      background: var(--light-bg);
      color: var(--text-color);
    }

    #logo-container {
      text-align: center;
      margin-bottom: 20px;
    }

    #logo {
      width: 300px;
    }

    h1 {
      margin: 0 0 16px;
    }

    .card {
      background: var(--card-bg);
      border: 1px solid var(--border-color);
      border-radius: 12px;
      padding: 24px;
      margin-top: 16px;
      box-shadow: 0 1px 3px rgba(0,0,0,.08);
    }

    label {
      display: block;
      font-weight: 600;
      margin-bottom: 6px;
      font-size: 14px;
    }

    input, select, button, textarea {
      padding: 10px;
      border: 1px solid var(--border-color);
      border-radius: 6px;
      background: #fff;
      font-size: 14px;
      width: 100%;
      box-sizing: border-box;
    }

    button {
      background: var(--primary-color);
      color: #fff;
      font-weight: 600;
      cursor: pointer;
      transition: background .2s;
      border: none;
    }

    button:hover {
      background: var(--secondary-color);
    }

    button:disabled {
      background: var(--text-light);
      cursor: not-allowed;
    }

    .controls {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;
      align-items: end;
    }

    .control-group {
      display: flex;
      flex-direction: column;
      min-height: 82px;
    }

    .full-width-btn {
      width: 100%;
      padding: 14px 18px;
      font-size: 16px;
      margin-top: 0;
    }

    .muted {
      color: var(--text-light);
      font-size: 12px;
      margin-top: 4px;
      line-height: 1.3;
    }

    .section-title {
      margin: 0 0 10px;
      color: var(--secondary-color);
    }

    #messageContainer {
      display: none;
      margin-top: 12px;
    }

    .error-message {
      color: #b4231a;
      background: #fee2e2;
      border: 1px solid #fecaca;
      padding: 10px;
      border-radius: 6px;
    }

    .success-message {
      color: #14532d;
      background: #dcfce7;
      border: 1px solid #bbf7d0;
      padding: 10px;
      border-radius: 6px;
    }

    .info-message {
      color: #6b4e16;
      background: #fff7ed;
      border: 1px solid #ffedd5;
      padding: 10px;
      border-radius: 6px;
    }

    /* Table Styling */
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
      border: 1px solid var(--border-color);
      border-radius: 6px;
      overflow: hidden;
    }

    th, td {
      padding: 10px 12px;
      text-align: left;
      border-bottom: 1px solid var(--border-color);
      vertical-align: middle;
    }

    th {
      background-color: var(--primary-color);
      color: white;
      font-weight: 600;
    }

    tr:hover {
      background-color: rgba(99, 171, 143, 0.05);
    }

    .consolidated-table th.group-header {
      background-color: var(--secondary-color);
      text-align: center;
    }

    .consolidated-table th.sub-header {
      background-color: rgba(99, 171, 143, 0.8);
    }

    .weekly-totals-row {
      background-color: rgba(99, 171, 143, 0.1);
      font-weight: 600;
    }

    .weekly-totals-row td {
      border-bottom: 2px solid var(--primary-color);
    }

    /* Tab Styling */
    .tab {
      display: inline-block;
      padding: 12px 20px;
      margin-right: 10px;
      background: #eee;
      cursor: pointer;
      border-radius: 6px;
      font-weight: 500;
    }

    .tab.active {
      background: var(--primary-color);
      color: white;
      font-weight: 600;
    }

    .tab-content {
      display: none;
    }

    .tab-content.active {
      display: block;
    }

    .no-data {
      color: var(--text-light);
      font-style: italic;
      text-align: center;
      padding: 20px;
    }

    .loading {
      color: var(--text-light);
      font-style: italic;
      text-align: center;
      padding: 20px;
    }

    .table-container {
      overflow-x: auto;
      margin-top: 20px;
      border: 1px solid var(--border-color);
      border-radius: 6px;
      padding: 1px;
    }

    .metrics-section {
      margin-bottom: 30px;
    }

    .metrics-section h3 {
      color: var(--secondary-color);
      margin-bottom: 15px;
      border-bottom: 2px solid var(--primary-color);
      padding-bottom: 5px;
    }

    /* Chart Styles */
    .chart-container {
      margin: 20px 0;
      padding: 20px;
      background: white;
      border-radius: 8px;
      border: 1px solid var(--border-color);
    }

    .chart-controls {
      display: flex;
      gap: 15px;
      margin-bottom: 20px;
      flex-wrap: wrap;
    }

    .chart-controls select {
      width: auto;
      min-width: 200px;
    }

    /* Clickable rows */
    .clickable-row {
      cursor: pointer;
    }

    .clickable-row:hover {
      background-color: rgba(99, 171, 143, 0.1) !important;
    }

    /* Responsive adjustments */
    @media (max-width: 768px) {
      body {
        margin: 10px;
        padding: 10px;
      }
      
      .card {
        padding: 16px;
      }
      
      .controls {
        grid-template-columns: 1fr;
        gap: 15px;
      }
      
      .tab {
        padding: 10px 15px;
        font-size: 14px;
      }
      
      .chart-controls {
        flex-direction: column;
      }
      
      .chart-controls select {
        width: 100%;
      }
    }

    .progress-bar {
      width: 100%;
      height: 4px;
      background: #e9ecef;
      border-radius: 2px;
      margin-top: 5px;
      overflow: hidden;
    }

    .progress-fill {
      height: 100%;
      background: var(--primary-color);
      width: 0%;
      transition: width 0.3s ease;
    }

    .auth-container {
      text-align: center;
      padding: 40px;
    }

    .auth-button {
      display: inline-block;
      background: var(--primary-color);
      color: white;
      padding: 15px 30px;
      border-radius: 8px;
      text-decoration: none;
      font-weight: 600;
      font-size: 16px;
      margin: 20px 0;
    }

    .auth-button:hover {
      background: var(--secondary-color);
    }
  </style>
</head>
<body>
  <div id="logo-container">
    <img id="logo" src="https://raw.githubusercontent.com/gmcglynn88/Management-Unit-Search/main/Consultinglogo%20(2).png" alt="Company Logo">
  </div>

  <h1>Intraday Forecast Dashboard</h1>

  <div id="authCard" class="card">
    <div class="auth-container">
      <h2>Authentication Required</h2>
      <p>Please authenticate with Genesys PureCloud to access the forecast dashboard.</p>
      <a href="#" id="authButton" class="auth-button">Sign in with Genesys</a>
      <div id="authStatus" class="info-message" style="margin-top: 20px; display: none;">
        Authenticating...
      </div>
    </div>
  </div>

  <div id="appContent" style="display:none;">
    <div id="messageContainer"></div>

    <div class="card">
      <h2 class="section-title">Configuration</h2>
      <div class="controls">
        <div class="control-group">
          <label for="businessUnitSelect">Business Unit:</label>
          <select id="businessUnitSelect">
            <option value="">-- Select Business Unit --</option>
            <option value="demo-bu-1">Demo Business Unit 1</option>
            <option value="demo-bu-2">Demo Business Unit 2</option>
          </select>
        </div>
        <div class="control-group">
          <label for="planningGroup">Planning Group:</label>
          <select id="planningGroup">
            <option value="">-- Select Planning Group --</option>
            <option value="demo-pg-1">Demo Planning Group 1</option>
            <option value="demo-pg-2">Demo Planning Group 2</option>
            <option value="__ALL__">All planning groups</option>
          </select>
          <div class="muted">Choose "All planning groups" to see separate tables per PG.</div>
        </div>
        <div class="control-group">
          <label for="dateFrom">Date From:</label>
          <input type="date" id="dateFrom" class="calendar-input">
        </div>
        <div class="control-group">
          <label for="dateTo">Date To:</label>
          <input type="date" id="dateTo" class="calendar-input">
        </div>
        <div class="control-group">
          <label>&nbsp;</label>
          <button id="loadDataBtn" class="full-width-btn">
            Load Forecast Data
          </button>
          <div class="progress-bar" id="progressBar" style="display: none;">
            <div class="progress-fill" id="progressFill"></div>
          </div>
        </div>
      </div>
    </div>

    <!-- Tabs -->
    <div class="card">
      <div style="margin-bottom: 20px;">
        <div id="tabs">
          <div id="dailyTabButton" class="tab active">Forecast Data</div>
          <div id="intervalTabButton" class="tab">Interval Data</div>
          <div id="chartsTabButton" class="tab">Charts & Analytics</div>
        </div>
      </div>
      
      <div id="dailyTab" class="tab-content active">
        <div class="chart-controls">
          <div>
            <label for="viewType">View Type:</label>
            <select id="viewType">
              <option value="daily">Daily View</option>
              <option value="weekly">Weekly View</option>
              <option value="monthly">Monthly View</option>
            </select>
          </div>
        </div>
        <h2 class="section-title">Forecast Data</h2>
        <div id="weeklySummary" class="loading">Select date range and click "Load Forecast Data" to view forecast and predictions</div>
        <div class="metrics-section" id="consolidatedSection" style="display: none;">
          <h3>ðŸ“Š Forecast & Performance Predictions</h3>
          <div id="consolidatedTableContainer"></div>
        </div>
      </div>
      
      <div id="intervalTab" class="tab-content">
        <h2 class="section-title">15-min Interval Data</h2>
        <div id="intervalTableContainer" class="loading">Click on a day in the Forecast Data tab to view interval data</div>
      </div>

      <div id="chartsTab" class="tab-content">
        <h2 class="section-title">Charts & Analytics</h2>
        <div class="chart-controls">
          <div>
            <label for="chartView">View:</label>
            <select id="chartView">
              <option value="daily">Daily View</option>
              <option value="weekly">Weekly Summary</option>
              <option value="monthly">Monthly Summary</option>
            </select>
          </div>
        </div>
        <div class="chart-container">
          <canvas id="metricsChart"></canvas>
        </div>
        <div id="chartsDataContainer" class="loading">Load forecast data to view charts</div>
      </div>
    </div>
  </div>

  <script>
    // ===== Configuration =====
    const CONFIG = {
      // Using demo mode to avoid authentication issues
      demoMode: true,
      timeFormat: 'seconds',
      precision: 1
    };

    // ===== Application State =====
    const state = {
      accessToken: null,
      dateRangeData: [],
      planningGroupsMap: {},
      dateFrom: null,
      dateTo: null,
      viewType: 'daily',
      charts: {},
      selectedDayForIntervals: null,
      isDataLoaded: false
    };

    // ===== Utility Functions =====
    function getMonday(date) {
      const d = new Date(date);
      const day = d.getDay();
      const diff = d.getDate() - day + (day === 0 ? -6 : 1);
      return new Date(d.setDate(diff));
    }

    function formatTime(seconds) {
      if (seconds === null || seconds === undefined) return '-';
      seconds = Math.round(seconds);
      const h = Math.floor(seconds / 3600);
      const m = Math.floor((seconds % 3600) / 60);
      const s = Math.floor(seconds % 60);
      return h > 0 ? `${h}:${m.toString().padStart(2, '0')}:${s.toString().padStart(2, '0')}` : `${m}:${s.toString().padStart(2, '0')}`;
    }

    function formatNumber(num) {
      if (num === null || num === undefined) return '-';
      return Number.isFinite(num) ? num.toFixed(CONFIG.precision) : '-';
    }

    function formatPercentage(num) {
      if (num === null || num === undefined) return '-';
      return Number.isFinite(num) ? (num * 100).toFixed(CONFIG.precision) + '%' : '-';
    }

    function getUKFormattedDate(date) {
      const d = date.getDate();
      const m = date.getMonth() + 1;
      const y = date.getFullYear();
      return `${d.toString().padStart(2, '0')}/${m.toString().padStart(2, '0')}/${y}`;
    }

    function getDOWFromUK(ukDate) {
      const [dd, mm, yyyy] = ukDate.split('/').map(Number);
      const dt = new Date(yyyy, mm - 1, dd);
      return dt.toLocaleDateString('en-GB', { weekday: 'short' });
    }

    function isoDate(date) {
      const dt = new Date(date);
      dt.setHours(12, 0, 0, 0);
      const offsetDate = new Date(dt.getTime() - dt.getTimezoneOffset() * 60000);
      return offsetDate.toISOString().split('T')[0];
    }

    function getDateRange(startDate, endDate) {
      const dates = [];
      const current = new Date(startDate);
      const end = new Date(endDate);
      
      while (current <= end) {
        dates.push({
          raw: isoDate(current),
          uk: getUKFormattedDate(current),
          date: new Date(current)
        });
        current.setDate(current.getDate() + 1);
      }
      return dates;
    }

    function showMessage(msg, type = 'error', details = '') {
      const box = document.getElementById('messageContainer');
      let html = `<div class="${type}-message">${msg}</div>`;
      
      if (details) {
        html += `<div class="info-message" style="margin-top:8px;">
          <pre style="font-size:11px;overflow:auto;">${JSON.stringify(details, null, 2)}</pre>
        </div>`;
      }
      
      box.innerHTML = html;
      box.style.display = 'block';
      
      if (type === 'success') {
        setTimeout(() => box.style.display = 'none', 5000);
      }
    }

    // ===== Data Aggregation Functions =====
    function aggregateDataByPeriod(data, periodType) {
      const aggregated = {};
      
      data.forEach(day => {
        if (!day.date) return;
        
        let periodKey;
        let periodLabel;
        const date = day.date;
        
        switch (periodType) {
          case 'weekly':
            const weekStart = getMonday(date);
            periodKey = weekStart.toISOString().split('T')[0];
            periodLabel = `WC ${getUKFormattedDate(weekStart)}`;
            break;
          case 'monthly':
            periodKey = `${date.getFullYear()}-${(date.getMonth() + 1).toString().padStart(2, '0')}`;
            periodLabel = date.toLocaleDateString('en-GB', { month: 'long', year: 'numeric' });
            break;
          default: // daily
            periodKey = day.raw;
            periodLabel = day.uk;
        }
        
        if (!aggregated[periodKey]) {
          aggregated[periodKey] = {
            offered: 0,
            aht: 0,
            ahtCount: 0,
            sl: 0,
            slCount: 0,
            asa: 0,
            asaCount: 0,
            occupancy: 0,
            occupancyCount: 0,
            staffed: 0,
            label: periodLabel,
            startDate: day.date,
            endDate: day.date
          };
        }
        
        const period = aggregated[periodKey];
        
        // Update date range for this period
        if (day.date < period.startDate) period.startDate = day.date;
        if (day.date > period.endDate) period.endDate = day.date;
        
        // Sum up all metrics from demo data
        day.demoData?.forEach(group => {
          period.offered += group.offered || 0;
          period.aht += group.aht || 0;
          period.ahtCount += (group.aht && group.aht > 0) ? 1 : 0;
          
          if (group.serviceLevel !== null && group.serviceLevel !== undefined) {
            period.sl += group.serviceLevel;
            period.slCount++;
          }
          
          if (group.asa !== null && group.asa !== undefined) {
            period.asa += group.asa;
            period.asaCount++;
          }
          
          if (group.occupancy !== null && group.occupancy !== undefined) {
            period.occupancy += group.occupancy;
            period.occupancyCount++;
          }
          
          period.staffed += group.staffed || 0;
        });
      });
      
      return Object.values(aggregated);
    }

    // ===== Demo Data Generation =====
    function generateDemoData(date) {
      // Generate realistic demo data
      const baseOffered = Math.floor(Math.random() * 1000) + 500;
      const baseAHT = Math.floor(Math.random() * 300) + 180;
      const baseStaffed = Math.floor(Math.random() * 50) + 20;
      
      return [{
        offered: baseOffered,
        aht: baseAHT,
        serviceLevel: 0.7 + Math.random() * 0.25, // 70-95%
        asa: Math.floor(Math.random() * 60) + 10, // 10-70 seconds
        occupancy: 0.6 + Math.random() * 0.3, // 60-90%
        staffed: baseStaffed,
        planningGroupId: document.getElementById('planningGroup').value
      }];
    }

    async function fetchDataForDateRange(startDate, endDate) {
      const days = getDateRange(startDate, endDate);
      
      showMessage(`Generating demo forecast data for ${days.length} days...`, 'info');
      
      // Show progress bar
      const progressBar = document.getElementById('progressBar');
      const progressFill = document.getElementById('progressFill');
      progressBar.style.display = 'block';
      progressFill.style.width = '0%';
      
      state.dateRangeData = [];
      
      // Generate demo data with progress
      let completed = 0;
      
      for (let i = 0; i < days.length; i++) {
        const day = days[i];
        
        // Simulate API delay
        await new Promise(resolve => setTimeout(resolve, 50));
        
        state.dateRangeData.push({
          ...day,
          demoData: generateDemoData(day.raw)
        });
        
        // Update progress
        completed++;
        progressFill.style.width = `${(completed / days.length) * 100}%`;
      }
      
      // Hide progress bar
      progressBar.style.display = 'none';
      
      state.isDataLoaded = true;
      renderAllData();
      showMessage('Demo forecast data generated successfully!', 'success');
    }

    // ===== UI Event Handlers =====
    function onBusinessUnitChange() {
      updateLoadButtonState();
    }

    function onPlanningGroupChange() {
      updateLoadButtonState();
    }

    function onConfigChange() {
      if (state.isDataLoaded) {
        renderAllData();
        updateCharts();
      }
    }

    function updateLoadButtonState() {
      const businessUnitId = document.getElementById('businessUnitSelect').value;
      const planningGroupId = document.getElementById('planningGroup').value;
      const dateFrom = document.getElementById('dateFrom').value;
      const dateTo = document.getElementById('dateTo').value;
      
      document.getElementById('loadDataBtn').disabled = !(businessUnitId && planningGroupId && dateFrom && dateTo);
    }

    function loadData() {
      const dateFrom = document.getElementById('dateFrom').value;
      const dateTo = document.getElementById('dateTo').value;
      
      if (!dateFrom || !dateTo) {
        showMessage('Please select both start and end dates', 'error');
        return;
      }
      
      if (new Date(dateFrom) > new Date(dateTo)) {
        showMessage('End date must be after start date', 'error');
        return;
      }
      
      const dayCount = Math.ceil((new Date(dateTo) - new Date(dateFrom)) / (1000 * 60 * 60 * 24)) + 1;
      if (dayCount > 90) {
        showMessage('Please select a date range of 90 days or less', 'error');
        return;
      }
      
      state.dateFrom = dateFrom;
      state.dateTo = dateTo;
      
      document.getElementById('loadDataBtn').disabled = true;
      document.getElementById('loadDataBtn').textContent = 'Loading...';
      document.getElementById('consolidatedSection').style.display = 'none';
      
      fetchDataForDateRange(dateFrom, dateTo).finally(() => {
        document.getElementById('loadDataBtn').disabled = false;
        document.getElementById('loadDataBtn').textContent = 'Load Forecast Data';
        updateCharts();
      });
    }

    function setActiveTab(tabName) {
      // Update tab buttons
      document.getElementById('dailyTabButton').classList.toggle('active', tabName === 'daily');
      document.getElementById('intervalTabButton').classList.toggle('active', tabName === 'interval');
      document.getElementById('chartsTabButton').classList.toggle('active', tabName === 'charts');
      
      // Update tab content
      document.getElementById('dailyTab').classList.toggle('active', tabName === 'daily');
      document.getElementById('intervalTab').classList.toggle('active', tabName === 'interval');
      document.getElementById('chartsTab').classList.toggle('active', tabName === 'charts');

      if (tabName === 'charts') {
        updateCharts();
      }
    }

    // ===== Data Rendering Functions =====
    function renderAllData() {
      renderConsolidatedTable();
      updateCharts();
    }

    function renderConsolidatedTable() {
      const container = document.getElementById('consolidatedTableContainer');
      const planningGroups = groupsPresent();
      
      if (planningGroups.length === 0) {
        container.innerHTML = '<div class="no-data">No planning groups in data.</div>';
        document.getElementById('consolidatedSection').style.display = 'none';
        return;
      }

      const viewType = document.getElementById('viewType').value;
      
      let html = '';
      
      planningGroups.forEach(group => {
        html += `
          <div class="table-container" style="margin-bottom:30px;">
            <table class="consolidated-table">
              <tr>
                <th colspan="8" class="group-header">Planning Group: ${group.name} - ${viewType.toUpperCase()} VIEW</th>
              </tr>
              <tr>
                <th class="sub-header">Period</th>
                <th class="sub-header">Date Range</th>
                <th class="sub-header">Offered</th>
                <th class="sub-header">Avg Handle Time</th>
                <th class="sub-header">Service Level</th>
                <th class="sub-header">Avg Speed Answer</th>
                <th class="sub-header">Occupancy</th>
                <th class="sub-header">Staffed</th>
              </tr>
        `;

        // Filter data for this specific planning group
        const groupData = state.dateRangeData.map(day => ({
          ...day,
          demoData: day.demoData?.filter(g => !g.planningGroupId || g.planningGroupId === group.id) || []
        }));

        const aggregatedData = aggregateDataByPeriod(groupData, viewType);
        
        let grandTotals = { offered: 0, aht: 0, ahtCount: 0, sl: 0, slCount: 0, asa: 0, asaCount: 0, occupancy: 0, occupancyCount: 0, staffed: 0 };

        aggregatedData.forEach(period => {
          // Add to grand totals
          grandTotals.offered += period.offered;
          grandTotals.aht += period.aht;
          grandTotals.ahtCount += period.ahtCount;
          grandTotals.sl += period.sl;
          grandTotals.slCount += period.slCount;
          grandTotals.asa += period.asa;
          grandTotals.asaCount += period.asaCount;
          grandTotals.occupancy += period.occupancy;
          grandTotals.occupancyCount += period.occupancyCount;
          grandTotals.staffed += period.staffed;

          const dateRange = viewType === 'daily' ? 
            period.label : 
            `${getUKFormattedDate(period.startDate)} - ${getUKFormattedDate(period.endDate)}`;

          html += `
            <tr class="clickable-row" data-period="${period.label}">
              <td>${period.label}</td>
              <td>${dateRange}</td>
              <td>${formatNumber(period.offered)}</td>
              <td>${formatTime(period.ahtCount > 0 ? period.aht / period.ahtCount : 0)}</td>
              <td>${formatPercentage(period.slCount > 0 ? period.sl / period.slCount : null)}</td>
              <td>${formatTime(period.asaCount > 0 ? period.asa / period.asaCount : null)}</td>
              <td>${formatPercentage(period.occupancyCount > 0 ? period.occupancy / period.occupancyCount : null)}</td>
              <td>${formatNumber(period.staffed)}</td>
            </tr>
          `;
        });

        // Add grand totals row
        html += `
          <tr class="weekly-totals-row">
            <td colspan="2"><strong>GRAND TOTAL</strong></td>
            <td><strong>${formatNumber(grandTotals.offered)}</strong></td>
            <td><strong>${formatTime(grandTotals.ahtCount > 0 ? grandTotals.aht / grandTotals.ahtCount : 0)}</strong></td>
            <td><strong>${formatPercentage(grandTotals.slCount > 0 ? grandTotals.sl / grandTotals.slCount : null)}</strong></td>
            <td><strong>${formatTime(grandTotals.asaCount > 0 ? grandTotals.asa / grandTotals.asaCount : null)}</strong></td>
            <td><strong>${formatPercentage(grandTotals.occupancyCount > 0 ? grandTotals.occupancy / grandTotals.occupancyCount : null)}</strong></td>
            <td><strong>${formatNumber(grandTotals.staffed)}</strong></td>
          </tr>
        `;

        html += `</table></div>`;
      });

      container.innerHTML = html;
      document.getElementById('consolidatedSection').style.display = 'block';
      document.getElementById('weeklySummary').style.display = 'none';

      // Add click handlers for interval view
      document.querySelectorAll('.clickable-row').forEach(row => {
        row.addEventListener('click', function() {
          const period = this.getAttribute('data-period');
          showIntervalData(period);
        });
      });
    }

    function showIntervalData(period) {
      state.selectedDayForIntervals = period;
      setActiveTab('interval');
      render15MinTable(period);
    }

    function render15MinTable(period) {
      const container = document.getElementById('intervalTableContainer');
      
      if (!period) {
        container.innerHTML = '<div class="no-data">Click on a day in the Forecast Data tab to view interval data</div>';
        return;
      }

      // Generate demo interval data
      const planningGroups = groupsPresent();
      let html = `<h3>15-minute Interval Data for ${period}</h3>`;
      
      planningGroups.forEach(group => {
        html += `
          <div class="table-container" style="margin-bottom:30px;">
            <table class="consolidated-table">
              <tr>
                <th colspan="7" class="group-header">Planning Group: ${group.name} - 15-min Intervals</th>
              </tr>
              <tr>
                <th class="sub-header">Time</th>
                <th class="sub-header">Offered</th>
                <th class="sub-header">Avg Handle Time</th>
                <th class="sub-header">Service Level</th>
                <th class="sub-header">Avg Speed Answer</th>
                <th class="sub-header">Occupancy</th>
                <th class="sub-header">Staffed</th>
              </tr>
        `;

        // Generate 96 intervals (24 hours * 4 intervals per hour)
        for (let hour = 0; hour < 24; hour++) {
          for (let quarter = 0; quarter < 4; quarter++) {
            const time = `${hour.toString().padStart(2, '0')}:${(quarter * 15).toString().padStart(2, '0')}`;
            const offered = Math.floor(Math.random() * 50) + 10;
            const aht = Math.floor(Math.random() * 100) + 150;
            const serviceLevel = 0.6 + Math.random() * 0.35;
            const asa = Math.floor(Math.random() * 45) + 5;
            const occupancy = 0.5 + Math.random() * 0.4;
            const staffed = Math.floor(Math.random() * 10) + 5;

            html += `
              <tr>
                <td>${time}</td>
                <td>${formatNumber(offered)}</td>
                <td>${formatTime(aht)}</td>
                <td>${formatPercentage(serviceLevel)}</td>
                <td>${formatTime(asa)}</td>
                <td>${formatPercentage(occupancy)}</td>
                <td>${formatNumber(staffed)}</td>
              </tr>
            `;
          }
        }

        html += `</table></div>`;
      });

      container.innerHTML = html;
    }

    function groupsPresent() {
      const planningGroupId = document.getElementById('planningGroup').value;
      const planningGroupName = document.getElementById('planningGroup').selectedOptions[0]?.text || 'Planning Group';
      
      if (planningGroupId === '__ALL__') {
        return [
          { id: 'demo-pg-1', name: 'Demo Planning Group 1' },
          { id: 'demo-pg-2', name: 'Demo Planning Group 2' }
        ];
      } else {
        return [{ id: planningGroupId, name: planningGroupName }];
      }
    }

    // ===== Chart Functions =====
    function updateCharts() {
      if (!state.isDataLoaded) {
        document.getElementById('chartsDataContainer').innerHTML = '<div class="no-data">Load forecast data to view charts</div>';
        return;
      }

      const chartView = document.getElementById('chartView').value;
      
      renderChart(chartView);
    }

    function renderChart(chartView) {
      const ctx = document.getElementById('metricsChart').getContext('2d');
      
      // Destroy existing chart
      if (state.charts.metrics) {
        state.charts.metrics.destroy();
      }

      const planningGroups = groupsPresent();
      
      if (planningGroups.length === 0) {
        return;
      }

      // For combo chart, we'll show offered as bars and AHT as line
      const group = planningGroups[0];
      const labels = [];
      const offeredData = [];
      const ahtData = [];

      // Use the same aggregation as the table
      const groupData = state.dateRangeData.map(day => ({
        ...day,
        demoData: day.demoData?.filter(g => !g.planningGroupId || g.planningGroupId === group.id) || []
      }));

      const aggregatedData = aggregateDataByPeriod(groupData, chartView);
      
      aggregatedData.forEach(period => {
        labels.push(period.label);
        offeredData.push(period.offered);
        ahtData.push(period.ahtCount > 0 ? period.aht / period.ahtCount : 0);
      });

      // Combo chart configuration
      const chartConfig = {
        type: 'bar',
        data: {
          labels: labels,
          datasets: [
            {
              label: 'Offered Volume',
              data: offeredData,
              backgroundColor: 'rgba(99, 171, 143, 0.8)',
              borderColor: 'rgba(99, 171, 143, 1)',
              borderWidth: 1,
              yAxisID: 'y'
            },
            {
              label: 'Average Handle Time',
              data: ahtData,
              type: 'line',
              borderColor: 'rgba(255, 99, 132, 1)',
              backgroundColor: 'rgba(255, 99, 132, 0.2)',
              borderWidth: 2,
              fill: false,
              yAxisID: 'y1'
            }
          ]
        },
        options: {
          responsive: true,
          interaction: {
            mode: 'index',
            intersect: false,
          },
          stacked: false,
          plugins: {
            title: {
              display: true,
              text: `Offered Volume vs Average Handle Time - ${chartView} View`
            }
          },
          scales: {
            y: {
              type: 'linear',
              display: true,
              position: 'left',
              title: {
                display: true,
                text: 'Offered Volume'
              },
              beginAtZero: true
            },
            y1: {
              type: 'linear',
              display: true,
              position: 'right',
              title: {
                display: true,
                text: 'Average Handle Time (seconds)'
              },
              beginAtZero: true,
              grid: {
                drawOnChartArea: false,
              },
            }
          }
        }
      };

      state.charts.metrics = new Chart(ctx, chartConfig);
      document.getElementById('chartsDataContainer').innerHTML = '';
    }

    // ===== Authentication =====
    function initializeApplication() {
      // Skip actual authentication for demo
      document.getElementById('authCard').style.display = 'none';
      document.getElementById('appContent').style.display = 'block';
      initializeApp();
    }

    function initializeApp() {
      // Set up event listeners
      document.getElementById('businessUnitSelect').addEventListener('change', onBusinessUnitChange);
      document.getElementById('planningGroup').addEventListener('change', onPlanningGroupChange);
      document.getElementById('viewType').addEventListener('change', onConfigChange);
      document.getElementById('loadDataBtn').addEventListener('click', loadData);
      document.getElementById('chartView').addEventListener('change', updateCharts);
      
      // Tab navigation
      document.getElementById('dailyTabButton').addEventListener('click', () => setActiveTab('daily'));
      document.getElementById('intervalTabButton').addEventListener('click', () => setActiveTab('interval'));
      document.getElementById('chartsTabButton').addEventListener('click', () => setActiveTab('charts'));
      
      // Set default dates (last 7 days)
      const today = new Date();
      const lastWeek = new Date();
      lastWeek.setDate(today.getDate() - 7);
      
      document.getElementById('dateFrom').value = lastWeek.toISOString().split('T')[0];
      document.getElementById('dateTo').value = today.toISOString().split('T')[0];
      
      // Initialize the app
      updateLoadButtonState();
    }

    // Initialize the application
    document.addEventListener('DOMContentLoaded', function() {
      // Set up auth button
      document.getElementById('authButton').addEventListener('click', function(e) {
        e.preventDefault();
        document.getElementById('authStatus').style.display = 'block';
        document.getElementById('authButton').style.display = 'none';
        
        // Simulate authentication
        setTimeout(() => {
          initializeApplication();
        }, 1000);
      });
    });
  </script>
</body>
</html>
