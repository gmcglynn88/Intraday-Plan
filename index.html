<!DOCTYPE html>
<html>
<head>
  <title>Intraday Weekly Plan with Planning Groups</title>
  <meta charset="UTF-8">
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    .container { margin-bottom: 20px; }
    table { width: 100%; border-collapse: collapse; margin-bottom: 20px; }
    th, td { border: 1px solid #ccc; padding: 8px; text-align: left; }
    th { background: #f0f0f0; }
    .tab {
      display: inline-block;
      padding: 10px;
      margin-right: 10px;
      background: #eee;
      cursor: pointer;
    }
    .tab.active {
      background: #ddd;
      font-weight: bold;
    }
    .tab-content {
      display: none;
    }
    .tab-content.active {
      display: block;
    }
    .no-data { color: #999; font-style: italic; }
    button {
      padding: 5px 10px;
      background: #4CAF50;
      color: white;
      border: none;
      border-radius: 3px;
      cursor: pointer;
    }
    button:hover {
      background: #45a049;
    }
    .summary-row {
      background-color: #f8f8f8;
      font-weight: bold;
      margin-bottom: 10px;
      padding: 8px;
      border: 1px solid #ccc;
    }
    .summary-table {
      width: 100%;
      border-collapse: collapse;
    }
    .summary-table td {
      padding: 8px;
      border: none;
    }
    .time-toggle {
      margin-left: 10px;
      font-size: 0.9em;
      color: #666;
      cursor: pointer;
      text-decoration: underline;
    }
    .settings-panel {
      background: #f5f5f5;
      padding: 10px;
      margin-bottom: 15px;
      border: 1px solid #ddd;
      border-radius: 4px;
    }
    .settings-panel label {
      margin-right: 15px;
    }
    .settings-panel select {
      margin-right: 20px;
    }
  </style>
</head>
<body>
  <h1>Intraday Weekly Plan</h1>

  <!-- Settings Panel -->
  <div class="settings-panel">
    <label>
      Time Format:
      <select id="timeFormatSelect">
        <option value="seconds">Seconds</option>
        <option value="hms">hh:mm:ss</option>
      </select>
    </label>
    <label>
      Number Precision:
      <select id="precisionSelect">
        <option value="0">0</option>
        <option value="1">1</option>
        <option value="2">2</option>
      </select>
    </label>
    <button onclick="applySettings()">Apply Settings</button>
  </div>

  <!-- Business Unit Dropdown -->
  <div class="container">
    <label for="businessUnitSelect">Select Business Unit:</label>
    <select id="businessUnitSelect">
      <option value="">--Select Business Unit--</option>
      <!-- Populated via API -->
    </select>
  </div>

  <!-- Planning Group Dropdown (Populated based on Business Unit) -->
  <div class="container">
    <label for="planningGroup">Select Planning Group:</label>
    <select id="planningGroup">
      <option value="">--Select Planning Group--</option>
      <!-- Populated via planning groups API -->
    </select>
  </div>

  <!-- Week Selection Dropdown -->
  <div class="container">
    <label for="weekSelect">Select Week:</label>
    <select id="weekSelect">
      <!-- Dynamically populated until end of 2026 -->
    </select>
  </div>

  <!-- Media Type Dropdown (Static options) -->
  <div class="container">
    <label for="mediaType">Media Type:</label>
    <select id="mediaType">
      <option value="">--All--</option>
      <option value="Voice">Voice</option>
      <option value="Message">Message</option>
    </select>
  </div>

  <!-- Tab Navigation for Data Display -->
  <div class="container">
    <div id="tabs">
      <div id="dailyTabButton" class="tab active">Daily Data</div>
      <div id="intervalTabButton" class="tab">15-min Intervals</div>
    </div>
    <div id="dailyTab" class="tab-content active">
      <h2>Daily Data</h2>
      <div id="weeklySummary"></div>
      <div id="dailyTableContainer">
        <!-- Daily summary table renders here -->
      </div>
    </div>
    <div id="intervalTab" class="tab-content">
      <h2>15-min Interval Data</h2>
      <div id="intervalTableContainer">
        <!-- 15-min interval table renders here -->
      </div>
    </div>
  </div>

  <script>
    /***** Configuration *****/
    const config = {
      timeFormat: 'seconds', // 'seconds' or 'hms'
      precision: 1,          // decimal places
      CLIENT_ID: '256876c6-470d-4304-8e7d-2038f8a55d95',
      CLIENT_SECRET: 'tAdek1cTnnMmygxe-ma3_w_pNMSQkFZf-FQGXVeoVhg',
      REGION: 'mypurecloud.ie',
      REDIRECT_URI: 'https://gmcglynn88.github.io/Intraday-Plan/'
    };

    let accessToken = '';
    let planningGroupName = '';
    let weekData = [];

    /***** Initialization *****/
    function init() {
      const params = parseHashParams();
      if (params.access_token) {
        accessToken = params.access_token;
        window.history.replaceState({}, document.title, window.location.pathname);
        loadSettings();
        fetchBusinessUnits();
        populateWeekSelect();
      } else {
        window.location.href = `https://login.${config.REGION}/oauth/authorize?client_id=${config.CLIENT_ID}&response_type=token&redirect_uri=${encodeURIComponent(config.REDIRECT_URI)}`;
      }
    }

    function loadSettings() {
      const savedSettings = localStorage.getItem('intradaySettings');
      if (savedSettings) {
        Object.assign(config, JSON.parse(savedSettings));
      }
      document.getElementById('timeFormatSelect').value = config.timeFormat;
      document.getElementById('precisionSelect').value = config.precision.toString();
    }

    function saveSettings() {
      localStorage.setItem('intradaySettings', JSON.stringify({
        timeFormat: config.timeFormat,
        precision: config.precision
      }));
    }

    function applySettings() {
      config.timeFormat = document.getElementById('timeFormatSelect').value;
      config.precision = parseInt(document.getElementById('precisionSelect').value);
      saveSettings();
      renderAllData();
    }

    /***** Helper Functions *****/
    function parseHashParams() {
      const hash = window.location.hash.substring(1);
      const params = {};
      hash.split("&").forEach(part => {
        const item = part.split("=");
        params[item[0]] = decodeURIComponent(item[1]);
      });
      return params;
    }

    function formatTime(seconds) {
      if (config.timeFormat === 'hms') {
        return secondsToHMS(seconds);
      }
      return seconds === 0 ? '0s' : seconds.toFixed(0) + 's';
    }

    function formatHours(seconds) {
      if (config.timeFormat === 'hms') {
        return secondsToHMS(seconds);
      }
      return (seconds / 3600).toFixed(config.precision) + 'h';
    }

    function formatNumber(num) {
      return num.toFixed(config.precision);
    }

    function secondsToHMS(seconds) {
      if (!seconds) return '0:00';
      const h = Math.floor(seconds / 3600);
      const m = Math.floor((seconds % 3600) / 60);
      const s = Math.floor(seconds % 60);
      return h > 0 ? `${h}:${m.toString().padStart(2, '0')}:${s.toString().padStart(2, '0')}` 
                   : `${m}:${s.toString().padStart(2, '0')}`;
    }

    function getDayOfWeek(dateStr) {
      const date = new Date(dateStr);
      return date.toLocaleDateString('en-US', { weekday: 'long' });
    }

    function getUKFormattedDate(date) {
      const day = date.getDate();
      const month = date.getMonth() + 1;
      const year = date.getFullYear();
      return (day < 10 ? '0' + day : day) + '/' +
             (month < 10 ? '0' + month : month) + '/' +
             year;
    }

    function getWeekDates(startDate) {
      const dates = [];
      const start = new Date(startDate);
      for (let i = 0; i < 7; i++) {
        const currentDate = new Date(start);
        currentDate.setDate(start.getDate() + i);
        const raw = currentDate.toISOString().split('T')[0];
        const uk = getUKFormattedDate(currentDate);
        dates.push({ raw, uk });
      }
      return dates;
    }

    /***** Data Fetching Functions *****/
    async function fetchBusinessUnits() {
      try {
        const response = await fetch(`https://api.${config.REGION}/api/v2/workforcemanagement/businessunits`, {
          headers: {
            'Content-Type': 'application/json',
            'Authorization': 'Bearer ' + accessToken
          }
        });
        if (!response.ok) throw new Error('Error fetching business units: ' + response.statusText);
        const result = await response.json();
        const businessUnits = result.entities;
        const select = document.getElementById('businessUnitSelect');
        businessUnits.forEach(unit => {
          const option = document.createElement('option');
          option.value = unit.id;
          option.textContent = unit.name;
          select.appendChild(option);
        });
      } catch (error) {
        console.error(error);
        alert('Failed to load business units. Please refresh and try again.');
      }
    }

    async function fetchPlanningGroups() {
      const businessUnitId = document.getElementById('businessUnitSelect').value;
      const planningGroupSelect = document.getElementById('planningGroup');
      planningGroupSelect.innerHTML = '<option value="">--Select Planning Group--</option>';
      if (!businessUnitId) return;
      try {
        const url = `https://api.${config.REGION}/api/v2/workforcemanagement/businessunits/${businessUnitId}/planninggroups`;
        const response = await fetch(url, {
          headers: {
            'Content-Type': 'application/json',
            'Authorization': 'Bearer ' + accessToken
          }
        });
        if (!response.ok) throw new Error('Error fetching planning groups: ' + response.statusText);
        const result = await response.json();
        const planningGroups = result.entities;
        planningGroups.forEach(group => {
          const option = document.createElement('option');
          option.value = group.id;
          option.textContent = group.name;
          planningGroupSelect.appendChild(option);
        });
      } catch (error) {
        console.error(error);
      }
    }

    async function fetchIntradayData(date) {
      const businessUnitId = document.getElementById('businessUnitSelect').value;
      if (!businessUnitId) {
        return { date: date, data: null };
      }
      
      let planningGroupId = document.getElementById('planningGroup').value;
      planningGroupName = document.getElementById('planningGroup').options[document.getElementById('planningGroup').selectedIndex].text;
      if (planningGroupId === "") {
        planningGroupId = null;
        planningGroupName = "All Groups";
      }
      
      const url = `https://api.${config.REGION}/api/v2/workforcemanagement/businessunits/${businessUnitId}/intraday`;
      try {
        const response = await fetch(url, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': 'Bearer ' + accessToken
          },
          body: JSON.stringify({
            businessUnitDate: date,
            categories: [
              "ForecastData",
              "PerformancePredictionData",
              "ScheduleData"
            ],
            intervalLengthMinutes: 15,
            planningGroupIds: planningGroupId ? [planningGroupId] : null
          })
        });
        if (!response.ok) {
          if (response.status === 404) {
            return { date: date, data: null, error: 'No data available for this date' };
          }
          throw new Error(`Error fetching data for ${date}: ${response.statusText}`);
        }
        const data = await response.json();
        return { date: date, data: data };
      } catch (error) {
        console.error('API Error:', error);
        return { date: date, data: null, error: error.message };
      }
    }

    async function fetchDataForWeek(startDate) {
      const dateObjs = getWeekDates(startDate);
      const fetchPromises = dateObjs.map(dateObj =>
        fetchIntradayData(dateObj.raw).then(result => ({ ...result, uk: dateObj.uk }))
      );
      weekData = await Promise.all(fetchPromises);
      renderAllData();
    }

    /***** Rendering Functions *****/
    function renderAllData() {
      renderDailyTable();
      
      // If interval tab is active, re-render it with current data
      if (document.getElementById('intervalTab').classList.contains('active')) {
        const intervalTitle = document.querySelector('#intervalTableContainer h3');
        if (intervalTitle) {
          const match = intervalTitle.textContent.match(/for (\d{2}\/\d{2}\/\d{4}) \((Voice|Message)\)/);
          if (match) {
            const date = match[1];
            const mediaType = match[2];
            const day = weekData.find(d => d.uk === date);
            if (day) {
              render15MinTable(day, mediaType);
            }
          }
        }
      }
    }

    function renderDailyTable() {
      const mediaTypeFilter = document.getElementById('mediaType').value;
      let tableHTML = '<table><thead><tr><th>Date</th><th>Day</th><th>Planning Group</th><th>Media Type</th><th>Forecast Offered</th><th>Forecast AHT</th><th>Scheduled Time</th><th>Service Level</th><th>ASA</th><th>Occupancy</th><th>Action</th></tr></thead><tbody>';

      // Calculate weekly totals
      const weeklyTotals = {
        offered: 0,
        aht: 0,
        scheduledTime: 0,
        serviceLevel: 0,
        asa: 0,
        occupancy: 0,
        count: 0
      };

      weekData.forEach(day => {
        if (!day.data || !day.data.result) {
          tableHTML += `<tr>
            <td>${day.uk}</td>
            <td>${getDayOfWeek(day.raw)}</td>
            <td colspan="9" class="no-data">${day.error || 'No data available'}</td>
          </tr>`;
          return;
        }

        day.data.result.intradayDataGroupings.forEach(group => {
          if (mediaTypeFilter && group.mediaType !== mediaTypeFilter) return;

          // Calculate values
          const offered = group.forecastDataSummary?.offered || 0;
          const aht = group.forecastDataSummary?.averageHandleTimeSeconds || 0;
          const scheduledTime = group.scheduleDataSummary?.onQueueTimeSeconds || 0;
          const serviceLevel = group.performancePredictionDataSummary?.serviceLevelPercent || 0;
          const asa = group.performancePredictionDataSummary?.averageSpeedOfAnswerSeconds || 0;
          const occupancy = group.performancePredictionDataSummary?.occupancyPercent || 0;

          // Update weekly totals
          weeklyTotals.offered += offered;
          weeklyTotals.aht += aht;
          weeklyTotals.scheduledTime += scheduledTime;
          weeklyTotals.serviceLevel += serviceLevel;
          weeklyTotals.asa += asa;
          weeklyTotals.occupancy += occupancy;
          weeklyTotals.count++;

          tableHTML += '<tr>';
          tableHTML += `<td>${day.uk}</td>`;
          tableHTML += `<td>${getDayOfWeek(day.raw)}</td>`;
          tableHTML += `<td>${planningGroupName}</td>`;
          tableHTML += `<td>${group.mediaType}</td>`;
          tableHTML += `<td>${Math.round(offered)}</td>`;
          tableHTML += `<td>${formatTime(aht)}</td>`;
          tableHTML += `<td>${formatHours(scheduledTime)}</td>`;
          tableHTML += `<td>${formatNumber(serviceLevel)}%</td>`;
          tableHTML += `<td>${formatTime(asa)}</td>`;
          tableHTML += `<td>${formatNumber(occupancy)}%</td>`;
          tableHTML += `<td><button onclick='show15MinDetails(${JSON.stringify(day).replace(/'/g, "&apos;")}, "${group.mediaType}")'>View Details</button></td>`;
          tableHTML += '</tr>';
        });
      });

      // Create weekly summary
      const weeklyAvgAHT = weeklyTotals.count > 0 ? weeklyTotals.aht / weeklyTotals.count : 0;
      const weeklyAvgSL = weeklyTotals.count > 0 ? weeklyTotals.serviceLevel / weeklyTotals.count : 0;
      const weeklyAvgASA = weeklyTotals.count > 0 ? weeklyTotals.asa / weeklyTotals.count : 0;
      const weeklyAvgOccupancy = weeklyTotals.count > 0 ? weeklyTotals.occupancy / weeklyTotals.count : 0;

      const summaryHTML = `
        <table class="summary-table">
          <tr>
            <td><strong>Weekly Totals/Averages:</strong></td>
            <td>Forecast Offered: ${Math.round(weeklyTotals.offered)}</td>
            <td>Avg AHT: ${formatTime(weeklyAvgAHT)}</td>
            <td>Total Scheduled: ${formatHours(weeklyTotals.scheduledTime)}</td>
            <td>Avg SL: ${formatNumber(weeklyAvgSL)}%</td>
            <td>Avg ASA: ${formatTime(weeklyAvgASA)}</td>
            <td>Avg Occupancy: ${formatNumber(weeklyAvgOccupancy)}%</td>
          </tr>
        </table>
      `;
      document.getElementById('weeklySummary').innerHTML = summaryHTML;

      tableHTML += '</tbody></table>';
      document.getElementById('dailyTableContainer').innerHTML = tableHTML;
    }

    function render15MinTable(day, mediaType) {
      let tableHTML = `<h3>15-min Intervals for ${day.uk} (${mediaType})</h3>`;
      tableHTML += '<table><thead><tr><th>Time</th><th>Forecast Offered</th><th>Forecast AHT</th><th>Scheduled Time</th><th>Service Level</th><th>ASA</th><th>Occupancy</th></tr></thead><tbody>';
      
      if (day.data && day.data.result && day.data.result.intradayDataGroupings) {
        const grouping = day.data.result.intradayDataGroupings.find(g => g.mediaType === mediaType);
        if (!grouping) {
          tableHTML += '<tr><td colspan="7" class="no-data">No data for selected media type</td></tr>';
        } else {
          const startDate = new Date(day.data.result.startDate);
          let hasDataStarted = false;
          
          for (let i = 0; i < 96; i++) {
            const intervalTime = new Date(startDate);
            intervalTime.setMinutes(intervalTime.getMinutes() + i * 15);
            const timeStr = intervalTime.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
            
            // Check if we have data for this interval
            const hasForecastData = grouping.forecastDataPerInterval && grouping.forecastDataPerInterval[i];
            const hasScheduleData = grouping.scheduleDataPerInterval && grouping.scheduleDataPerInterval[i];
            const hasPerformanceData = grouping.performancePredictionDataPerInterval && grouping.performancePredictionDataPerInterval[i];
            
            // Skip intervals before first data point
            if (!hasDataStarted && !hasForecastData && !hasScheduleData && !hasPerformanceData) {
              continue;
            }
            hasDataStarted = true;
            
            tableHTML += '<tr>';
            tableHTML += `<td>${timeStr}</td>`;
            
            // Forecast Data
            if (hasForecastData) {
              const f = grouping.forecastDataPerInterval[i];
              tableHTML += `<td>${Math.round(f.offered || 0)}</td>`;
              tableHTML += `<td>${formatTime(f.averageHandleTimeSeconds || 0)}</td>`;
            } else {
              tableHTML += '<td>0</td><td>0</td>';
            }
            
            // Schedule Data
            if (hasScheduleData) {
              const s = grouping.scheduleDataPerInterval[i];
              tableHTML += `<td>${formatHours(s.onQueueTimeSeconds || 0)}</td>`;
            } else {
              tableHTML += '<td>0</td>';
            }
            
            // Performance Data
            if (hasPerformanceData) {
              const p = grouping.performancePredictionDataPerInterval[i];
              tableHTML += `<td>${p.serviceLevelPercent ? formatNumber(p.serviceLevelPercent) + '%' : '0%'}</td>`;
              tableHTML += `<td>${formatTime(p.averageSpeedOfAnswerSeconds || 0)}</td>`;
              tableHTML += `<td>${p.occupancyPercent ? formatNumber(p.occupancyPercent) + '%' : '0%'}</td>`;
            } else {
              tableHTML += '<td>0%</td><td>0</td><td>0%</td>';
            }
            
            tableHTML += '</tr>';
          }
        }
      } else {
        tableHTML += '<tr><td colspan="7" class="no-data">No data available</td></tr>';
      }
      
      tableHTML += '</tbody></table>';
      document.getElementById('intervalTableContainer').innerHTML = tableHTML;
    }

    /***** Event Handlers *****/
    function setActiveTab(tabName) {
      if (tabName === 'daily') {
        document.getElementById('dailyTab').classList.add('active');
        document.getElementById('intervalTab').classList.remove('active');
        document.getElementById('dailyTabButton').classList.add('active');
        document.getElementById('intervalTabButton').classList.remove('active');
      } else if (tabName === 'interval') {
        document.getElementById('dailyTab').classList.remove('active');
        document.getElementById('intervalTab').classList.add('active');
        document.getElementById('dailyTabButton').classList.remove('active');
        document.getElementById('intervalTabButton').classList.add('active');
      }
    }

    function show15MinDetails(day, mediaType) {
      setActiveTab('interval');
      render15MinTable(day, mediaType);
    }

    /***** Event Listeners *****/
    document.getElementById('weekSelect').addEventListener('change', function(event) {
      const startDate = event.target.value;
      if (startDate) {
        fetchDataForWeek(startDate);
      }
    });

    document.getElementById('mediaType').addEventListener('change', renderDailyTable);

    document.getElementById('businessUnitSelect').addEventListener('change', function() {
      fetchPlanningGroups();
      const weekSelect = document.getElementById('weekSelect');
      if (weekSelect.value) {
        fetchDataForWeek(weekSelect.value);
      }
    });

    document.getElementById('planningGroup').addEventListener('change', function() {
      planningGroupName = this.options[this.selectedIndex].text;
      const weekSelect = document.getElementById('weekSelect');
      if (weekSelect.value) {
        fetchDataForWeek(weekSelect.value);
      }
    });

    document.getElementById('dailyTabButton').addEventListener('click', function() {
      setActiveTab('daily');
    });

    document.getElementById('intervalTabButton').addEventListener('click', function() {
      setActiveTab('interval');
    });

    // Initialize the application
    window.addEventListener('load', init);
  </script>
</body>
</html>
