<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Intraday Weekly Plan</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <style>
    :root{
      --primary-color:#63AB8F; --secondary-color:#4A8C7D; --border-color:#DEE2E6;
      --light-bg:#F8F9FA; --card-bg:#FFFFFF; --text-color:#2C3E50; --text-light:#6C757D;
      --pill:#e9f6f0;
    }
    body{
      font-family:'Aptos','Segoe UI',system-ui,-apple-system,Arial,sans-serif;
      margin:20px;padding:20px;max-width:1400px;background:var(--light-bg);color:var(--text-color)
    }
    #logo-container{text-align:center;margin-bottom:20px} #logo{width:300px}
    h1{margin:0 0 16px}
    .card{background:var(--card-bg);border:1px solid var(--border-color);border-radius:12px;padding:24px;margin-top:16px;box-shadow:0 1px 3px rgba(0,0,0,.08)}
    label{display:block;font-weight:600;margin-bottom:6px}
    input,select,button,textarea{padding:10px;border:1px solid var(--border-color);border-radius:6px;background:#fff;font-size:14px}
    button{background:var(--primary-color);color:#fff;font-weight:600;cursor:pointer;transition:background .2s}
    button:hover{background:var(--secondary-color)} button:disabled{background:var(--text-light);cursor:not-allowed}
    .controls{display:grid;grid-template-columns:repeat(auto-fit,minmax(260px,1fr));gap:16px;align-items:end}
    .full-width-btn{width:100%;padding:14px 18px;font-size:16px;margin-top:12px}
    .muted{color:var(--text-light);font-size:12px}
    .section-title{margin:0 0 10px;color:var(--secondary-color)}

    #messageContainer{display:none;margin-top:12px}
    .error-message{color:#b4231a;background:#fee2e2;border:1px solid #fecaca;padding:10px;border-radius:6px}
    .success-message{color:#14532d;background:#dcfce7;border:1px solid #bbf7d0;padding:10px;border-radius:6px}
    .info-message{color:#6b4e16;background:#fff7ed;border:1px solid #ffedd5;padding:10px;border-radius:6px}

    /* Table Styling */
    table { width: 100%; border-collapse: collapse; margin-top: 20px; border: 1px solid var(--border-color); border-radius: 6px; overflow: hidden; }
    th, td { padding: 12px 15px; text-align: left; border-bottom: 1px solid var(--border-color); }
    th { background-color: var(--primary-color); color: white; font-weight: 600; }
    tr:hover { background-color: rgba(99, 171, 143, 0.05); }
    
    /* Consolidated table specific styles */
    .consolidated-table th.group-header { background-color: var(--secondary-color); text-align: center; }
    .consolidated-table th.sub-header { background-color: rgba(99, 171, 143, 0.8); }
    .weekly-totals-row { background-color: rgba(99, 171, 143, 0.1); font-weight: 600; }
    .weekly-totals-row td { border-bottom: 2px solid var(--primary-color); }
    .future-date { background-color: rgba(248, 249, 250, 0.5); }
    .past-date { opacity: 0.7; }

    /* Tab Styling */
    .tab { display: inline-block; padding: 12px 20px; margin-right: 10px; background: #eee; cursor: pointer; border-radius: 6px; font-weight: 500; }
    .tab.active { background: var(--primary-color); color: white; font-weight: 600; }
    .tab-content { display: none; }
    .tab-content.active { display: block; }

    .no-data { color: var(--text-light); font-style: italic; text-align: center; padding: 20px; }
    .loading { color: var(--text-light); font-style: italic; text-align: center; padding: 20px; }

    .table-container { overflow-x: auto; margin-top: 20px; border: 1px solid var(--border-color); border-radius: 6px; padding: 1px; }
    .summary-table { width: 100%; border-collapse: collapse; margin-bottom: 20px; }

    select { width: 100%; max-width: 400px; }

    pre.debug { background:#f6f8fa; border:1px solid var(--border-color); padding:12px; border-radius:8px; overflow:auto; }
    
    .status-complete { color: green; font-size: 11px; }
    .status-forecast-only { color: orange; font-size: 11px; }
    .status-warning { color: red; font-size: 11px; }
    
    .load-btn-container { grid-column: 1 / -1; text-align: center; margin-top: 10px; }
    
    /* Calendar Styles */
    .calendar-container { position: relative; }
    .calendar-input { cursor: pointer; }
    .calendar-popup { 
      position: absolute; 
      top: 100%; 
      left: 0; 
      background: white; 
      border: 1px solid var(--border-color); 
      border-radius: 6px; 
      padding: 15px; 
      z-index: 1000; 
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
      min-width: 300px;
      display: none;
    }
    .calendar-popup.active { display: block; }
    .calendar-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
    .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 5px; }
    .calendar-day { padding: 8px; text-align: center; cursor: pointer; border-radius: 4px; }
    .calendar-day:hover { background: var(--light-bg); }
    .calendar-day.selected { background: var(--primary-color); color: white; }
    .calendar-day.other-month { color: var(--text-light); }
    .calendar-day.week-start { border: 2px solid var(--primary-color); }
    
    /* Metric Tables */
    .metrics-section { margin-bottom: 30px; }
    .metrics-section h3 { color: var(--secondary-color); margin-bottom: 15px; border-bottom: 2px solid var(--primary-color); padding-bottom: 5px; }

    /* Weekly/Monthly View Styles */
    .view-controls { display: flex; gap: 10px; margin-bottom: 15px; align-items: center; }
    .view-controls button { padding: 8px 15px; }
    .planning-group-header { background-color: #e6f2ff; font-weight: bold; text-align: left; }
    .media-type-header { background-color: #f0f8ff; text-align: left; }
    .data-row:nth-child(even) { background-color: #f9f9f9; }
  </style>
</head>
<body>
  <div id="logo-container">
    <img id="logo" src="https://raw.githubusercontent.com/gmcglynn88/Management-Unit-Search/main/Consultinglogo%20(2).png" alt="Company Logo">
  </div>

  <h1>Intraday Weekly Plan - Forecast & Predictions</h1>

  <div id="authCard" class="card">
    <div id="auth-message" class="info-message">Authenticating with PureCloud...</div>
  </div>

  <!-- Debug (shows only when ?debug=1 is in the URL) -->
  <div id="authDebug" class="card" style="display:none">
    <h2 class="section-title">Auth debug</h2>
    <p class="muted">This block appears when you add <code>?debug=1</code> to the page URL.</p>
    <pre id="authDump" class="debug"></pre>
    <button id="signinBtn">Sign in with Genesys</button>
  </div>

  <div id="appContent" style="display:none;">
    <div id="messageContainer"></div>

    <div class="card">
      <h2 class="section-title">Configuration</h2>
      <div class="controls">
        <div>
          <label for="businessUnitSelect">Select Business Unit:</label>
          <select id="businessUnitSelect" disabled>
            <option value="">-- Loading Business Units --</option>
          </select>
        </div>
        <div>
          <label for="planningGroup">Select Planning Group:</label>
          <select id="planningGroup" disabled>
            <option value="">-- Select Business Unit First --</option>
          </select>
        </div>
        <div class="calendar-container">
          <label for="weekSelect">Select Week:</label>
          <input type="text" id="weekSelect" class="calendar-input" placeholder="Click to select week" readonly>
          <div id="calendarPopup" class="calendar-popup">
            <div class="calendar-header">
              <button id="prevMonth">&lt;</button>
              <h4 id="currentMonth">Month Year</h4>
              <button id="nextMonth">&gt;</button>
            </div>
            <div class="calendar-grid" id="calendarGrid">
              <!-- Calendar days will be populated here -->
            </div>
          </div>
        </div>
        <div>
          <label for="mediaType">Media Type:</label>
          <select id="mediaType">
            <option value="">--All--</option>
            <option value="Voice">Voice</option>
            <option value="Message">Message</option>
          </select>
        </div>
        <div class="load-btn-container">
          <button id="loadDataBtn" class="full-width-btn" disabled>
            Load Forecast Data
          </button>
        </div>
      </div>
    </div>

    <!-- Tab Navigation -->
    <div class="card">
      <div style="margin-bottom: 20px;">
        <div id="tabs">
          <div id="dailyTabButton" class="tab active">Daily Forecast</div>
          <div id="intervalTabButton" class="tab">15-min Intervals</div>
          <div id="weeklyViewTabButton" class="tab">Weekly View</div>
          <div id="monthlyViewTabButton" class="tab">Monthly View</div>
        </div>
      </div>
      
      <div id="dailyTab" class="tab-content active">
        <h2 class="section-title">Daily Forecast Data</h2>
        <div id="weeklySummary" class="loading">Select a week and click "Load Forecast Data" to view forecast and predictions</div>
        
        <!-- Consolidated Data Table -->
        <div class="metrics-section" id="consolidatedSection" style="display: none;">
          <h3>📊 Weekly Forecast & Performance Predictions</h3>
          <div id="consolidatedTableContainer"></div>
        </div>
      </div>
      
      <div id="intervalTab" class="tab-content">
        <h2 class="section-title">15-min Interval Data</h2>
        <div id="intervalTableContainer" class="loading">Select a day to view interval forecast data</div>
      </div>

      <!-- Weekly View Tab -->
      <div id="weeklyViewTab" class="tab-content">
        <h2 class="section-title">Weekly Forecast View</h2>
        <div class="view-controls">
          <button id="prevWeekBtn">Previous Week</button>
          <span id="weekRangeDisplay"></span>
          <button id="nextWeekBtn">Next Week</button>
        </div>
        <div id="weeklyViewContainer" class="loading">Load forecast data to view weekly summary</div>
      </div>

      <!-- Monthly View Tab -->
      <div id="monthlyViewTab" class="tab-content">
        <h2 class="section-title">Monthly Forecast View</h2>
        <div class="view-controls">
          <button id="prevMonthBtn">Previous Month</button>
          <span id="monthRangeDisplay"></span>
          <button id="nextMonthBtn">Next Month</button>
        </div>
        <div id="monthlyViewContainer" class="loading">Load forecast data to view monthly summary</div>
      </div>
    </div>
  </div>

  <script>
    // ===== OAuth Config =====
    const clientId = 'fe305808-b368-4547-8af9-325d28d552bb';

    // Region centralised here (EU-IE)
    const config = {
      timeFormat: 'seconds',
      precision: 1,
      REGION: 'mypurecloud.ie'
    };

    // Compute the redirect from the current page (guarantees trailing slash)
    const redirectUri = new URL('.', window.location.href).href;

    // Build the OAuth URL using the configured region
    const oauthUrl =
      `https://login.${config.REGION}/oauth/authorize` +
      `?client_id=${encodeURIComponent(clientId)}` +
      `&response_type=token` +
      `&redirect_uri=${encodeURIComponent(redirectUri)}` +
      `&state=intraday`;

    // Optional debug mode with ?debug=1
    const DEBUG = new URLSearchParams(window.location.search).has('debug');

    // State management
    const state = {
      accessToken: null,
      planningGroupName: '',
      weekData: [],
      selectedWeekStart: null,
      calendarDate: new Date(),
      // Weekly/Monthly view state
      currentWeekStart: getMonday(new Date()),
      currentMonthStart: new Date(new Date().getFullYear(), new Date().getMonth(), 1),
      dayRegistry: [] // for View Intervals button mapping
    };

    // ===== Calendar Functions =====
    function initCalendar() {
      const calendarInput = document.getElementById('weekSelect');
      const calendarPopup = document.getElementById('calendarPopup');
      const prevMonthBtn = document.getElementById('prevMonth');
      const nextMonthBtn = document.getElementById('nextMonth');
      
      calendarInput.addEventListener('click', () => {
        calendarPopup.classList.toggle('active');
        renderCalendar();
      });
      
      prevMonthBtn.addEventListener('click', () => {
        state.calendarDate.setMonth(state.calendarDate.getMonth() - 1);
        renderCalendar();
      });
      
      nextMonthBtn.addEventListener('click', () => {
        state.calendarDate.setMonth(state.calendarDate.getMonth() + 1);
        renderCalendar();
      });
      
      // Close calendar when clicking outside
      document.addEventListener('click', (e) => {
        if (!calendarInput.contains(e.target) && !calendarPopup.contains(e.target)) {
          calendarPopup.classList.remove('active');
        }
      });
    }
    
    function renderCalendar() {
      const currentMonthEl = document.getElementById('currentMonth');
      const calendarGrid = document.getElementById('calendarGrid');
      
      const year = state.calendarDate.getFullYear();
      const month = state.calendarDate.getMonth();
      
      currentMonthEl.textContent = state.calendarDate.toLocaleDateString('en-GB', { 
        month: 'long', 
        year: 'numeric' 
      });
      
      // Get first day of month and last day of month
      const firstDay = new Date(year, month, 1);
      const lastDay = new Date(year, month + 1, 0);
      
      // Get the Monday of the week containing the first day
      const startDate = new Date(firstDay);
      startDate.setDate(firstDay.getDate() - firstDay.getDay() + (firstDay.getDay() === 0 ? -6 : 1));
      
      // Get the Sunday of the week containing the last day
      const endDate = new Date(lastDay);
      endDate.setDate(lastDay.getDate() + (7 - lastDay.getDay()) % 7);
      
      calendarGrid.innerHTML = '';
      
      // Add day headers
      const days = ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'];
      days.forEach(day => {
        const dayHeader = document.createElement('div');
        dayHeader.textContent = day;
        dayHeader.style.fontWeight = 'bold';
        dayHeader.style.textAlign = 'center';
        calendarGrid.appendChild(dayHeader);
      });
      
      // Add calendar days
      const currentDate = new Date(startDate);
      while (currentDate <= endDate) {
        const dayEl = document.createElement('div');
        dayEl.className = 'calendar-day';
        dayEl.textContent = currentDate.getDate();
        
        if (currentDate.getMonth() !== month) {
          dayEl.classList.add('other-month');
        }
        
        // Highlight selected week
        if (state.selectedWeekStart) {
          const weekStart = new Date(state.selectedWeekStart);
          const weekEnd = new Date(weekStart);
          weekEnd.setDate(weekStart.getDate() + 6);
          
          if (currentDate >= weekStart && currentDate <= weekEnd) {
            dayEl.style.backgroundColor = 'rgba(99, 171, 143, 0.2)';
          }
          
          if (currentDate.getTime() === weekStart.getTime()) {
            dayEl.classList.add('week-start');
          }
        }
        
        dayEl.addEventListener('click', () => {
          selectWeek(currentDate);
        });
        
        calendarGrid.appendChild(dayEl);
        currentDate.setDate(currentDate.getDate() + 1);
      }
    }
    
    function selectWeek(date) {
      // Find the Monday of the selected week
      const selectedDate = new Date(date);
      const dayOfWeek = selectedDate.getDay();
      const diff = selectedDate.getDate() - dayOfWeek + (dayOfWeek === 0 ? -6 : 1);
      const monday = new Date(selectedDate.setDate(diff));
      
      state.selectedWeekStart = monday.toISOString().split('T')[0];
      state.currentWeekStart = new Date(monday); // Sync with weekly view
      
      const weekEnd = new Date(monday);
      weekEnd.setDate(monday.getDate() + 6);
      
      const weekStartStr = getUKFormattedDate(monday);
      const weekEndStr = getUKFormattedDate(weekEnd);
      
      document.getElementById('weekSelect').value = `Week ${weekStartStr} - ${weekEndStr}`;
      document.getElementById('calendarPopup').classList.remove('active');
      
      updateLoadButtonState();
    }

    // ===== Utility Functions =====
    function isoDate(d){
      const dt = new Date(d);
      // Avoid TZ rollovers: force local date to ISO yyyy-mm-dd
      dt.setHours(12,0,0,0);
      const off = new Date(dt.getTime() - dt.getTimezoneOffset()*60000);
      return off.toISOString().split('T')[0];
    }
    
    // Generic paginated fetch function
    async function fetchPaginatedData(url, options = {}) {
      let allEntities = [];
      let pageNumber = 1;
      let nextUrl = url;
      
      try {
        while (nextUrl) {
          const response = await fetch(nextUrl, {
            headers: {
              'Authorization': 'Bearer ' + state.accessToken,
              ...options.headers
            },
            ...options
          });
          
          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }
          
          const data = await response.json();
          
          // Handle different pagination structures
          if (data.entities) {
            allEntities = allEntities.concat(data.entities);
          } else if (data.results) {
            allEntities = allEntities.concat(data.results);
          } else {
            // If no clear entities array, return the data as-is
            return data;
          }
          
          // Check for next page
          if (data.nextUri) {
            nextUrl = `https://api.${config.REGION}${data.nextUri}`;
          } else if (data.cursor && data.cursor !== '') {
            // Some APIs use cursor-based pagination
            nextUrl = `${url}?cursor=${encodeURIComponent(data.cursor)}`;
          } else {
            nextUrl = null;
          }
          
          pageNumber++;
          
          if (DEBUG) {
            console.log(`Fetched page ${pageNumber - 1}, total records: ${allEntities.length}`);
          }
        }
        
        return allEntities;
      } catch (error) {
        console.error('Error in paginated fetch:', error);
        throw error;
      }
    }

    // Poller for async intraday results
    async function pollIntradayResult(businessUnitId, operationId, { maxAttempts = 12, delayMs = 750 } = {}) {
      for (let attempt = 1; attempt <= maxAttempts; attempt++) {
        const res = await fetch(
          `https://api.${config.REGION}/api/v2/workforcemanagement/businessunits/${businessUnitId}/intraday/${operationId}`,
          { headers: { 'Authorization': 'Bearer ' + state.accessToken } }
        );
        if (!res.ok) throw new Error(`Polling failed: ${res.status}`);
        const data = await res.json();
        if (DEBUG) console.log(`Poll ${attempt}:`, data.status);
        if (data.status === 'Complete' && data.result) return data;
        await new Promise(r => setTimeout(r, delayMs));
      }
      throw new Error('Intraday operation timed out waiting for Complete');
    }

    // ===== Auth bootstrap =====
    document.addEventListener('DOMContentLoaded', () => {
      console.log('OAuth Configuration:', { clientId, redirectUri, oauthUrl, region: config.REGION });

      // Parse OAuth fragment & possible errors
      const hash = window.location.hash.substring(1);
      const params = new URLSearchParams(hash);
      const qparams = new URLSearchParams(window.location.search);

      const oauthError = params.get('error') || qparams.get('error');
      const oauthErrorDesc = params.get('error_description') || qparams.get('error_description');

      if (oauthError) {
        document.getElementById('auth-message').textContent = `OAuth error: ${oauthErrorDesc || oauthError}`;
        document.getElementById('auth-message').className = 'error-message';
        console.error('OAuth error details:', { error: oauthError, description: oauthErrorDesc });

        // Troubleshooting info
        setTimeout(() => {
          document.getElementById('auth-message').innerHTML += `
            <br><br><strong>Troubleshooting Steps:</strong>
            <br>1. Admin → Integrations → OAuth (client ID ${clientId})
            <br>2. Grant type: Token Implicit Grant (Browser)
            <br>3. Add redirect URIs exactly as:
            <br>&nbsp;&nbsp;${redirectUri}
            <br>&nbsp;&nbsp;${redirectUri}index.html
            <br>4. Save and retry
          `;
        }, 600);

        // Show debug if requested
        if (DEBUG) {
          showDebugCard();
        }
        return;
      }

      const tokenFromHash = params.get('access_token');
      const tokenFromSession = sessionStorage.getItem('purecloud_token');

      if (tokenFromHash) {
        state.accessToken = tokenFromHash;
        sessionStorage.setItem('purecloud_token', state.accessToken);
        // Clean the URL fragment without reloading
        history.replaceState(null, '', window.location.href.split('#')[0]);
        initializeApplication();
      } else if (tokenFromSession) {
        state.accessToken = tokenFromSession;
        initializeApplication();
      } else {
        // No token yet
        if (DEBUG) {
          showDebugCard();
        } else {
          // Auto-redirect to login
          console.log('Initiating OAuth flow...');
          window.location.href = oauthUrl;
        }
      }
    });

    function showDebugCard() {
      const dump = { clientId, redirectUri, oauthUrl, region: config.REGION };
      document.getElementById('authDebug').style.display = 'block';
      document.getElementById('authDump').textContent = JSON.stringify(dump, null, 2);
      document.getElementById('signinBtn').onclick = () => location.href = oauthUrl;
      document.getElementById('auth-message').textContent = 'Debug mode: click "Sign in with Genesys".';
      document.getElementById('auth-message').className = 'info-message';
    }

    function showMessage(msg, type = 'error', details = '') {
      const box = document.getElementById('messageContainer');
      let messageHTML = `<div class="${type}-message">${msg}</div>`;
      
      if (details && DEBUG) {
        messageHTML += `<div class="info-message" style="margin-top: 8px;">
          <strong>Details:</strong><br>
          <pre style="font-size: 11px; overflow: auto;">${JSON.stringify(details, null, 2)}</pre>
        </div>`;
      }
      
      box.innerHTML = messageHTML;
      box.style.display = 'block';
      
      if (type === 'success') {
        setTimeout(() => box.style.display = 'none', 5000);
      }
    }

    function initializeApplication() {
      document.getElementById('auth-message').textContent = 'Authenticated successfully!';
      document.getElementById('auth-message').className = 'success-message';
      setTimeout(() => { 
        document.getElementById('authCard').style.display = 'none'; 
        document.getElementById('authDebug').style.display = 'none';
      }, 1200);

      document.getElementById('appContent').style.display = 'block';
      initializeApp();
    }

    function initializeApp() {
      // Set up event listeners
      document.getElementById('businessUnitSelect').addEventListener('change', onBusinessUnitChange);
      document.getElementById('planningGroup').addEventListener('change', onPlanningGroupChange);
      document.getElementById('mediaType').addEventListener('change', onConfigChange);
      document.getElementById('loadDataBtn').addEventListener('click', loadData);
      document.getElementById('dailyTabButton').addEventListener('click', () => setActiveTab('daily'));
      document.getElementById('intervalTabButton').addEventListener('click', () => setActiveTab('interval'));
      document.getElementById('weeklyViewTabButton').addEventListener('click', () => setActiveTab('weeklyView'));
      document.getElementById('monthlyViewTabButton').addEventListener('click', () => setActiveTab('monthlyView'));

      // Weekly/Monthly view navigation
      document.getElementById('prevWeekBtn').addEventListener('click', navigatePrevWeek);
      document.getElementById('nextWeekBtn').addEventListener('click', navigateNextWeek);
      document.getElementById('prevMonthBtn').addEventListener('click', navigatePrevMonth);
      document.getElementById('nextMonthBtn').addEventListener('click', navigateNextMonth);

      // Delegated click for interval buttons (safer than inline JSON)
      document.getElementById('consolidatedTableContainer').onclick = (e) => {
        const btn = e.target.closest('.view-intervals-btn');
        if (!btn) return;
        const idx = Number(btn.dataset.dayIndex);
        const entry = state.dayRegistry[idx];
        if (entry) { setActiveTab('interval'); render15MinTable(entry.day, entry.mediaType); }
      };

      // Initialize calendar
      initCalendar();
      
      // Load initial data
      fetchBusinessUnits();
      
      // Set default week to current week
      const today = new Date();
      const dayOfWeek = today.getDay();
      const diff = today.getDate() - dayOfWeek + (dayOfWeek === 0 ? -6 : 1);
      const monday = new Date(today.setDate(diff));
      selectWeek(monday);

      // Initialize weekly/monthly view displays
      updateWeeklyViewDisplay();
      updateMonthlyViewDisplay();
    }

    function onBusinessUnitChange() {
      const buId = this.value;
      const planningGroupSelect = document.getElementById('planningGroup');
      planningGroupSelect.innerHTML = '<option value="">-- Loading Planning Groups --</option>';
      planningGroupSelect.disabled = true;
      document.getElementById('loadDataBtn').disabled = true;
      
      if (buId) {
        fetchPlanningGroups(buId);
      } else {
        planningGroupSelect.innerHTML = '<option value="">-- Select Business Unit First --</option>';
        planningGroupSelect.disabled = true;
        document.getElementById('loadDataBtn').disabled = true;
      }
    }

    function onPlanningGroupChange() {
      state.planningGroupName = this.options[this.selectedIndex].text;
      updateLoadButtonState();
    }

    function onConfigChange() {
      // If we already have data, re-render with new filters
      if (state.weekData.length > 0) {
        renderAllData();
        updateWeeklyViewDisplay();
        updateMonthlyViewDisplay();
      }
    }

    function updateLoadButtonState() {
      const businessUnitId = document.getElementById('businessUnitSelect').value;
      const planningGroupId = document.getElementById('planningGroup').value;
      const weekSelected = state.selectedWeekStart;
      
      document.getElementById('loadDataBtn').disabled = !(businessUnitId && planningGroupId && weekSelected);
    }

    function loadData() {
      const weekStart = state.selectedWeekStart;
      if (weekStart) {
        document.getElementById('weeklySummary').className = 'loading';
        document.getElementById('weeklySummary').textContent = 'Loading forecast data...';
        document.getElementById('loadDataBtn').disabled = true;
        document.getElementById('loadDataBtn').textContent = 'Loading...';
        
        // Hide previous tables
        document.getElementById('consolidatedSection').style.display = 'none';
        
        fetchDataForWeek(weekStart).finally(() => {
          document.getElementById('loadDataBtn').disabled = false;
          document.getElementById('loadDataBtn').textContent = 'Load Forecast Data';
          // Update weekly/monthly views with new data
          updateWeeklyViewDisplay();
          updateMonthlyViewDisplay();
        });
      }
    }

    function setActiveTab(tabName) {
      document.getElementById('dailyTab').classList.toggle('active', tabName === 'daily');
      document.getElementById('intervalTab').classList.toggle('active', tabName === 'interval');
      document.getElementById('weeklyViewTab').classList.toggle('active', tabName === 'weeklyView');
      document.getElementById('monthlyViewTab').classList.toggle('active', tabName === 'monthlyView');
      
      document.getElementById('dailyTabButton').classList.toggle('active', tabName === 'daily');
      document.getElementById('intervalTabButton').classList.toggle('active', tabName === 'interval');
      document.getElementById('weeklyViewTabButton').classList.toggle('active', tabName === 'weeklyView');
      document.getElementById('monthlyViewTabButton').classList.toggle('active', tabName === 'monthlyView');
    }

    // Weekly/Monthly View Functions
    async function navigatePrevWeek() {
      state.currentWeekStart.setDate(state.currentWeekStart.getDate() - 7);
      await fetchDataForWeek(isoDate(state.currentWeekStart)); // fetch for displayed week
      updateWeeklyViewDisplay();
    }

    async function navigateNextWeek() {
      state.currentWeekStart.setDate(state.currentWeekStart.getDate() + 7);
      await fetchDataForWeek(isoDate(state.currentWeekStart)); // fetch for displayed week
      updateWeeklyViewDisplay();
    }

    async function navigatePrevMonth() {
      state.currentMonthStart.setMonth(state.currentMonthStart.getMonth() - 1);
      await fetchDataForMonth(state.currentMonthStart); // fetch all days in month
      updateMonthlyViewDisplay();
    }

    async function navigateNextMonth() {
      state.currentMonthStart.setMonth(state.currentMonthStart.getMonth() + 1);
      await fetchDataForMonth(state.currentMonthStart); // fetch all days in month
      updateMonthlyViewDisplay();
    }

    function updateWeeklyViewDisplay() {
      const weekEnd = new Date(state.currentWeekStart);
      weekEnd.setDate(state.currentWeekStart.getDate() + 6);
      
      document.getElementById('weekRangeDisplay').textContent = 
        `${getUKFormattedDate(state.currentWeekStart)} - ${getUKFormattedDate(weekEnd)}`;
      
      if (state.weekData.length > 0) {
        document.getElementById('weeklyViewContainer').innerHTML = generateWeeklyViewTable();
      } else {
        document.getElementById('weeklyViewContainer').innerHTML = '<div class="no-data">Load forecast data first to view weekly summary</div>';
      }
    }

    function updateMonthlyViewDisplay() {
      document.getElementById('monthRangeDisplay').textContent = 
        `${state.currentMonthStart.toLocaleString('en-GB', { month: 'long', year: 'numeric' })}`;
      
      if (state.weekData.length > 0) {
        document.getElementById('monthlyViewContainer').innerHTML = generateMonthlyViewTable();
      } else {
        document.getElementById('monthlyViewContainer').innerHTML = '<div class="no-data">Load forecast data first to view monthly summary</div>';
      }
    }

    function generateWeeklyViewTable() {
      if (!state.weekData || state.weekData.length === 0) {
        return '<div class="no-data">No forecast data available. Load data first.</div>';
      }

      const days = [];
      for (let i = 0; i < 7; i++) {
        const date = new Date(state.currentWeekStart);
        date.setDate(state.currentWeekStart.getDate() + i);
        days.push(getUKFormattedDate(date));
      }

      const mediaTypeFilter = document.getElementById('mediaType').value;
      
      let html = '';
      
      // Get all media types from the loaded data
      const allMediaTypes = getAllMediaTypesFromData();
      
      // If media type filter is set, only show that type
      const mediaTypesToShow = mediaTypeFilter ? [mediaTypeFilter] : allMediaTypes;

      if (mediaTypesToShow.length === 0) {
        return '<div class="no-data">No data available for selected filters</div>';
      }

      mediaTypesToShow.forEach(mediaType => {
        const planningGroupName = getPlanningGroupName(mediaType);
        const mediaTypeDisplay = mediaType;

        html += `
          <div class="table-container" style="margin-bottom: 30px;">
            <table>
              <tr class="planning-group-header">
                <td>Planning Group Name: ${planningGroupName}</td>
                <td colspan="${days.length}">Media Type: ${mediaTypeDisplay}</td>
              </tr>
              <tr>
                <th></th>
                ${days.map(day => `<th>${day}</th>`).join('')}
              </tr>
        `;

        // Offered
        html += `<tr class="data-row"><td>Offered</td>`;
        days.forEach(day => {
          const dayData = state.weekData.find(d => d.uk === day);
          const grouping = dayData?.data?.result?.intradayDataGroupings?.find(g => g.mediaType === mediaType);
          const offered = grouping?.forecastDataSummary?.offered ?? null;
          html += `<td>${Number.isFinite(offered) ? Math.round(offered) : '-'}</td>`;
        });
        html += `</tr>`;

        // AHT
        html += `<tr class="data-row"><td>Average Handle Time</td>`;
        days.forEach(day => {
          const dayData = state.weekData.find(d => d.uk === day);
          const grouping = dayData?.data?.result?.intradayDataGroupings?.find(g => g.mediaType === mediaType);
          const aht = grouping?.forecastDataSummary?.averageHandleTimeSeconds ?? null;
          html += `<td>${formatTime(aht)}</td>`;
        });
        html += `</tr>`;

        // SL
        html += `<tr class="data-row"><td>Service Level</td>`;
        days.forEach(day => {
          const dayData = state.weekData.find(d => d.uk === day);
          const grouping = dayData?.data?.result?.intradayDataGroupings?.find(g => g.mediaType === mediaType);
          const sl = grouping?.performancePredictionDataSummary?.serviceLevelPercent ?? null;
          html += `<td>${formatPercentage(sl)}</td>`;
        });
        html += `</tr>`;

        // ASA
        html += `<tr class="data-row"><td>Average Speed of Answer</td>`;
        days.forEach(day => {
          const dayData = state.weekData.find(d => d.uk === day);
          const grouping = dayData?.data?.result?.intradayDataGroupings?.find(g => g.mediaType === mediaType);
          const asa = grouping?.performancePredictionDataSummary?.averageSpeedOfAnswerSeconds ?? null;
          html += `<td>${formatTime(asa)}</td>`;
        });
        html += `</tr>`;

        html += `</table></div>`;
      });

      return html;
    }

    function generateMonthlyViewTable() {
      if (!state.weekData || state.weekData.length === 0) {
        return '<div class="no-data">No forecast data available. Load data first.</div>';
      }

      const daysInMonth = new Date(
        state.currentMonthStart.getFullYear(), 
        state.currentMonthStart.getMonth() + 1, 
        0
      ).getDate();
      
      const days = [];
      for (let i = 1; i <= daysInMonth; i++) {
        const date = new Date(state.currentMonthStart.getFullYear(), state.currentMonthStart.getMonth(), i);
        days.push(getUKFormattedDate(date));
      }

      const mediaTypeFilter = document.getElementById('mediaType').value;
      let html = '';
      
      const allMediaTypes = getAllMediaTypesFromData();
      const mediaTypesToShow = mediaTypeFilter ? [mediaTypeFilter] : allMediaTypes;

      if (mediaTypesToShow.length === 0) {
        return '<div class="no-data">No data available for selected filters</div>';
      }

      mediaTypesToShow.forEach(mediaType => {
        const planningGroupName = getPlanningGroupName(mediaType);
        const mediaTypeDisplay = mediaType;
        
        html += `
          <div class="table-container" style="margin-bottom: 30px; overflow-x: auto;">
            <table>
              <tr class="planning-group-header">
                <td>Planning Group Name: ${planningGroupName}</td>
                <td colspan="${days.length}">Media Type: ${mediaTypeDisplay}</td>
              </tr>
              <tr>
                <th></th>
                ${days.map(day => `<th>${day.split('/')[0]}</th>`).join('')}
              </tr>
        `;

        // Averages derived from loaded data
        const availableData = state.weekData.filter(day => {
          const grouping = day.data?.result?.intradayDataGroupings?.find(g => g.mediaType === mediaType);
          return grouping && grouping.forecastDataSummary;
        });

        const totalOffered = availableData.reduce((sum, day) => {
          const grouping = day.data.result.intradayDataGroupings.find(g => g.mediaType === mediaType);
          return sum + (grouping.forecastDataSummary?.offered || 0);
        }, 0);

        const totalAHT = availableData.reduce((sum, day) => {
          const grouping = day.data.result.intradayDataGroupings.find(g => g.mediaType === mediaType);
          return sum + (grouping.forecastDataSummary?.averageHandleTimeSeconds || 0);
        }, 0);

        const totalSL = availableData.reduce((sum, day) => {
          const grouping = day.data.result.intradayDataGroupings.find(g => g.mediaType === mediaType);
          return sum + (grouping.performancePredictionDataSummary?.serviceLevelPercent || 0);
        }, 0);

        const totalASA = availableData.reduce((sum, day) => {
          const grouping = day.data.result.intradayDataGroupings.find(g => g.mediaType === mediaType);
          return sum + (grouping.performancePredictionDataSummary?.averageSpeedOfAnswerSeconds || 0);
        }, 0);
        
        const avgOffered = availableData.length ? totalOffered / availableData.length : 0;
        const avgAHT = availableData.length ? totalAHT / availableData.length : 0;
        const avgSL = availableData.length ? totalSL / availableData.length : 0;
        const avgASA = availableData.length ? totalASA / availableData.length : 0;

        // Offered
        html += `<tr class="data-row"><td>Offered</td>`;
        days.forEach(day => {
          const dayData = state.weekData.find(d => d.uk === day);
          const grouping = dayData?.data?.result?.intradayDataGroupings?.find(g => g.mediaType === mediaType);
          const offered = grouping?.forecastDataSummary?.offered ?? avgOffered;
          html += `<td>${Math.round(offered)}</td>`;
        });
        html += `</tr>`;

        // AHT
        html += `<tr class="data-row"><td>Average Handle Time</td>`;
        days.forEach(day => {
          const dayData = state.weekData.find(d => d.uk === day);
          const grouping = dayData?.data?.result?.intradayDataGroupings?.find(g => g.mediaType === mediaType);
          const aht = grouping?.forecastDataSummary?.averageHandleTimeSeconds ?? avgAHT;
          html += `<td>${formatTime(aht)}</td>`;
        });
        html += `</tr>`;

        // SL
        html += `<tr class="data-row"><td>Service Level</td>`;
        days.forEach(day => {
          const dayData = state.weekData.find(d => d.uk === day);
          const grouping = dayData?.data?.result?.intradayDataGroupings?.find(g => g.mediaType === mediaType);
          const sl = grouping?.performancePredictionDataSummary?.serviceLevelPercent ?? avgSL;
          html += `<td>${formatPercentage(sl)}</td>`;
        });
        html += `</tr>`;

        // ASA
        html += `<tr class="data-row"><td>Average Speed of Answer</td>`;
        days.forEach(day => {
          const dayData = state.weekData.find(d => d.uk === day);
          const grouping = dayData?.data?.result?.intradayDataGroupings?.find(g => g.mediaType === mediaType);
          const asa = grouping?.performancePredictionDataSummary?.averageSpeedOfAnswerSeconds ?? avgASA;
          html += `<td>${formatTime(asa)}</td>`;
        });
        html += `</tr>`;

        html += `</table></div>`;
      });

      return html;
    }

    function getAllMediaTypesFromData() {
      const mediaTypes = new Set();
      state.weekData.forEach(day => {
        if (day.data?.result?.intradayDataGroupings) {
          day.data.result.intradayDataGroupings.forEach(group => {
            if (group.mediaType) {
              mediaTypes.add(group.mediaType);
            }
          });
        }
      });
      return Array.from(mediaTypes);
    }

    function refreshMediaTypeOptions() {
      const types = getAllMediaTypesFromData();
      const sel = document.getElementById('mediaType');
      const current = sel.value;
      sel.innerHTML = `<option value="">--All--</option>` + types.map(t => `<option value="${t}">${t}</option>`).join('');
      if (types.includes(current) || current === '') sel.value = current;
    }

    function getPlanningGroupName(mediaType) {
      // Placeholder mapping – adjust if you want something fancier
      return mediaType === 'Voice' ? 'Customer Service - Voice' : 'Customer Service - Digital';
    }

    // Helper functions
    function getMonday(date) {
      const d = new Date(date);
      const day = d.getDay();
      const diff = d.getDate() - day + (day === 0 ? -6 : 1);
      return new Date(d.setDate(diff));
    }

    function formatTime(seconds) {
      if (seconds === null || seconds === undefined) return '-';
      seconds = Math.round(seconds);
      if (config.timeFormat === 'hms') {
        const h = Math.floor(seconds / 3600);
        const m = Math.floor((seconds % 3600) / 60);
        const s = Math.floor(seconds % 60);
        return h > 0 ? `${h}:${m.toString().padStart(2, '0')}:${s.toString().padStart(2, '0')}` 
                     : `${m}:${s.toString().padStart(2, '0')}`;
      }
      return seconds + 's';
    }

    function formatHours(seconds) {
      if (seconds === null || seconds === undefined) return '-';
      return (seconds / 3600).toFixed(config.precision) + 'h';
    }

    function formatNumber(num) {
      if (num === null || num === undefined) return '-';
      return Number.isFinite(num) ? num.toFixed(config.precision) : '-';
    }

    function formatPercentage(num) {
      if (num === null || num === undefined) return '-';
      return Number.isFinite(num) ? num.toFixed(config.precision) + '%' : '-';
    }

    function getDayOfWeek(dateStr) {
      try {
        const parts = dateStr.split('/');
        if (parts.length === 3) {
          const day = parseInt(parts[0], 10);
          const month = parseInt(parts[1], 10) - 1;
          const year = parseInt(parts[2], 10);
          const date = new Date(year, month, day);
          if (!isNaN(date.getTime())) {
            return date.toLocaleDateString('en-GB', { weekday: 'long' });
          }
        }
        const date = new Date(dateStr);
        if (!isNaN(date.getTime())) {
          return date.toLocaleDateString('en-GB', { weekday: 'long' });
        }
      } catch (e) {
        console.error('Error parsing date:', dateStr, e);
      }
      return 'Unknown';
    }

    function getUKFormattedDate(date) {
      const day = date.getDate();
      const month = date.getMonth() + 1;
      const year = date.getFullYear();
      return (day < 10 ? '0' + day : day) + '/' + (month < 10 ? '0' + month : month) + '/' + year;
    }

    function getWeekDates(startDate) {
      const dates = [];
      const start = new Date(startDate);
      for (let i = 0; i < 7; i++) {
        const currentDate = new Date(start);
        currentDate.setDate(start.getDate() + i);
        const raw = isoDate(currentDate);
        const uk = getUKFormattedDate(currentDate);
        dates.push({ raw, uk });
      }
      return dates;
    }

    function isFutureDate(dateStr) {
      try {
        const parts = dateStr.split('/');
        if (parts.length === 3) {
          const day = parseInt(parts[0], 10);
          const month = parseInt(parts[1], 10) - 1;
          const year = parseInt(parts[2], 10);
          const date = new Date(year, month, day);
          const today = new Date();
          today.setHours(0, 0, 0, 0);
          return date > today;
        }
      } catch (e) {
        console.error('Error parsing date:', dateStr, e);
      }
      return false;
    }

    // ===== Data fetching functions =====
    async function fetchBusinessUnits() {
      try {
        const businessUnits = await fetchPaginatedData(
          `https://api.${config.REGION}/api/v2/workforcemanagement/businessunits?pageSize=100`
        );
        
        const select = document.getElementById('businessUnitSelect');
        select.innerHTML = '<option value="">-- Select Business Unit --</option>';
        
        businessUnits.forEach(bu => {
          const option = document.createElement('option');
          option.value = bu.id;
          option.textContent = bu.name;
          select.appendChild(option);
        });
        
        select.disabled = false;
        
        if (DEBUG) {
          console.log('Loaded business units:', businessUnits.length);
        }
      } catch (error) {
        console.error('Error fetching business units:', error);
        showMessage('Error loading business units: ' + error.message, 'error');
        document.getElementById('businessUnitSelect').innerHTML = '<option value="">-- Error loading business units --</option>';
      }
    }

    async function fetchPlanningGroups(businessUnitId) {
      try {
        const planningGroups = await fetchPaginatedData(
          `https://api.${config.REGION}/api/v2/workforcemanagement/businessunits/${businessUnitId}/planninggroups?pageSize=100`
        );
        
        const select = document.getElementById('planningGroup');
        select.innerHTML = '<option value="">-- Select Planning Group --</option>';
        
        planningGroups.forEach(pg => {
          const option = document.createElement('option');
          option.value = pg.id;
          option.textContent = pg.name;
          select.appendChild(option);
        });
        
        select.disabled = false;
        updateLoadButtonState();
        
        if (DEBUG) {
          console.log('Loaded planning groups:', planningGroups.length);
        }
      } catch (error) {
        console.error('Error fetching planning groups:', error);
        showMessage('Error loading planning groups: ' + error.message, 'error');
        document.getElementById('planningGroup').innerHTML = '<option value="">-- Error loading groups --</option>';
      }
    }

    async function fetchIntradayData(date) {
      const businessUnitId = document.getElementById('businessUnitSelect').value;
      const planningGroupId = document.getElementById('planningGroup').value;
      
      if (!businessUnitId) {
        return { date: date, data: null, error: 'No business unit selected' };
      }
      
      try {
        if (DEBUG) console.log(`🔍 Fetching forecast data for ${date}...`);
        
        const requestBody = {
          businessUnitDate: date,
          categories: ["ForecastData", "ScheduleData", "PerformancePredictionData"],
          intervalLengthMinutes: 15,
          ...(planningGroupId ? { planningGroupIds: [planningGroupId] } : {})
        };
        
        const response = await fetch(`https://api.${config.REGION}/api/v2/workforcemanagement/businessunits/${businessUnitId}/intraday`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': 'Bearer ' + state.accessToken
          },
          body: JSON.stringify(requestBody)
        });
        
        if (!response.ok) {
          if (response.status === 404) {
            return { date: date, data: null, error: 'No forecast data available for this date' };
          }
          
          const errorText = await response.text();
          let errorDetails = `HTTP error! status: ${response.status}`;
          try {
            const errorJson = JSON.parse(errorText);
            errorDetails += ` - ${errorJson.message || errorText}`;
          } catch {
            errorDetails += ` - ${errorText}`;
          }
          throw new Error(errorDetails);
        }
        
        let data = await response.json();

        // Poll while processing
        if (data.status && data.status !== 'Complete' && data.operationId) {
          data = await pollIntradayResult(businessUnitId, data.operationId);
        }

        return { date: date, data: data };
      } catch (error) {
        console.error('❌ Error fetching forecast data:', error);
        return { date: date, data: null, error: error.message };
      }
    }

    async function fetchDataForWeek(startDate) {
      const dateObjs = getWeekDates(startDate);
      showMessage(`Loading forecast data for week starting ${dateObjs[0].uk}...`, 'info');
      
      const fetchPromises = dateObjs.map(dateObj => 
        fetchIntradayData(dateObj.raw).then(result => ({ ...result, uk: dateObj.uk }))
      );
      
      state.weekData = await Promise.all(fetchPromises);
      refreshMediaTypeOptions(); // rebuild media options from data
      renderAllData();
      showMessage('Forecast data loaded successfully!', 'success');
    }

    async function fetchDataForMonth(startOfMonth) {
      const start = new Date(startOfMonth.getFullYear(), startOfMonth.getMonth(), 1);
      const end = new Date(startOfMonth.getFullYear(), startOfMonth.getMonth()+1, 0);
      const dates = [];
      for (let d = new Date(start); d <= end; d.setDate(d.getDate()+1)) {
        dates.push({ raw: isoDate(d), uk: getUKFormattedDate(d) });
      }
      showMessage(`Loading forecast data for ${startOfMonth.toLocaleString('en-GB', { month:'long', year:'numeric' })}...`, 'info');
      const results = await Promise.all(dates.map(d => fetchIntradayData(d.raw).then(r => ({ ...r, uk: d.uk }))));
      state.weekData = results; // reuse container for simplicity
      refreshMediaTypeOptions();
      renderAllData();
      showMessage('Monthly forecast data loaded!', 'success');
    }

    // ===== Rendering functions =====
    function renderAllData() {
      renderConsolidatedTable();
      
      if (document.getElementById('intervalTab').classList.contains('active')) {
        const intervalTitle = document.querySelector('#intervalTableContainer h3');
        if (intervalTitle) {
          const match = intervalTitle.textContent.match(/for (\d{2}\/\d{2}\/\d{4}) \((.+)\)/);
          if (match) {
            const day = state.weekData.find(d => d.uk === match[1]);
            if (day) render15MinTable(day, match[2]);
          }
        }
      }
    }

    function renderConsolidatedTable() {
      const mediaTypeFilter = document.getElementById('mediaType').value;
      
      document.getElementById('consolidatedSection').style.display = 'block';
      
      let tableHTML = `
        <div class="table-container">
          <table class="consolidated-table">
            <thead>
              <tr>
                <th>Date</th>
                <th>Day</th>
                <th>Media Type</th>
                <th colspan="2" class="group-header">Forecast Data</th>
                <th colspan="3" class="group-header">Performance Predictions</th>
                <th>Action</th>
              </tr>
              <tr>
                <th></th>
                <th></th>
                <th></th>
                <th class="sub-header">Offered</th>
                <th class="sub-header">AHT</th>
                <th class="sub-header">Service Level</th>
                <th class="sub-header">ASA</th>
                <th class="sub-header">Occupancy</th>
                <th></th>
              </tr>
            </thead>
            <tbody>
      `;

      // Calculate weekly totals
      const weeklyTotals = {
        offered: 0,
        aht: 0,
        serviceLevel: 0,
        asa: 0,
        occupancy: 0,
        count: 0
      };

      // First pass: calculate totals
      state.weekData.forEach(day => {
        if (!day.data || !day.data.result) return;
        
        const groupings = day.data.result.intradayDataGroupings;
        if (!Array.isArray(groupings)) return;

        groupings.forEach(group => {
          if (!group || !group.mediaType) return;
          if (mediaTypeFilter && group.mediaType !== mediaTypeFilter) return;

          const forecastSummary = group.forecastDataSummary || {};
          const performanceSummary = group.performancePredictionDataSummary || {};

          const offered = forecastSummary.offered || 0;
          const aht = forecastSummary.averageHandleTimeSeconds || 0;

          const serviceLevel = performanceSummary.serviceLevelPercent || 0;
          const asa = performanceSummary.averageSpeedOfAnswerSeconds || 0;
          const occupancy = performanceSummary.occupancyPercent || 0;

          weeklyTotals.offered += offered;
          weeklyTotals.aht += aht;
          weeklyTotals.serviceLevel += serviceLevel;
          weeklyTotals.asa += asa;
          weeklyTotals.occupancy += occupancy;
          weeklyTotals.count++;
        });
      });

      const avgAHT = weeklyTotals.count ? weeklyTotals.aht / weeklyTotals.count : 0;
      const avgSL = weeklyTotals.count ? weeklyTotals.serviceLevel / weeklyTotals.count : 0;
      const avgASA = weeklyTotals.count ? weeklyTotals.asa / weeklyTotals.count : 0;
      const avgOccupancy = weeklyTotals.count ? weeklyTotals.occupancy / weeklyTotals.count : 0;

      tableHTML += `
        <tr class="weekly-totals-row">
          <td colspan="3"><strong>Week Totals/Averages</strong></td>
          <td><strong>${Math.round(weeklyTotals.offered)}</strong></td>
          <td><strong>${formatTime(avgAHT)}</strong></td>
          <td><strong>${formatPercentage(avgSL)}</strong></td>
          <td><strong>${formatTime(avgASA)}</strong></td>
          <td><strong>${formatPercentage(avgOccupancy)}</strong></td>
          <td></td>
        </tr>
      `;

      // Reset registry for buttons
      state.dayRegistry = [];

      // Add daily data rows
      state.weekData.forEach(day => {
        if (!day.data || !day.data.result) {
          const dayOfWeek = getDayOfWeek(day.uk);
          tableHTML += `
            <tr>
              <td>${day.uk}</td>
              <td>${dayOfWeek}</td>
              <td colspan="7" class="no-data">${day.error || 'No forecast data available'}</td>
            </tr>
          `;
          return;
        }

        const groupings = day.data.result.intradayDataGroupings;
        
        if (!Array.isArray(groupings) || groupings.length === 0) {
          const dayOfWeek = getDayOfWeek(day.uk);
          tableHTML += `
            <tr>
              <td>${day.uk}</td>
              <td>${dayOfWeek}</td>
              <td colspan="7" class="no-data">No forecast data available</td>
            </tr>
          `;
          return;
        }

        groupings.forEach(group => {
          if (!group || !group.mediaType) return;
          if (mediaTypeFilter && group.mediaType !== mediaTypeFilter) return;

          const forecastSummary = group.forecastDataSummary || {};
          const performanceSummary = group.performancePredictionDataSummary || {};

          const offered = forecastSummary.offered ?? null;
          const aht = forecastSummary.averageHandleTimeSeconds ?? null;

          const serviceLevel = performanceSummary.serviceLevelPercent ?? null;
          const asa = performanceSummary.averageSpeedOfAnswerSeconds ?? null;
          const occupancy = performanceSummary.occupancyPercent ?? null;

          const dayOfWeek = getDayOfWeek(day.uk);
          const isFuture = isFutureDate(day.uk);
          const rowClass = isFuture ? 'future-date' : 'past-date';

          const idx = state.dayRegistry.push({ day, mediaType: group.mediaType }) - 1;
          
          tableHTML += `
            <tr class="${rowClass}">
              <td>${day.uk}</td>
              <td>${dayOfWeek}</td>
              <td>${group.mediaType}</td>
              <td>${Number.isFinite(offered) ? Math.round(offered) : '-'}</td>
              <td>${formatTime(aht)}</td>
              <td>${formatPercentage(serviceLevel)}</td>
              <td>${formatTime(asa)}</td>
              <td>${formatPercentage(occupancy)}</td>
              <td>
                <button class="view-intervals-btn" data-day-index="${idx}">
                  View Intervals
                </button>
              </td>
            </tr>
          `;
        });
      });

      tableHTML += '</tbody></table></div>';
      document.getElementById('consolidatedTableContainer').innerHTML = tableHTML;
    }

    function render15MinTable(day, mediaType) {
      let tableHTML = `<h3>15-min Intervals for ${day.uk} (${mediaType})</h3>`;
      tableHTML += `
        <div class="table-container">
          <table>
            <thead>
              <tr>
                <th>Time</th>
                <th>Forecast Offered</th>
                <th>Forecast AHT</th>
                <th>Scheduled Time</th>
                <th>Service Level</th>
                <th>ASA</th>
                <th>Occupancy</th>
              </tr>
            </thead>
            <tbody>
      `;
      
      if (day.data?.result?.intradayDataGroupings) {
        const grouping = day.data.result.intradayDataGroupings.find(g => g.mediaType === mediaType);
        if (!grouping) {
          tableHTML += '<tr><td colspan="7" class="no-data">No forecast data for selected media type</td></tr>';
        } else {
          const startDate = new Date(day.data.result.startDate);
          
          for (let i = 0; i < 96; i++) {
            const intervalTime = new Date(startDate);
            intervalTime.setMinutes(intervalTime.getMinutes() + i * 15);
            const timeStr = intervalTime.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
            
            const forecast = grouping.forecastDataPerInterval?.[i] || {};
            const schedule = grouping.scheduleDataPerInterval?.[i] || {};
            const performance = grouping.performancePredictionDataPerInterval?.[i] || {};

            const fOff = forecast.offered;
            const fAht = forecast.averageHandleTimeSeconds;
            const sch = schedule.onQueueTimeSeconds;
            const pSl = performance.serviceLevelPercent;
            const pAsa = performance.averageSpeedOfAnswerSeconds;
            const pOcc = performance.occupancyPercent;

            tableHTML += `
              <tr>
                <td>${timeStr}</td>
                <td>${Number.isFinite(fOff) ? Math.round(fOff * 100) / 100 : '-'}</td>
                <td>${formatTime(fAht)}</td>
                <td>${Number.isFinite(sch) ? formatHours(sch) : '-'}</td>
                <td>${formatPercentage(pSl)}</td>
                <td>${formatTime(pAsa)}</td>
                <td>${formatPercentage(pOcc)}</td>
              </tr>
            `;
          }
        }
      } else {
        tableHTML += '<tr><td colspan="7" class="no-data">No forecast data available</td></tr>';
      }
      
      tableHTML += '</tbody></table></div>';
      document.getElementById('intervalTableContainer').innerHTML = tableHTML;
      document.getElementById('intervalTableContainer').className = '';
    }

    // ====== Monthly data fetch helper ======
    // (Used by Prev/Next Month)
    // Already defined above: fetchDataForMonth()

    function show15MinDetails(day, mediaType) {
      setActiveTab('interval');
      render15MinTable(day, mediaType);
    }
  </script>
</body>
</html>
