<!DOCTYPE html>
<html>
<head>
  <title>Intraday Weekly Plan with Planning Groups</title>
  <meta charset="UTF-8">
  <style>
    /* [Previous CSS styles remain the same] */
    .summary-table th {
      text-align: left;
      padding: 8px;
      border-bottom: 1px solid #ccc;
    }
    .summary-table td {
      padding: 8px;
      border-bottom: 1px solid #ccc;
    }
  </style>
</head>
<body>
  <!-- [Previous HTML structure remains the same until the script] -->

  <script>
    /***** Configuration *****/
    const config = {
      timeFormat: 'seconds',
      precision: 1,
      CLIENT_ID: '256876c6-470d-4304-8e7d-2038f8a55d95',
      REGION: 'mypurecloud.ie',
      REDIRECT_URI: window.location.href.split('?')[0].split('#')[0]
    };

    /* [Previous initialization code remains the same until getDayOfWeek function] */

    function getDayOfWeek(dateStr) {
      try {
        // Parse UK format date (DD/MM/YYYY)
        const parts = dateStr.split('/');
        if (parts.length === 3) {
          const day = parseInt(parts[0], month = parseInt(parts[1]) - 1, year = parseInt(parts[2]);
          const date = new Date(year, month, day);
          if (!isNaN(date.getTime())) {
            return date.toLocaleDateString('en-US', { weekday: 'long' });
          }
        }
        // Fallback to ISO format if UK format fails
        const date = new Date(dateStr);
        if (!isNaN(date.getTime())) {
          return date.toLocaleDateString('en-US', { weekday: 'long' });
        }
      } catch (e) {
        console.error('Error parsing date:', dateStr, e);
      }
      return 'Invalid Date';
    }

    /* [Previous code remains the same until renderDailyTable function] */

    function renderDailyTable() {
      const mediaTypeFilter = document.getElementById('mediaType').value;
      
      // Create table header
      let tableHTML = `
        <table>
          <thead>
            <tr>
              <th>Date</th>
              <th>Day</th>
              <th>Planning Group</th>
              <th>Media Type</th>
              <th>Forecast Offered</th>
              <th>Forecast AHT</th>
              <th>Scheduled Time</th>
              <th>Service Level</th>
              <th>ASA</th>
              <th>Occupancy</th>
              <th>Action</th>
            </tr>
          </thead>
          <tbody>
      `;

      const weeklyTotals = {
        offered: 0,
        aht: 0,
        scheduledTime: 0,
        serviceLevel: 0,
        asa: 0,
        occupancy: 0,
        count: 0
      };

      // Process each day's data
      weekData.forEach(day => {
        if (!day.data || !day.data.result) {
          const dayOfWeek = getDayOfWeek(day.uk); // Use UK format date for day calculation
          tableHTML += `
            <tr>
              <td>${day.uk}</td>
              <td>${dayOfWeek}</td>
              <td colspan="9" class="no-data">${day.error || 'No data available'}</td>
            </tr>
          `;
          return;
        }

        day.data.result.intradayDataGroupings.forEach(group => {
          if (mediaTypeFilter && group.mediaType !== mediaTypeFilter) return;

          const offered = group.forecastDataSummary?.offered || 0;
          const aht = group.forecastDataSummary?.averageHandleTimeSeconds || 0;
          const scheduledTime = group.scheduleDataSummary?.onQueueTimeSeconds || 0;
          const serviceLevel = group.performancePredictionDataSummary?.serviceLevelPercent || 0;
          const asa = group.performancePredictionDataSummary?.averageSpeedOfAnswerSeconds || 0;
          const occupancy = group.performancePredictionDataSummary?.occupancyPercent || 0;

          weeklyTotals.offered += offered;
          weeklyTotals.aht += aht;
          weeklyTotals.scheduledTime += scheduledTime;
          weeklyTotals.serviceLevel += serviceLevel;
          weeklyTotals.asa += asa;
          weeklyTotals.occupancy += occupancy;
          weeklyTotals.count++;

          const dayOfWeek = getDayOfWeek(day.uk); // Use UK format date for day calculation
          
          tableHTML += `
            <tr>
              <td>${day.uk}</td>
              <td>${dayOfWeek}</td>
              <td>${planningGroupName}</td>
              <td>${group.mediaType}</td>
              <td>${Math.round(offered)}</td>
              <td>${formatTime(aht)}</td>
              <td>${formatHours(scheduledTime)}</td>
              <td>${formatNumber(serviceLevel)}%</td>
              <td>${formatTime(asa)}</td>
              <td>${formatNumber(occupancy)}%</td>
              <td>
                <button onclick='show15MinDetails(${JSON.stringify(day).replace(/'/g, "&apos;")}, "${group.mediaType}")'>
                  View Details
                </button>
              </td>
            </tr>
          `;
        });
      });

      // Calculate weekly averages
      const weeklyAvgAHT = weeklyTotals.count > 0 ? weeklyTotals.aht / weeklyTotals.count : 0;
      const weeklyAvgSL = weeklyTotals.count > 0 ? weeklyTotals.serviceLevel / weeklyTotals.count : 0;
      const weeklyAvgASA = weeklyTotals.count > 0 ? weeklyTotals.asa / weeklyTotals.count : 0;
      const weeklyAvgOccupancy = weeklyTotals.count > 0 ? weeklyTotals.occupancy / weeklyTotals.count : 0;

      // Create aligned weekly summary
      const summaryHTML = `
        <div class="summary-row">
          <table class="summary-table">
            <thead>
              <tr>
                <th>Summary</th>
                <th>Forecast Offered</th>
                <th>Avg AHT</th>
                <th>Total Scheduled</th>
                <th>Avg SL</th>
                <th>Avg ASA</th>
                <th>Avg Occupancy</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td><strong>Weekly Totals/Averages</strong></td>
                <td>${Math.round(weeklyTotals.offered)}</td>
                <td>${formatTime(weeklyAvgAHT)}</td>
                <td>${formatHours(weeklyTotals.scheduledTime)}</td>
                <td>${formatNumber(weeklyAvgSL)}%</td>
                <td>${formatTime(weeklyAvgASA)}</td>
                <td>${formatNumber(weeklyAvgOccupancy)}%</td>
              </tr>
            </tbody>
          </table>
        </div>
      `;

      document.getElementById('weeklySummary').innerHTML = summaryHTML;
      tableHTML += '</tbody></table>';
      document.getElementById('dailyTableContainer').innerHTML = tableHTML;
    }

    /* [Rest of the JavaScript code remains the same] */
  </script>
</body>
</html>
