<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Intraday Weekly Plan</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <style>
    :root{
      --primary-color:#63AB8F; --secondary-color:#4A8C7D; --border-color:#DEE2E6;
      --light-bg:#F8F9FA; --card-bg:#FFFFFF; --text-color:#2C3E50; --text-light:#6C757D;
      --pill:#e9f6f0;
    }
    body{
      font-family:'Aptos','Segoe UI',system-ui,-apple-system,Arial,sans-serif;
      margin:20px;padding:20px;max-width:1400px;background:var(--light-bg);color:var(--text-color)
    }
    #logo-container{text-align:center;margin-bottom:20px} #logo{width:300px}
    h1{margin:0 0 16px}
    .card{background:var(--card-bg);border:1px solid var(--border-color);border-radius:12px;padding:24px;margin-top:16px;box-shadow:0 1px 3px rgba(0,0,0,.08)}
    label{display:block;font-weight:600;margin-bottom:6px}
    input,select,button,textarea{padding:10px;border:1px solid var(--border-color);border-radius:6px;background:#fff;font-size:14px}
    button{background:var(--primary-color);color:#fff;font-weight:600;cursor:pointer;transition:background .2s}
    button:hover{background:var(--secondary-color)} button:disabled{background:var(--text-light);cursor:not-allowed}
    .controls{display:grid;grid-template-columns:repeat(auto-fit,minmax(260px,1fr));gap:16px;align-items:end}
    .full-width-btn{width:100%;padding:14px 18px;font-size:16px;margin-top:12px}
    .muted{color:var(--text-light);font-size:12px}
    .section-title{margin:0 0 10px;color:var(--secondary-color)}

    #messageContainer{display:none;margin-top:12px}
    .error-message{color:#b4231a;background:#fee2e2;border:1px solid #fecaca;padding:10px;border-radius:6px}
    .success-message{color:#14532d;background:#dcfce7;border:1px solid #bbf7d0;padding:10px;border-radius:6px}
    .info-message{color:#6b4e16;background:#fff7ed;border:1px solid #ffedd5;padding:10px;border-radius:6px}

    /* Table Styling */
    table { width: 100%; border-collapse: collapse; margin-top: 20px; border: 1px solid var(--border-color); border-radius: 6px; overflow: hidden; }
    th, td { padding: 10px 12px; text-align: left; border-bottom: 1px solid var(--border-color); vertical-align: middle; }
    th { background-color: var(--primary-color); color: white; font-weight: 600; }
    tr:hover { background-color: rgba(99, 171, 143, 0.05); }

    .th-dow { background: var(--secondary-color); font-weight: 700; }
    .th-date { background: rgba(99,171,143,.85); }

    .consolidated-table th.group-header { background-color: var(--secondary-color); text-align: center; }
    .consolidated-table th.sub-header { background-color: rgba(99, 171, 143, 0.8); }
    .weekly-totals-row { background-color: rgba(99, 171, 143, 0.1); font-weight: 600; }
    .weekly-totals-row td { border-bottom: 2px solid var(--primary-color); }
    .future-date { background-color: rgba(248, 249, 250, 0.5); }
    .past-date { opacity: 0.7; }

    /* Tab Styling */
    .tab { display: inline-block; padding: 12px 20px; margin-right: 10px; background: #eee; cursor: pointer; border-radius: 6px; font-weight: 500; }
    .tab.active { background: var(--primary-color); color: white; font-weight: 600; }
    .tab-content { display: none; }
    .tab-content.active { display: block; }

    .no-data { color: var(--text-light); font-style: italic; text-align: center; padding: 20px; }
    .loading { color: var(--text-light); font-style: italic; text-align: center; padding: 20px; }

    .table-container { overflow-x: auto; margin-top: 20px; border: 1px solid var(--border-color); border-radius: 6px; padding: 1px; }
    .metrics-section { margin-bottom: 30px; }
    .metrics-section h3 { color: var(--secondary-color); margin-bottom: 15px; border-bottom: 2px solid var(--primary-color); padding-bottom: 5px; }

    /* Weekly/Monthly View Styles */
    .view-controls { display: flex; gap: 10px; margin-bottom: 15px; align-items: center; }
    .view-controls button { padding: 8px 15px; }
    .planning-group-header { background-color: #e6f2ff; font-weight: bold; text-align: left; }
    .data-row:nth-child(even) { background-color: #f9f9f9; }
  </style>
</head>
<body>
  <div id="logo-container">
    <img id="logo" src="https://raw.githubusercontent.com/gmcglynn88/Management-Unit-Search/main/Consultinglogo%20(2).png" alt="Company Logo">
  </div>

  <h1>Intraday Weekly Plan - Forecast & Predictions</h1>

  <div id="authCard" class="card">
    <div id="auth-message" class="info-message">Authenticating with PureCloud...</div>
  </div>

  <!-- Debug (shows only when ?debug=1 is in the URL) -->
  <div id="authDebug" class="card" style="display:none">
    <h2 class="section-title">Auth debug</h2>
    <p class="muted">This block appears when you add <code>?debug=1</code> to the page URL.</p>
    <pre id="authDump" class="debug"></pre>
    <button id="signinBtn">Sign in with Genesys</button>
  </div>

  <div id="appContent" style="display:none;">
    <div id="messageContainer"></div>

    <div class="card">
      <h2 class="section-title">Configuration</h2>
      <div class="controls">
        <div>
          <label for="businessUnitSelect">Select Business Unit:</label>
          <select id="businessUnitSelect" disabled>
            <option value="">-- Loading Business Units --</option>
          </select>
        </div>
        <div>
          <label for="planningGroup">Select Planning Group:</label>
          <select id="planningGroup" disabled>
            <option value="">-- Select Business Unit First --</option>
          </select>
          <div class="muted" style="margin-top:6px">Choose ‚ÄúAll planning groups‚Äù to see separate tables per PG.</div>
        </div>
        <div class="calendar-container">
          <label for="weekSelect">Select Week:</label>
          <input type="text" id="weekSelect" class="calendar-input" placeholder="Click to select week" readonly>
          <div id="calendarPopup" class="calendar-popup">
            <div class="calendar-header">
              <button id="prevMonth">&lt;</button>
              <h4 id="currentMonth">Month Year</h4>
              <button id="nextMonth">&gt;</button>
            </div>
            <div class="calendar-grid" id="calendarGrid"></div>
          </div>
        </div>
        <div>
          <label for="mediaType">Media Type:</label>
          <select id="mediaType">
            <option value="">--All--</option>
            <option value="Voice">Voice</option>
            <option value="Message">Message</option>
          </select>
        </div>
        <div class="load-btn-container">
          <button id="loadDataBtn" class="full-width-btn" disabled>
            Load Forecast Data
          </button>
        </div>
      </div>
    </div>

    <!-- Tabs -->
    <div class="card">
      <div style="margin-bottom: 20px;">
        <div id="tabs">
          <div id="dailyTabButton" class="tab active">Daily Forecast</div>
          <div id="intervalTabButton" class="tab">15-min Intervals</div>
          <div id="weeklyViewTabButton" class="tab">Weekly View</div>
          <div id="monthlyViewTabButton" class="tab">Monthly View</div>
        </div>
      </div>
      
      <div id="dailyTab" class="tab-content active">
        <h2 class="section-title">Daily Forecast Data</h2>
        <div id="weeklySummary" class="loading">Select a week and click "Load Forecast Data" to view forecast and predictions</div>
        <div class="metrics-section" id="consolidatedSection" style="display: none;">
          <h3>üìä Weekly Forecast & Performance Predictions</h3>
          <div id="consolidatedTableContainer"></div>
        </div>
      </div>
      
      <div id="intervalTab" class="tab-content">
        <h2 class="section-title">15-min Interval Data</h2>
        <div id="intervalTableContainer" class="loading">Select a day to view interval forecast data</div>
      </div>

      <div id="weeklyViewTab" class="tab-content">
        <h2 class="section-title">Weekly Forecast View</h2>
        <div class="view-controls">
          <button id="prevWeekBtn">Previous Week</button>
          <span id="weekRangeDisplay"></span>
          <button id="nextWeekBtn">Next Week</button>
        </div>
        <div id="weeklyViewContainer" class="loading">Load forecast data to view weekly summary</div>
      </div>

      <div id="monthlyViewTab" class="tab-content">
        <h2 class="section-title">Monthly Forecast View</h2>
        <div class="view-controls">
          <button id="prevMonthBtn">Previous Month</button>
          <span id="monthRangeDisplay"></span>
          <button id="nextMonthBtn">Next Month</button>
        </div>
        <div id="monthlyViewContainer" class="loading">Load forecast data to view monthly summary</div>
      </div>
    </div>
  </div>

  <script>
    // ===== OAuth Config =====
    const clientId = 'fe305808-b368-4547-8af9-325d28d552bb';
    const config = { timeFormat: 'seconds', precision: 1, REGION: 'mypurecloud.ie' };
    const redirectUri = new URL('.', window.location.href).href;
    const oauthUrl =
      `https://login.${config.REGION}/oauth/authorize?client_id=${encodeURIComponent(clientId)}&response_type=token&redirect_uri=${encodeURIComponent(redirectUri)}&state=intraday`;
    const DEBUG = new URLSearchParams(window.location.search).has('debug');

    // ===== State =====
    const state = {
      accessToken: null,
      weekData: [],
      planningGroupsMap: {},   // id -> name
      selectedWeekStart: null,
      calendarDate: new Date(),
      currentWeekStart: getMonday(new Date()),
      currentMonthStart: new Date(new Date().getFullYear(), new Date().getMonth(), 1),
      dayRegistry: []
    };

    // ===== Calendar =====
    function initCalendar() {
      const calendarInput = document.getElementById('weekSelect');
      const calendarPopup = document.getElementById('calendarPopup');
      const prevMonthBtn = document.getElementById('prevMonth');
      const nextMonthBtn = document.getElementById('nextMonth');

      calendarInput.addEventListener('click', () => {
        calendarPopup.classList.toggle('active');
        renderCalendar();
      });
      prevMonthBtn.addEventListener('click', () => { state.calendarDate.setMonth(state.calendarDate.getMonth() - 1); renderCalendar(); });
      nextMonthBtn.addEventListener('click', () => { state.calendarDate.setMonth(state.calendarDate.getMonth() + 1); renderCalendar(); });
      document.addEventListener('click', (e) => {
        if (!calendarInput.contains(e.target) && !calendarPopup.contains(e.target)) calendarPopup.classList.remove('active');
      });
    }
    function renderCalendar() {
      const currentMonthEl = document.getElementById('currentMonth');
      const calendarGrid = document.getElementById('calendarGrid');
      const year = state.calendarDate.getFullYear();
      const month = state.calendarDate.getMonth();
      currentMonthEl.textContent = state.calendarDate.toLocaleDateString('en-GB',{month:'long',year:'numeric'});

      const firstDay = new Date(year, month, 1);
      const lastDay  = new Date(year, month+1, 0);
      const startDate = new Date(firstDay);
      startDate.setDate(firstDay.getDate() - firstDay.getDay() + (firstDay.getDay()===0?-6:1));
      const endDate = new Date(lastDay);
      endDate.setDate(lastDay.getDate() + (7 - lastDay.getDay()) % 7);

      calendarGrid.innerHTML = '';
      const days = ['Mon','Tue','Wed','Thu','Fri','Sat','Sun'];
      days.forEach(d => {
        const h=document.createElement('div'); h.textContent=d; h.style.fontWeight='bold'; h.style.textAlign='center'; calendarGrid.appendChild(h);
      });

      for (let d = new Date(startDate); d <= endDate; d.setDate(d.getDate()+1)) {
        const dayEl = document.createElement('div');
        dayEl.className = 'calendar-day';
        dayEl.textContent = d.getDate();
        if (d.getMonth() !== month) dayEl.classList.add('other-month');

        // capture the date for this cell (avoid closure bug)
        const dateForClick = new Date(d.getTime());
        dayEl.addEventListener('click', () => selectWeek(dateForClick));

        // highlight selected range
        if (state.selectedWeekStart) {
          const ws = new Date(state.selectedWeekStart); const we = new Date(ws); we.setDate(ws.getDate()+6);
          if (dateForClick >= ws && dateForClick <= we) dayEl.style.backgroundColor = 'rgba(99,171,143,.2)';
          if (dateForClick.getTime() === ws.getTime()) dayEl.classList.add('week-start');
        }
        calendarGrid.appendChild(dayEl);
      }
    }
    function selectWeek(date) {
      const selectedDate = new Date(date);
      const dow = selectedDate.getDay();
      const diff = selectedDate.getDate() - dow + (dow===0 ? -6 : 1);
      const monday = new Date(selectedDate.setDate(diff));

      state.selectedWeekStart = monday.toISOString().split('T')[0];
      state.currentWeekStart = new Date(monday);

      const we = new Date(monday); we.setDate(monday.getDate()+6);
      document.getElementById('weekSelect').value = `Week ${getUKFormattedDate(monday)} - ${getUKFormattedDate(we)}`;
      document.getElementById('calendarPopup').classList.remove('active');
      updateLoadButtonState();
    }

    // ===== Utils =====
    function isoDate(d){ const dt=new Date(d); dt.setHours(12,0,0,0); const off=new Date(dt.getTime()-dt.getTimezoneOffset()*60000); return off.toISOString().split('T')[0]; }
    async function fetchPaginatedData(url, options = {}) {
      let all=[]; let nextUrl=url;
      while (nextUrl) {
        const r=await fetch(nextUrl,{headers:{'Authorization':'Bearer '+state.accessToken,...options.headers},...options});
        if(!r.ok) throw new Error(`HTTP ${r.status}`); const data=await r.json();
        if (data.entities) all=all.concat(data.entities); else if (data.results) all=all.concat(data.results); else return data;
        nextUrl = data.nextUri ? `https://api.${config.REGION}${data.nextUri}` : null;
      }
      return all;
    }
    async function pollIntradayResult(buId, opId, { maxAttempts=12, delayMs=750 }={}) {
      for (let i=1;i<=maxAttempts;i++){
        const r=await fetch(`https://api.${config.REGION}/api/v2/workforcemanagement/businessunits/${buId}/intraday/${opId}`,{headers:{'Authorization':'Bearer '+state.accessToken}});
        if(!r.ok) throw new Error(`Polling failed: ${r.status}`); const data=await r.json();
        if (data.status==='Complete' && data.result) return data;
        await new Promise(res=>setTimeout(res,delayMs));
      }
      throw new Error('Intraday operation timed out');
    }
    function showMessage(msg,type='error',details=''){
      const box=document.getElementById('messageContainer');
      let html=`<div class="${type}-message">${msg}</div>`;
      if(details && DEBUG){ html+=`<div class="info-message" style="margin-top:8px;"><pre style="font-size:11px;overflow:auto;">${JSON.stringify(details,null,2)}</pre></div>`; }
      box.innerHTML=html; box.style.display='block'; if(type==='success'){ setTimeout(()=>box.style.display='none',5000); }
    }
    function getMonday(date){ const d=new Date(date); const day=d.getDay(); const diff=d.getDate()-day+(day===0?-6:1); return new Date(d.setDate(diff)); }
    function formatTime(seconds){ if(seconds===null||seconds===undefined) return '-'; seconds=Math.round(seconds); if(config.timeFormat==='hms'){ const h=Math.floor(seconds/3600), m=Math.floor((seconds%3600)/60), s=Math.floor(seconds%60); return h>0?`${h}:${m.toString().padStart(2,'0')}:${s.toString().padStart(2,'0')}`:`${m}:${s.toString().padStart(2,'0')}`;} return seconds+'s'; }
    function formatHours(seconds){ if(seconds===null||seconds===undefined) return '-'; return (seconds/3600).toFixed(config.precision)+'h'; }
    function formatNumber(num){ if(num===null||num===undefined) return '-'; return Number.isFinite(num)?num.toFixed(config.precision):'-'; }
    function formatPercentage(num){ if(num===null||num===undefined) return '-'; return Number.isFinite(num)?num.toFixed(config.precision)+'%':'-'; }
    function getUKFormattedDate(date){ const d=date.getDate(), m=date.getMonth()+1, y=date.getFullYear(); return (d<10?'0'+d:d)+'/'+(m<10?'0'+m:m)+'/'+y; }
    function getDOWFromUK(uk){ const [dd,mm,yyyy]=uk.split('/').map(Number); const dt=new Date(yyyy,mm-1,dd); return dt.toLocaleDateString('en-GB',{weekday:'short'}); }

    function getWeekDates(startDate){
      const dates=[]; const start=new Date(startDate);
      for(let i=0;i<7;i++){ const cur=new Date(start); cur.setDate(start.getDate()+i); dates.push({ raw: isoDate(cur), uk: getUKFormattedDate(cur) }); }
      return dates;
    }

    function computePredictionFallback(grouping){
      // If summary values are missing/zero, compute averages from interval arrays
      const per = grouping?.performancePredictionDataPerInterval || [];
      let slSum=0, slCnt=0, asaSum=0, asaCnt=0, occSum=0, occCnt=0;
      per.forEach(x=>{
        if(!x) return;
        if(x.serviceLevelPercent!==undefined){ slSum+=x.serviceLevelPercent; slCnt++; }
        if(x.averageSpeedOfAnswerSeconds!==undefined){ asaSum+=x.averageSpeedOfAnswerSeconds; asaCnt++; }
        if(x.occupancyPercent!==undefined){ occSum+=x.occupancyPercent; occCnt++; }
      });
      return {
        serviceLevelPercent: slCnt? slSum/slCnt : null,
        averageSpeedOfAnswerSeconds: asaCnt? asaSum/asaCnt : null,
        occupancyPercent: occCnt? occSum/occCnt : null
      };
    }

    // ===== Auth bootstrap =====
    document.addEventListener('DOMContentLoaded', () => {
      const hash=window.location.hash.substring(1); const params=new URLSearchParams(hash); const qparams=new URLSearchParams(window.location.search);
      const oauthError=params.get('error')||qparams.get('error'); const oauthErrorDesc=params.get('error_description')||qparams.get('error_description');
      if (oauthError){ document.getElementById('auth-message').textContent=`OAuth error: ${oauthErrorDesc||oauthError}`; document.getElementById('auth-message').className='error-message'; if(DEBUG) showDebugCard(); return; }
      const tokenFromHash=params.get('access_token'); const tokenFromSession=sessionStorage.getItem('purecloud_token');
      if (tokenFromHash){ state.accessToken=tokenFromHash; sessionStorage.setItem('purecloud_token',state.accessToken); history.replaceState(null,'',window.location.href.split('#')[0]); initializeApplication(); }
      else if (tokenFromSession){ state.accessToken=tokenFromSession; initializeApplication(); }
      else { if (DEBUG) showDebugCard(); else window.location.href=oauthUrl; }
    });
    function showDebugCard(){ const dump={clientId,redirectUri,oauthUrl,region:config.REGION}; document.getElementById('authDebug').style.display='block'; document.getElementById('authDump').textContent=JSON.stringify(dump,null,2); document.getElementById('signinBtn').onclick=()=>location.href=oauthUrl; document.getElementById('auth-message').textContent='Debug mode: click "Sign in with Genesys".'; document.getElementById('auth-message').className='info-message'; }

    function initializeApplication(){
      document.getElementById('auth-message').textContent='Authenticated successfully!'; document.getElementById('auth-message').className='success-message';
      setTimeout(()=>{ document.getElementById('authCard').style.display='none'; document.getElementById('authDebug').style.display='none'; }, 1200);
      document.getElementById('appContent').style.display='block';
      initializeApp();
    }

    function initializeApp(){
      document.getElementById('businessUnitSelect').addEventListener('change', onBusinessUnitChange);
      document.getElementById('planningGroup').addEventListener('change', onPlanningGroupChange);
      document.getElementById('mediaType').addEventListener('change', onConfigChange);
      document.getElementById('loadDataBtn').addEventListener('click', loadData);
      document.getElementById('dailyTabButton').addEventListener('click', ()=>setActiveTab('daily'));
      document.getElementById('intervalTabButton').addEventListener('click', ()=>setActiveTab('interval'));
      document.getElementById('weeklyViewTabButton').addEventListener('click', ()=>setActiveTab('weeklyView'));
      document.getElementById('monthlyViewTabButton').addEventListener('click', ()=>setActiveTab('monthlyView'));
      document.getElementById('prevWeekBtn').addEventListener('click', navigatePrevWeek);
      document.getElementById('nextWeekBtn').addEventListener('click', navigateNextWeek);
      document.getElementById('prevMonthBtn').addEventListener('click', navigatePrevMonth);
      document.getElementById('nextMonthBtn').addEventListener('click', navigateNextMonth);

      // Delegated click for interval buttons
      document.getElementById('consolidatedTableContainer').onclick = (e) => {
        const btn = e.target.closest('.view-intervals-btn'); if (!btn) return;
        const idx = Number(btn.dataset.dayIndex); const entry = state.dayRegistry[idx];
        if (entry) { setActiveTab('interval'); render15MinTable(entry.day, entry.mediaType); }
      };

      initCalendar();
      fetchBusinessUnits();

      // Set default week = current week
      const today=new Date(); const dow=today.getDay(); const diff=today.getDate()-dow+(dow===0?-6:1); const monday=new Date(today.setDate(diff));
      selectWeek(monday);
      updateWeeklyViewDisplay(); updateMonthlyViewDisplay();
    }

    function onBusinessUnitChange(){
      const buId=this.value; const pgSel=document.getElementById('planningGroup');
      pgSel.innerHTML='<option value="">-- Loading Planning Groups --</option>'; pgSel.disabled=true; document.getElementById('loadDataBtn').disabled=true;
      if (buId) fetchPlanningGroups(buId); else { pgSel.innerHTML='<option value="">-- Select Business Unit First --</option>'; }
    }
    function onPlanningGroupChange(){ updateLoadButtonState(); }
    function onConfigChange(){ if(state.weekData.length>0){ renderAllData(); updateWeeklyViewDisplay(); updateMonthlyViewDisplay(); } }
    function updateLoadButtonState(){
      const bu = document.getElementById('businessUnitSelect').value;
      const pg = document.getElementById('planningGroup').value;
      const week = state.selectedWeekStart;
      document.getElementById('loadDataBtn').disabled = !(bu && pg!==null && week);
    }

    // ===== Data fetching =====
    async function fetchBusinessUnits(){
      try{
        const bus=await fetchPaginatedData(`https://api.${config.REGION}/api/v2/workforcemanagement/businessunits?pageSize=100`);
        const sel=document.getElementById('businessUnitSelect'); sel.innerHTML='<option value="">-- Select Business Unit --</option>';
        bus.forEach(bu=>{ const opt=document.createElement('option'); opt.value=bu.id; opt.textContent=bu.name; sel.appendChild(opt); });
        sel.disabled=false;
      }catch(e){ showMessage('Error loading business units: '+e.message,'error'); }
    }

    async function fetchPlanningGroups(businessUnitId){
      try{
        const pgs=await fetchPaginatedData(`https://api.${config.REGION}/api/v2/workforcemanagement/businessunits/${businessUnitId}/planninggroups?pageSize=100`);
        const sel=document.getElementById('planningGroup'); sel.innerHTML='';
        // Add "All" option
        const allOpt=document.createElement('option'); allOpt.value='__ALL__'; allOpt.textContent='All planning groups'; sel.appendChild(allOpt);
        // Map & add items
        state.planningGroupsMap = {};
        pgs.forEach(pg=>{ state.planningGroupsMap[pg.id]=pg.name; const opt=document.createElement('option'); opt.value=pg.id; opt.textContent=pg.name; sel.appendChild(opt); });
        sel.disabled=false; updateLoadButtonState();
      }catch(e){ showMessage('Error loading planning groups: '+e.message,'error'); document.getElementById('planningGroup').innerHTML='<option value="">-- Error loading groups --</option>'; }
    }

    async function fetchIntradayData(date){
      const buId=document.getElementById('businessUnitSelect').value;
      const pgSel=document.getElementById('planningGroup').value;
      if(!buId) return { date, data:null, error:'No business unit selected' };
      try{
        const body={
          businessUnitDate: date,
          categories: ["ForecastData","ScheduleData","PerformancePredictionData"],
          intervalLengthMinutes: 15
        };
        if (pgSel && pgSel!=='__ALL__') body.planningGroupIds=[pgSel];

        const res=await fetch(`https://api.${config.REGION}/api/v2/workforcemanagement/businessunits/${buId}/intraday`,{
          method:'POST', headers:{'Content-Type':'application/json','Authorization':'Bearer '+state.accessToken}, body:JSON.stringify(body)
        });
        if(!res.ok){
          if(res.status===404) return { date, data:null, error:'No forecast data available for this date' };
          const t=await res.text(); throw new Error(`HTTP ${res.status}: ${t}`);
        }
        let data=await res.json();
        if (data.status && data.status!=='Complete' && data.operationId){ data=await pollIntradayResult(buId,data.operationId); }
        return { date, data };
      }catch(e){ return { date, data:null, error:e.message }; }
    }

    async function fetchDataForWeek(startDate){
      const days=getWeekDates(startDate);
      showMessage(`Loading forecast data for week starting ${days[0].uk}...`,'info');
      state.weekData = await Promise.all(days.map(d => fetchIntradayData(d.raw).then(r=>({...r,uk:d.uk}))));
      refreshMediaTypeOptions();
      renderAllData();
      showMessage('Forecast data loaded successfully!','success');
    }
    async function fetchDataForMonth(startOfMonth){
      const start=new Date(startOfMonth.getFullYear(),startOfMonth.getMonth(),1);
      const end=new Date(startOfMonth.getFullYear(),startOfMonth.getMonth()+1,0);
      const dates=[]; for(let d=new Date(start); d<=end; d.setDate(d.getDate()+1)){ dates.push({ raw: isoDate(d), uk: getUKFormattedDate(d) }); }
      showMessage(`Loading forecast data for ${startOfMonth.toLocaleString('en-GB',{month:'long',year:'numeric'})}...`,'info');
      state.weekData = await Promise.all(dates.map(d => fetchIntradayData(d.raw).then(r=>({...r,uk:d.uk}))));
      refreshMediaTypeOptions(); renderAllData(); showMessage('Monthly forecast data loaded!','success');
    }

    // ===== Renders =====
    function loadData(){
      const weekStart=state.selectedWeekStart;
      if(!weekStart) return;
      document.getElementById('weeklySummary').className='loading';
      document.getElementById('weeklySummary').textContent='Loading forecast data...';
      document.getElementById('loadDataBtn').disabled=true; document.getElementById('loadDataBtn').textContent='Loading...';
      document.getElementById('consolidatedSection').style.display='none';
      fetchDataForWeek(weekStart).finally(()=>{ document.getElementById('loadDataBtn').disabled=false; document.getElementById('loadDataBtn').textContent='Load Forecast Data'; updateWeeklyViewDisplay(); updateMonthlyViewDisplay(); });
    }
    function setActiveTab(name){
      document.getElementById('dailyTab').classList.toggle('active', name==='daily');
      document.getElementById('intervalTab').classList.toggle('active', name==='interval');
      document.getElementById('weeklyViewTab').classList.toggle('active', name==='weeklyView');
      document.getElementById('monthlyViewTab').classList.toggle('active', name==='monthlyView');
      document.getElementById('dailyTabButton').classList.toggle('active', name==='daily');
      document.getElementById('intervalTabButton').classList.toggle('active', name==='interval');
      document.getElementById('weeklyViewTabButton').classList.toggle('active', name==='weeklyView');
      document.getElementById('monthlyViewTabButton').classList.toggle('active', name==='monthlyView');
    }

    async function navigatePrevWeek(){ state.currentWeekStart.setDate(state.currentWeekStart.getDate()-7); await fetchDataForWeek(isoDate(state.currentWeekStart)); updateWeeklyViewDisplay(); }
    async function navigateNextWeek(){ state.currentWeekStart.setDate(state.currentWeekStart.getDate()+7); await fetchDataForWeek(isoDate(state.currentWeekStart)); updateWeeklyViewDisplay(); }
    async function navigatePrevMonth(){ state.currentMonthStart.setMonth(state.currentMonthStart.getMonth()-1); await fetchDataForMonth(state.currentMonthStart); updateMonthlyViewDisplay(); }
    async function navigateNextMonth(){ state.currentMonthStart.setMonth(state.currentMonthStart.getMonth()+1); await fetchDataForMonth(state.currentMonthStart); updateMonthlyViewDisplay(); }

    function updateWeeklyViewDisplay(){
      const we=new Date(state.currentWeekStart); we.setDate(state.currentWeekStart.getDate()+6);
      document.getElementById('weekRangeDisplay').textContent = `${getUKFormattedDate(state.currentWeekStart)} - ${getUKFormattedDate(we)}`;
      document.getElementById('weeklyViewContainer').innerHTML = state.weekData.length ? generateWeeklyViewTables() : '<div class="no-data">Load forecast data first to view weekly summary</div>';
    }
    function updateMonthlyViewDisplay(){
      document.getElementById('monthRangeDisplay').textContent = `${state.currentMonthStart.toLocaleString('en-GB',{month:'long',year:'numeric'})}`;
      document.getElementById('monthlyViewContainer').innerHTML = state.weekData.length ? generateMonthlyViewTables() : '<div class="no-data">Load forecast data first to view monthly summary</div>';
    }

    function getAllMediaTypesFromData(){
      const s=new Set();
      state.weekData.forEach(day => day.data?.result?.intradayDataGroupings?.forEach(g => g.mediaType && s.add(g.mediaType)));
      return Array.from(s);
    }
    function refreshMediaTypeOptions(){
      const types=getAllMediaTypesFromData();
      const sel=document.getElementById('mediaType'); const cur=sel.value;
      sel.innerHTML = `<option value="">--All--</option>` + types.map(t=>`<option value="${t}">${t}</option>`).join('');
      if (types.includes(cur) || cur==='') sel.value = cur;
    }

    function groupsPresent(){
      // return array of {id,name} present in loaded data
      const map=new Map();
      state.weekData.forEach(d=>{
        d.data?.result?.intradayDataGroupings?.forEach(g=>{
          const id = g.planningGroupId || document.getElementById('planningGroup').value || 'unknown';
          const name = state.planningGroupsMap[id] || document.getElementById('planningGroup').selectedOptions[0]?.text || '(Planning Group)';
          map.set(id,name);
        });
      });
      return Array.from(map, ([id,name])=>({id,name}));
    }

    // ---------- WEEKLY ----------
    function generateWeeklyViewTables(){
      const days=[]; for(let i=0;i<7;i++){ const dt=new Date(state.currentWeekStart); dt.setDate(state.currentWeekStart.getDate()+i); days.push(getUKFormattedDate(dt)); }
      const mtFilter=document.getElementById('mediaType').value;
      const gps = groupsPresent();
      if (gps.length===0) return '<div class="no-data">No planning groups in data.</div>';

      let html='';
      gps.forEach(pg=>{
        html += `
          <div class="table-container" style="margin-bottom:30px;">
            <table>
              <tr class="planning-group-header"><td colspan="${days.length+1}">Planning Group: ${pg.name}${mtFilter?` &nbsp;&nbsp;|&nbsp; Media Type: ${mtFilter}`:''}</td></tr>
              <tr>
                <th></th>
                ${days.map(d=>`<th class="th-dow">${getDOWFromUK(d)}</th>`).join('')}
              </tr>
              <tr>
                <th></th>
                ${days.map(d=>`<th class="th-date">${d}</th>`).join('')}
              </tr>
        `;

        // Offered
        html += `<tr class="data-row"><td>Offered</td>`;
        days.forEach(day=>{
          const dayData=state.weekData.find(x=>x.uk===day);
          const g = dayData?.data?.result?.intradayDataGroupings?.find(h =>
            (!mtFilter || h.mediaType===mtFilter) &&
            (!h.planningGroupId || h.planningGroupId===pg.id || document.getElementById('planningGroup').value!== '__ALL__')
          );
          const val = g?.forecastDataSummary?.offered;
          html += `<td>${Number.isFinite(val)?Math.round(val):'-'}</td>`;
        });
        html += `</tr>`;

        // AHT
        html += `<tr class="data-row"><td>Average Handle Time</td>`;
        days.forEach(day=>{
          const dayData=state.weekData.find(x=>x.uk===day);
          const g = dayData?.data?.result?.intradayDataGroupings?.find(h =>
            (!mtFilter || h.mediaType===mtFilter) &&
            (!h.planningGroupId || h.planningGroupId===pg.id || document.getElementById('planningGroup').value!== '__ALL__')
          );
          const aht = g?.forecastDataSummary?.averageHandleTimeSeconds;
          html += `<td>${formatTime(aht)}</td>`;
        });
        html += `</tr>`;

        // Service Level (summary or fallback)
        html += `<tr class="data-row"><td>Service Level</td>`;
        days.forEach(day=>{
          const dayData=state.weekData.find(x=>x.uk===day);
          const g = dayData?.data?.result?.intradayDataGroupings?.find(h =>
            (!mtFilter || h.mediaType===mtFilter) &&
            (!h.planningGroupId || h.planningGroupId===pg.id || document.getElementById('planningGroup').value!== '__ALL__')
          );
          let sl = g?.performancePredictionDataSummary?.serviceLevelPercent;
          if (sl===null || sl===undefined || sl===0) sl = computePredictionFallback(g).serviceLevelPercent;
          html += `<td>${formatPercentage(sl)}</td>`;
        });
        html += `</tr>`;

        // ASA (summary or fallback)
        html += `<tr class="data-row"><td>Average Speed of Answer</td>`;
        days.forEach(day=>{
          const dayData=state.weekData.find(x=>x.uk===day);
          const g = dayData?.data?.result?.intradayDataGroupings?.find(h =>
            (!mtFilter || h.mediaType===mtFilter) &&
            (!h.planningGroupId || h.planningGroupId===pg.id || document.getElementById('planningGroup').value!== '__ALL__')
          );
          let asa = g?.performancePredictionDataSummary?.averageSpeedOfAnswerSeconds;
          if (asa===null || asa===undefined || asa===0) asa = computePredictionFallback(g).averageSpeedOfAnswerSeconds;
          html += `<td>${formatTime(asa)}</td>`;
        });
        html += `</tr>`;

        html += `</table></div>`;
      });
      return html;
    }

    // ---------- MONTHLY ----------
    function generateMonthlyViewTables(){
      const start = new Date(state.currentMonthStart.getFullYear(), state.currentMonthStart.getMonth(), 1);
      const daysInMonth = new Date(state.currentMonthStart.getFullYear(), state.currentMonthStart.getMonth()+1, 0).getDate();
      const days=[]; for(let d=1; d<=daysInMonth; d++){ const dt=new Date(start.getFullYear(),start.getMonth(),d); days.push(getUKFormattedDate(dt)); }

      const mtFilter=document.getElementById('mediaType').value;
      const gps = groupsPresent();
      if (gps.length===0) return '<div class="no-data">No planning groups in data.</div>';

      let html='';
      gps.forEach(pg=>{
        html += `
          <div class="table-container" style="margin-bottom:30px; overflow-x:auto;">
            <table>
              <tr class="planning-group-header"><td colspan="${days.length+1}">Planning Group: ${pg.name}${mtFilter?` &nbsp;&nbsp;|&nbsp; Media Type: ${mtFilter}`:''}</td></tr>
              <tr>
                <th></th>
                ${days.map(d=>`<th class="th-dow">${getDOWFromUK(d)}</th>`).join('')}
              </tr>
              <tr>
                <th></th>
                ${days.map(d=>`<th class="th-date">${d}</th>`).join('')}
              </tr>
        `;

        // Collect averages from available daily data for fallback
        const available = state.weekData.filter(day => {
          const g = day.data?.result?.intradayDataGroupings?.find(h =>
            (!mtFilter || h.mediaType===mtFilter) &&
            (!h.planningGroupId || h.planningGroupId===pg.id || document.getElementById('planningGroup').value!== '__ALL__')
          );
          return !!g;
        });
        const avg = (getter) => {
          const vals=[]; available.forEach(day=>{
            const g = day.data.result.intradayDataGroupings.find(h =>
              (!mtFilter || h.mediaType===mtFilter) &&
              (!h.planningGroupId || h.planningGroupId===pg.id || document.getElementById('planningGroup').value!== '__ALL__')
            );
            const v=getter(g);
            if (v!==null && v!==undefined) vals.push(v);
          });
          return vals.length ? vals.reduce((a,b)=>a+b,0)/vals.length : null;
        };
        const avgOffered = avg(g=>g?.forecastDataSummary?.offered??null);
        const avgAHT     = avg(g=>g?.forecastDataSummary?.averageHandleTimeSeconds??null);
        const avgSL      = avg(g=> (g?.performancePredictionDataSummary?.serviceLevelPercent ?? computePredictionFallback(g).serviceLevelPercent) );
        const avgASA     = avg(g=> (g?.performancePredictionDataSummary?.averageSpeedOfAnswerSeconds ?? computePredictionFallback(g).averageSpeedOfAnswerSeconds) );

        // Offered
        html += `<tr class="data-row"><td>Offered</td>`;
        days.forEach(day=>{
          const d = state.weekData.find(x=>x.uk===day);
          const g = d?.data?.result?.intradayDataGroupings?.find(h =>
            (!mtFilter || h.mediaType===mtFilter) &&
            (!h.planningGroupId || h.planningGroupId===pg.id || document.getElementById('planningGroup').value!== '__ALL__')
          );
          const v = g?.forecastDataSummary?.offered ?? avgOffered;
          html += `<td>${Number.isFinite(v)?Math.round(v):'-'}</td>`;
        });
        html += `</tr>`;

        // AHT
        html += `<tr class="data-row"><td>Average Handle Time</td>`;
        days.forEach(day=>{
          const d=state.weekData.find(x=>x.uk===day);
          const g=d?.data?.result?.intradayDataGroupings?.find(h =>
            (!mtFilter || h.mediaType===mtFilter) &&
            (!h.planningGroupId || h.planningGroupId===pg.id || document.getElementById('planningGroup').value!== '__ALL__')
          );
          const v = g?.forecastDataSummary?.averageHandleTimeSeconds ?? avgAHT;
          html += `<td>${formatTime(v)}</td>`;
        });
        html += `</tr>`;

        // SL
        html += `<tr class="data-row"><td>Service Level</td>`;
        days.forEach(day=>{
          const d=state.weekData.find(x=>x.uk===day);
          const g=d?.data?.result?.intradayDataGroupings?.find(h =>
            (!mtFilter || h.mediaType===mtFilter) &&
            (!h.planningGroupId || h.planningGroupId===pg.id || document.getElementById('planningGroup').value!== '__ALL__')
          );
          let v = g?.performancePredictionDataSummary?.serviceLevelPercent;
          if (v===null || v===undefined || v===0) v = computePredictionFallback(g).serviceLevelPercent ?? avgSL;
          html += `<td>${formatPercentage(v)}</td>`;
        });
        html += `</tr>`;

        // ASA
        html += `<tr class="data-row"><td>Average Speed of Answer</td>`;
        days.forEach(day=>{
          const d=state.weekData.find(x=>x.uk===day);
          const g=d?.data?.result?.intradayDataGroupings?.find(h =>
            (!mtFilter || h.mediaType===mtFilter) &&
            (!h.planningGroupId || h.planningGroupId===pg.id || document.getElementById('planningGroup').value!== '__ALL__')
          );
          let v = g?.performancePredictionDataSummary?.averageSpeedOfAnswerSeconds;
          if (v===null || v===undefined || v===0) v = computePredictionFallback(g).averageSpeedOfAnswerSeconds ?? avgASA;
          html += `<td>${formatTime(v)}</td>`;
        });
        html += `</tr>`;

        html += `</table></div>`;
      });
      return html;
    }

    // ---------- Daily consolidated (unchanged except small registry fix) ----------
    function renderAllData(){
      renderConsolidatedTable();
      if (document.getElementById('intervalTab').classList.contains('active')) {
        const t=document.querySelector('#intervalTableContainer h3');
        if (t){ const m=t.textContent.match(/for (\d{2}\/\d{2}\/\d{4}) \((.+)\)/); if(m){ const day=state.weekData.find(d=>d.uk===m[1]); if(day) render15MinTable(day,m[2]); } }
      }
    }
    function renderConsolidatedTable(){
      const mediaTypeFilter=document.getElementById('mediaType').value;
      document.getElementById('consolidatedSection').style.display='block';
      let html = `
        <div class="table-container">
          <table class="consolidated-table">
            <thead>
              <tr>
                <th>Date</th><th>Day</th><th>Media Type</th>
                <th colspan="2" class="group-header">Forecast Data</th>
                <th colspan="3" class="group-header">Performance Predictions</th>
                <th>Action</th>
              </tr>
              <tr>
                <th></th><th></th><th></th>
                <th class="sub-header">Offered</th><th class="sub-header">AHT</th>
                <th class="sub-header">Service Level</th><th class="sub-header">ASA</th><th class="sub-header">Occupancy</th>
                <th></th>
              </tr>
            </thead>
            <tbody>
      `;
      const totals={offered:0,aht:0,sl:0,asa:0,occ:0,cnt:0};
      state.weekData.forEach(day=>{
        if(!day.data||!day.data.result) return;
        const gs=day.data.result.intradayDataGroupings||[];
        gs.forEach(g=>{
          if(!g||!g.mediaType) return;
          if(mediaTypeFilter && g.mediaType!==mediaTypeFilter) return;
          const f=g.forecastDataSummary||{}, p=g.performancePredictionDataSummary||{};
          totals.offered += f.offered||0;
          totals.aht     += f.averageHandleTimeSeconds||0;
          const fb=computePredictionFallback(g);
          const sl = (p.serviceLevelPercent ?? fb.serviceLevelPercent) || 0;
          const asa= (p.averageSpeedOfAnswerSeconds ?? fb.averageSpeedOfAnswerSeconds) || 0;
          const occ= (p.occupancyPercent ?? fb.occupancyPercent) || 0;
          totals.sl+=sl; totals.asa+=asa; totals.occ+=occ; totals.cnt++;
        });
      });
      const avgAHT=totals.cnt?totals.aht/totals.cnt:0, avgSL=totals.cnt?totals.sl/totals.cnt:0, avgASA=totals.cnt?totals.asa/totals.cnt:0, avgOcc=totals.cnt?totals.occ/totals.cnt:0;
      html += `
        <tr class="weekly-totals-row">
          <td colspan="3"><strong>Week Totals/Averages</strong></td>
          <td><strong>${Math.round(totals.offered)}</strong></td>
          <td><strong>${formatTime(avgAHT)}</strong></td>
          <td><strong>${formatPercentage(avgSL)}</strong></td>
          <td><strong>${formatTime(avgASA)}</strong></td>
          <td><strong>${formatPercentage(avgOcc)}</strong></td>
          <td></td>
        </tr>
      `;
      state.dayRegistry = [];
      state.weekData.forEach(day=>{
        const dayOfWeek = getDOWFromUK(day.uk);
        if(!day.data||!day.data.result){
          html += `<tr><td>${day.uk}</td><td>${dayOfWeek}</td><td colspan="7" class="no-data">${day.error||'No forecast data available'}</td></tr>`;
          return;
        }
        const gs=day.data.result.intradayDataGroupings||[];
        if(!gs.length){ html += `<tr><td>${day.uk}</td><td>${dayOfWeek}</td><td colspan="7" class="no-data">No forecast data available</td></tr>`; return; }
        gs.forEach(g=>{
          if(!g||!g.mediaType) return;
          if(mediaTypeFilter && g.mediaType!==mediaTypeFilter) return;
          const f=g.forecastDataSummary||{}, p=g.performancePredictionDataSummary||{}, fb=computePredictionFallback(g);
          const offered=f.offered, aht=f.averageHandleTimeSeconds;
          const sl=(p.serviceLevelPercent ?? fb.serviceLevelPercent), asa=(p.averageSpeedOfAnswerSeconds ?? fb.averageSpeedOfAnswerSeconds), occ=(p.occupancyPercent ?? fb.occupancyPercent);
          const isFuture=isFutureDate(day.uk); const rowClass=isFuture?'future-date':'past-date';
          const idx=state.dayRegistry.push({day, mediaType:g.mediaType})-1;
          html += `
            <tr class="${rowClass}">
              <td>${day.uk}</td><td>${dayOfWeek}</td><td>${g.mediaType}</td>
              <td>${Number.isFinite(offered)?Math.round(offered):'-'}</td>
              <td>${formatTime(aht)}</td>
              <td>${formatPercentage(sl)}</td>
              <td>${formatTime(asa)}</td>
              <td>${formatPercentage(occ)}</td>
              <td><button class="view-intervals-btn" data-day-index="${idx}">View Intervals</button></td>
            </tr>
          `;
        });
      });
      html += '</tbody></table></div>';
      document.getElementById('consolidatedTableContainer').innerHTML = html;
    }

    function render15MinTable(day, mediaType){
      let html=`<h3>15-min Intervals for ${day.uk} (${mediaType})</h3><div class="table-container"><table><thead><tr>
        <th>Time</th><th>Forecast Offered</th><th>Forecast AHT</th><th>Scheduled Time</th><th>Service Level</th><th>ASA</th><th>Occupancy</th>
      </tr></thead><tbody>`;
      const g=day.data?.result?.intradayDataGroupings?.find(x=>x.mediaType===mediaType);
      if(!g){ html+='<tr><td colspan="7" class="no-data">No forecast data for selected media type</td></tr>'; }
      else{
        const start=new Date(day.data.result.startDate);
        for(let i=0;i<96;i++){
          const t=new Date(start); t.setMinutes(t.getMinutes()+i*15);
          const timeStr=t.toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'});
          const f=g.forecastDataPerInterval?.[i]||{}, s=g.scheduleDataPerInterval?.[i]||{}, p=g.performancePredictionDataPerInterval?.[i]||{};
          html += `<tr>
            <td>${timeStr}</td>
            <td>${Number.isFinite(f.offered)?Math.round(f.offered*100)/100:'-'}</td>
            <td>${formatTime(f.averageHandleTimeSeconds)}</td>
            <td>${Number.isFinite(s.onQueueTimeSeconds)?formatHours(s.onQueueTimeSeconds):'-'}</td>
            <td>${formatPercentage(p.serviceLevelPercent)}</td>
            <td>${formatTime(p.averageSpeedOfAnswerSeconds)}</td>
            <td>${formatPercentage(p.occupancyPercent)}</td>
          </tr>`;
        }
      }
      html+='</tbody></table></div>';
      document.getElementById('intervalTableContainer').innerHTML=html;
      document.getElementById('intervalTableContainer').className='';
    }

    // ===== Helpers =====
    function isFutureDate(uk){
      const [dd,mm,yyyy]=uk.split('/').map(Number); const d=new Date(yyyy,mm-1,dd); const today=new Date(); today.setHours(0,0,0,0); return d>today;
    }

  </script>
</body>
</html>
