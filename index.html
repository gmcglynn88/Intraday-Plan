<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Intraday Weekly Plan</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    :root {
      --primary-color: #63AB8F;
      --secondary-color: #4A8C7D;
      --border-color: #DEE2E6;
      --light-bg: #F8F9FA;
      --card-bg: #FFFFFF;
      --text-color: #2C3E50;
      --text-light: #6C757D;
    }

    body {
      font-family: 'Aptos', 'Segoe UI', system-ui, -apple-system, Arial, sans-serif;
      margin: 20px;
      padding: 20px;
      max-width: 1400px;
      background: var(--light-bg);
      color: var(--text-color);
    }

    #logo-container {
      text-align: center;
      margin-bottom: 20px;
    }

    #logo {
      width: 300px;
    }

    h1 {
      margin: 0 0 16px;
    }

    .card {
      background: var(--card-bg);
      border: 1px solid var(--border-color);
      border-radius: 12px;
      padding: 24px;
      margin-top: 16px;
      box-shadow: 0 1px 3px rgba(0,0,0,.08);
    }

    label {
      display: block;
      font-weight: 600;
      margin-bottom: 6px;
      font-size: 14px;
    }

    input, select, button, textarea {
      padding: 10px;
      border: 1px solid var(--border-color);
      border-radius: 6px;
      background: #fff;
      font-size: 14px;
      width: 100%;
      box-sizing: border-box;
    }

    button {
      background: var(--primary-color);
      color: #fff;
      font-weight: 600;
      cursor: pointer;
      transition: background .2s;
      border: none;
    }

    button:hover {
      background: var(--secondary-color);
    }

    button:disabled {
      background: var(--text-light);
      cursor: not-allowed;
    }

    .controls {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 20px;
      align-items: end;
    }

    .control-group {
      display: flex;
      flex-direction: column;
      min-height: 82px;
    }

    .full-width-btn {
      width: 100%;
      padding: 14px 18px;
      font-size: 16px;
      margin-top: 0;
    }

    .muted {
      color: var(--text-light);
      font-size: 12px;
      margin-top: 4px;
      line-height: 1.3;
    }

    .section-title {
      margin: 0 0 10px;
      color: var(--secondary-color);
    }

    #messageContainer {
      display: none;
      margin-top: 12px;
    }

    .error-message {
      color: #b4231a;
      background: #fee2e2;
      border: 1px solid #fecaca;
      padding: 10px;
      border-radius: 6px;
    }

    .success-message {
      color: #14532d;
      background: #dcfce7;
      border: 1px solid #bbf7d0;
      padding: 10px;
      border-radius: 6px;
    }

    .info-message {
      color: #6b4e16;
      background: #fff7ed;
      border: 1px solid #ffedd5;
      padding: 10px;
      border-radius: 6px;
    }

    /* Table Styling */
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
      border: 1px solid var(--border-color);
      border-radius: 6px;
      overflow: hidden;
    }

    th, td {
      padding: 10px 12px;
      text-align: left;
      border-bottom: 1px solid var(--border-color);
      vertical-align: middle;
    }

    th {
      background-color: var(--primary-color);
      color: white;
      font-weight: 600;
    }

    tr:hover {
      background-color: rgba(99, 171, 143, 0.05);
    }

    .th-dow {
      background: var(--secondary-color);
      font-weight: 700;
    }

    .th-date {
      background: rgba(99,171,143,.85);
    }

    .consolidated-table th.group-header {
      background-color: var(--secondary-color);
      text-align: center;
    }

    .consolidated-table th.sub-header {
      background-color: rgba(99, 171, 143, 0.8);
    }

    .weekly-totals-row {
      background-color: rgba(99, 171, 143, 0.1);
      font-weight: 600;
    }

    .weekly-totals-row td {
      border-bottom: 2px solid var(--primary-color);
    }

    .future-date {
      background-color: rgba(248, 249, 250, 0.5);
    }

    .past-date {
      opacity: 0.7;
    }

    /* Tab Styling */
    .tab {
      display: inline-block;
      padding: 12px 20px;
      margin-right: 10px;
      background: #eee;
      cursor: pointer;
      border-radius: 6px;
      font-weight: 500;
    }

    .tab.active {
      background: var(--primary-color);
      color: white;
      font-weight: 600;
    }

    .tab-content {
      display: none;
    }

    .tab-content.active {
      display: block;
    }

    .no-data {
      color: var(--text-light);
      font-style: italic;
      text-align: center;
      padding: 20px;
    }

    .loading {
      color: var(--text-light);
      font-style: italic;
      text-align: center;
      padding: 20px;
    }

    .table-container {
      overflow-x: auto;
      margin-top: 20px;
      border: 1px solid var(--border-color);
      border-radius: 6px;
      padding: 1px;
    }

    .metrics-section {
      margin-bottom: 30px;
    }

    .metrics-section h3 {
      color: var(--secondary-color);
      margin-bottom: 15px;
      border-bottom: 2px solid var(--primary-color);
      padding-bottom: 5px;
    }

    /* Weekly/Monthly View Styles */
    .view-controls {
      display: flex;
      gap: 10px;
      margin-bottom: 15px;
      align-items: center;
    }

    .view-controls button {
      padding: 8px 15px;
      width: auto;
    }

    .planning-group-header {
      background-color: #e6f2ff;
      font-weight: bold;
      text-align: left;
    }

    .data-row:nth-child(even) {
      background-color: #f9f9f9;
    }

    /* Calendar Styles */
    .calendar-container {
      position: relative;
    }

    .calendar-input {
      cursor: pointer;
      background: white;
    }

    .calendar-popup {
      position: absolute;
      top: 100%;
      left: 0;
      background: white;
      border: 1px solid var(--border-color);
      border-radius: 6px;
      padding: 15px;
      z-index: 1000;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
      min-width: 300px;
      display: none;
    }

    .calendar-popup.active {
      display: block;
    }

    .calendar-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
    }

    .calendar-grid {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 5px;
    }

    .calendar-day {
      padding: 8px;
      text-align: center;
      cursor: pointer;
      border-radius: 4px;
    }

    .calendar-day:hover {
      background: var(--light-bg);
    }

    .calendar-day.selected {
      background: var(--primary-color);
      color: white;
    }

    .calendar-day.other-month {
      color: var(--text-light);
    }

    .calendar-day.week-start {
      border: 2px solid var(--primary-color);
    }

    /* Chart Styles */
    .chart-container {
      margin: 20px 0;
      padding: 20px;
      background: white;
      border-radius: 8px;
      border: 1px solid var(--border-color);
    }

    .chart-controls {
      display: flex;
      gap: 15px;
      margin-bottom: 20px;
      flex-wrap: wrap;
    }

    .chart-controls select {
      width: auto;
      min-width: 200px;
    }

    /* Multi-select styles */
    .multi-select-container {
      display: flex;
      flex-direction: column;
    }

    .month-checkboxes {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 10px;
      margin-top: 5px;
      max-height: 120px;
      overflow-y: auto;
      border: 1px solid var(--border-color);
      padding: 10px;
      border-radius: 6px;
      background: white;
    }

    .month-checkbox {
      display: flex;
      align-items: center;
      gap: 5px;
    }

    .month-checkbox input {
      width: auto;
    }

    /* Clickable rows */
    .clickable-row {
      cursor: pointer;
    }

    .clickable-row:hover {
      background-color: rgba(99, 171, 143, 0.1) !important;
    }

    /* Responsive adjustments */
    @media (max-width: 768px) {
      body {
        margin: 10px;
        padding: 10px;
      }
      
      .card {
        padding: 16px;
      }
      
      .controls {
        grid-template-columns: 1fr;
        gap: 15px;
      }
      
      .tab {
        padding: 10px 15px;
        font-size: 14px;
      }
      
      .month-checkboxes {
        grid-template-columns: repeat(2, 1fr);
      }
    }
  </style>
</head>
<body>
  <div id="logo-container">
    <img id="logo" src="https://raw.githubusercontent.com/gmcglynn88/Management-Unit-Search/main/Consultinglogo%20(2).png" alt="Company Logo">
  </div>

  <h1>Intraday Weekly Plan - Forecast & Predictions</h1>

  <div id="authCard" class="card">
    <div id="auth-message" class="info-message">Authenticating with PureCloud...</div>
  </div>

  <!-- Debug (shows only when ?debug=1 is in the URL) -->
  <div id="authDebug" class="card" style="display:none">
    <h2 class="section-title">Auth debug</h2>
    <p class="muted">This block appears when you add <code>?debug=1</code> to the page URL.</p>
    <pre id="authDump" class="debug"></pre>
    <button id="signinBtn">Sign in with Genesys</button>
  </div>

  <div id="appContent" style="display:none;">
    <div id="messageContainer"></div>

    <div class="card">
      <h2 class="section-title">Configuration</h2>
      <div class="controls">
        <div class="control-group">
          <label for="businessUnitSelect">Business Unit:</label>
          <select id="businessUnitSelect" disabled>
            <option value="">-- Loading Business Units --</option>
          </select>
        </div>
        <div class="control-group">
          <label for="planningGroup">Planning Group:</label>
          <select id="planningGroup" disabled>
            <option value="">-- Select Business Unit First --</option>
          </select>
          <div class="muted">Choose "All planning groups" to see separate tables per PG.</div>
        </div>
        <div class="control-group calendar-container">
          <label for="weekSelect">Week:</label>
          <input type="text" id="weekSelect" class="calendar-input" placeholder="Click to select week" readonly>
          <div id="calendarPopup" class="calendar-popup">
            <div class="calendar-header">
              <button id="prevMonth">&lt;</button>
              <h4 id="currentMonth">Month Year</h4>
              <button id="nextMonth">&gt;</button>
            </div>
            <div class="calendar-grid" id="calendarGrid"></div>
          </div>
        </div>
        <div class="control-group">
          <label for="mediaType">Media Type:</label>
          <select id="mediaType">
            <option value="">-- All Media Types --</option>
            <option value="Voice">Voice</option>
            <option value="Message">Message</option>
          </select>
        </div>
        <div class="control-group">
          <label>&nbsp;</label>
          <button id="loadDataBtn" class="full-width-btn" disabled>
            Load Forecast Data
          </button>
        </div>
      </div>
    </div>

    <!-- Tabs -->
    <div class="card">
      <div style="margin-bottom: 20px;">
        <div id="tabs">
          <div id="dailyTabButton" class="tab active">Daily Forecast</div>
          <div id="intervalTabButton" class="tab">15-min Intervals</div>
          <div id="comparisonTabButton" class="tab">Comparison View</div>
          <div id="chartsTabButton" class="tab">Charts & Analytics</div>
        </div>
      </div>
      
      <div id="dailyTab" class="tab-content active">
        <h2 class="section-title">Daily Forecast Data</h2>
        <div id="weeklySummary" class="loading">Select a week and click "Load Forecast Data" to view forecast and predictions</div>
        <div class="metrics-section" id="consolidatedSection" style="display: none;">
          <h3>ðŸ“Š Weekly Forecast & Performance Predictions</h3>
          <div id="consolidatedTableContainer"></div>
        </div>
      </div>
      
      <div id="intervalTab" class="tab-content">
        <h2 class="section-title">15-min Interval Data</h2>
        <div id="intervalTableContainer" class="loading">Click on a day in the Daily Forecast tab to view interval data</div>
      </div>

      <div id="comparisonTab" class="tab-content">
        <h2 class="section-title">Comparison View</h2>
        <div class="view-controls">
          <div>
            <label>View Type:</label>
            <select id="comparisonType">
              <option value="weekly">Weekly View</option>
              <option value="monthly">Monthly View</option>
            </select>
          </div>
          <div id="weeklyComparisonControls" class="view-controls">
            <button id="prevWeekBtn">Previous Week</button>
            <span id="weekRangeDisplay"></span>
            <button id="nextWeekBtn">Next Week</button>
          </div>
          <div id="monthlyComparisonControls" class="view-controls" style="display: none;">
            <button id="prevMonthBtn">Previous Month</button>
            <span id="monthRangeDisplay"></span>
            <button id="nextMonthBtn">Next Month</button>
            <div class="multi-select-container">
              <label>Select Months:</label>
              <div class="month-checkboxes" id="monthCheckboxes"></div>
            </div>
          </div>
        </div>
        <div id="comparisonViewContainer" class="loading">Load forecast data to view comparison</div>
      </div>

      <div id="chartsTab" class="tab-content">
        <h2 class="section-title">Charts & Analytics</h2>
        <div class="chart-controls">
          <div>
            <label for="chartMetric">Metric:</label>
            <select id="chartMetric">
              <option value="offered">Offered</option>
              <option value="aht">Average Handle Time</option>
              <option value="serviceLevel">Service Level</option>
              <option value="asa">Average Speed of Answer</option>
              <option value="occupancy">Occupancy</option>
              <option value="staffed">Staffed</option>
            </select>
          </div>
          <div>
            <label for="chartType">Chart Type:</label>
            <select id="chartType">
              <option value="bar">Bar Chart</option>
              <option value="line">Line Chart</option>
            </select>
          </div>
          <div>
            <label for="chartView">View:</label>
            <select id="chartView">
              <option value="daily">Daily View</option>
              <option value="weekly">Weekly Summary</option>
              <option value="monthly">Monthly Summary</option>
            </select>
          </div>
        </div>
        <div class="chart-container">
          <canvas id="metricsChart"></canvas>
        </div>
        <div id="chartsDataContainer" class="loading">Load forecast data to view charts</div>
      </div>
    </div>
  </div>

  <script>
    // ===== Configuration =====
    const CONFIG = {
      clientId: 'fe305808-b368-4547-8af9-325d28d552bb',
      region: 'mypurecloud.ie',
      timeFormat: 'seconds',
      precision: 1
    };

    const DEBUG = new URLSearchParams(window.location.search).has('debug');
    const redirectUri = new URL('.', window.location.href).href;
    const oauthUrl = `https://login.${CONFIG.region}/oauth/authorize?client_id=${encodeURIComponent(CONFIG.clientId)}&response_type=token&redirect_uri=${encodeURIComponent(redirectUri)}&state=intraday`;

    // ===== Application State =====
    const state = {
      accessToken: null,
      weekData: [],
      planningGroupsMap: {},
      selectedWeekStart: null,
      calendarDate: new Date(),
      currentWeekStart: getMonday(new Date()),
      currentMonthStart: new Date(new Date().getFullYear(), new Date().getMonth(), 1),
      selectedMonths: [],
      charts: {},
      selectedDayForIntervals: null
    };

    // ===== Utility Functions =====
    function getMonday(date) {
      const d = new Date(date);
      const day = d.getDay();
      const diff = d.getDate() - day + (day === 0 ? -6 : 1);
      return new Date(d.setDate(diff));
    }

    function formatTime(seconds) {
      if (seconds === null || seconds === undefined) return '-';
      seconds = Math.round(seconds);
      if (CONFIG.timeFormat === 'hms') {
        const h = Math.floor(seconds / 3600);
        const m = Math.floor((seconds % 3600) / 60);
        const s = Math.floor(seconds % 60);
        return h > 0 ? `${h}:${m.toString().padStart(2, '0')}:${s.toString().padStart(2, '0')}` : `${m}:${s.toString().padStart(2, '0')}`;
      }
      return seconds + 's';
    }

    function formatHours(seconds) {
      if (seconds === null || seconds === undefined) return '-';
      return (seconds / 3600).toFixed(CONFIG.precision) + 'h';
    }

    function formatNumber(num) {
      if (num === null || num === undefined) return '-';
      return Number.isFinite(num) ? num.toFixed(CONFIG.precision) : '-';
    }

    function formatPercentage(num) {
      if (num === null || num === undefined) return '-';
      return Number.isFinite(num) ? (num * 100).toFixed(CONFIG.precision) + '%' : '-';
    }

    function getUKFormattedDate(date) {
      const d = date.getDate();
      const m = date.getMonth() + 1;
      const y = date.getFullYear();
      return `${d.toString().padStart(2, '0')}/${m.toString().padStart(2, '0')}/${y}`;
    }

    function getDOWFromUK(ukDate) {
      const [dd, mm, yyyy] = ukDate.split('/').map(Number);
      const dt = new Date(yyyy, mm - 1, dd);
      return dt.toLocaleDateString('en-GB', { weekday: 'short' });
    }

    function isoDate(date) {
      const dt = new Date(date);
      dt.setHours(12, 0, 0, 0);
      const offsetDate = new Date(dt.getTime() - dt.getTimezoneOffset() * 60000);
      return offsetDate.toISOString().split('T')[0];
    }

    function getWeekDates(startDate) {
      const dates = [];
      const start = new Date(startDate);
      for (let i = 0; i < 7; i++) {
        const currentDate = new Date(start);
        currentDate.setDate(start.getDate() + i);
        dates.push({
          raw: isoDate(currentDate),
          uk: getUKFormattedDate(currentDate)
        });
      }
      return dates;
    }

    function getWeeksInMonth(year, month) {
      const weeks = [];
      const firstDay = new Date(year, month, 1);
      const lastDay = new Date(year, month + 1, 0);
      
      let currentWeekStart = getMonday(firstDay);
      
      while (currentWeekStart <= lastDay) {
        const weekEnd = new Date(currentWeekStart);
        weekEnd.setDate(currentWeekStart.getDate() + 6);
        
        // Only include weeks that have at least one day in the current month
        if (weekEnd.getMonth() === month || currentWeekStart.getMonth() === month) {
          weeks.push({
            start: new Date(currentWeekStart),
            end: new Date(weekEnd),
            label: `WC ${getUKFormattedDate(currentWeekStart)}`
          });
        }
        
        currentWeekStart.setDate(currentWeekStart.getDate() + 7);
      }
      
      return weeks;
    }

    function computePredictionFallback(grouping) {
      const per = grouping?.forecastDataPerInterval || [];
      let slSum = 0, slCnt = 0, asaSum = 0, asaCnt = 0, occSum = 0, occCnt = 0;
      
      per.forEach(x => {
        if (!x) return;
        // Check performance prediction data in intervals
        if (x.performancePrediction && x.performancePrediction.serviceLevelPercent !== undefined) { 
          slSum += x.performancePrediction.serviceLevelPercent; 
          slCnt++; 
        }
        if (x.performancePrediction && x.performancePrediction.averageSpeedOfAnswerSeconds !== undefined) { 
          asaSum += x.performancePrediction.averageSpeedOfAnswerSeconds; 
          asaCnt++; 
        }
        if (x.performancePrediction && x.performancePrediction.occupancyPercent !== undefined) { 
          occSum += x.performancePrediction.occupancyPercent; 
          occCnt++; 
        }
      });
      
      return {
        serviceLevelPercent: slCnt ? slSum / slCnt : null,
        averageSpeedOfAnswerSeconds: asaCnt ? asaSum / asaCnt : null,
        occupancyPercent: occCnt ? occSum / occCnt : null
      };
    }

    function getPerformancePredictionData(groupData) {
      // First try to get from performancePredictionDataSummary
      if (groupData.performancePredictionDataSummary) {
        const pred = groupData.performancePredictionDataSummary;
        return {
          serviceLevelPercent: pred.serviceLevelPercent,
          averageSpeedOfAnswerSeconds: pred.averageSpeedOfAnswerSeconds,
          occupancyPercent: pred.occupancyPercent
        };
      }
      
      // If not available, compute from interval data
      return computePredictionFallback(groupData);
    }

    function showMessage(msg, type = 'error', details = '') {
      const box = document.getElementById('messageContainer');
      let html = `<div class="${type}-message">${msg}</div>`;
      
      if (details && DEBUG) {
        html += `<div class="info-message" style="margin-top:8px;">
          <pre style="font-size:11px;overflow:auto;">${JSON.stringify(details, null, 2)}</pre>
        </div>`;
      }
      
      box.innerHTML = html;
      box.style.display = 'block';
      
      if (type === 'success') {
        setTimeout(() => box.style.display = 'none', 5000);
      }
    }

    // ===== Calendar Functions =====
    function initCalendar() {
      const calendarInput = document.getElementById('weekSelect');
      const calendarPopup = document.getElementById('calendarPopup');
      const prevMonthBtn = document.getElementById('prevMonth');
      const nextMonthBtn = document.getElementById('nextMonth');

      calendarInput.addEventListener('click', () => {
        calendarPopup.classList.toggle('active');
        renderCalendar();
      });

      prevMonthBtn.addEventListener('click', () => {
        state.calendarDate.setMonth(state.calendarDate.getMonth() - 1);
        renderCalendar();
      });

      nextMonthBtn.addEventListener('click', () => {
        state.calendarDate.setMonth(state.calendarDate.getMonth() + 1);
        renderCalendar();
      });

      document.addEventListener('click', (e) => {
        if (!calendarInput.contains(e.target) && !calendarPopup.contains(e.target)) {
          calendarPopup.classList.remove('active');
        }
      });
    }

    function renderCalendar() {
      const currentMonthEl = document.getElementById('currentMonth');
      const calendarGrid = document.getElementById('calendarGrid');
      const year = state.calendarDate.getFullYear();
      const month = state.calendarDate.getMonth();
      
      currentMonthEl.textContent = state.calendarDate.toLocaleDateString('en-GB', {
        month: 'long',
        year: 'numeric'
      });

      const firstDay = new Date(year, month, 1);
      const lastDay = new Date(year, month + 1, 0);
      const startDate = new Date(firstDay);
      startDate.setDate(firstDay.getDate() - firstDay.getDay() + (firstDay.getDay() === 0 ? -6 : 1));
      const endDate = new Date(lastDay);
      endDate.setDate(lastDay.getDate() + (7 - lastDay.getDay()) % 7);

      calendarGrid.innerHTML = '';
      
      // Add day headers
      ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'].forEach(day => {
        const header = document.createElement('div');
        header.textContent = day;
        header.style.fontWeight = 'bold';
        header.style.textAlign = 'center';
        calendarGrid.appendChild(header);
      });

      // Add calendar days
      for (let d = new Date(startDate); d <= endDate; d.setDate(d.getDate() + 1)) {
        const dayEl = document.createElement('div');
        dayEl.className = 'calendar-day';
        dayEl.textContent = d.getDate();
        
        if (d.getMonth() !== month) {
          dayEl.classList.add('other-month');
        }

        const dateForClick = new Date(d.getTime());
        dayEl.addEventListener('click', () => selectWeek(dateForClick));

        // Highlight selected week range
        if (state.selectedWeekStart) {
          const weekStart = new Date(state.selectedWeekStart);
          const weekEnd = new Date(weekStart);
          weekEnd.setDate(weekStart.getDate() + 6);
          
          if (dateForClick >= weekStart && dateForClick <= weekEnd) {
            dayEl.style.backgroundColor = 'rgba(99,171,143,.2)';
          }
          
          if (dateForClick.getTime() === weekStart.getTime()) {
            dayEl.classList.add('week-start');
          }
        }
        
        calendarGrid.appendChild(dayEl);
      }
    }

    function selectWeek(date) {
      const selectedDate = new Date(date);
      const dayOfWeek = selectedDate.getDay();
      const diff = selectedDate.getDate() - dayOfWeek + (dayOfWeek === 0 ? -6 : 1);
      const monday = new Date(selectedDate.setDate(diff));

      state.selectedWeekStart = monday.toISOString().split('T')[0];
      state.currentWeekStart = new Date(monday);

      const weekEnd = new Date(monday);
      weekEnd.setDate(monday.getDate() + 6);
      
      document.getElementById('weekSelect').value = `Week ${getUKFormattedDate(monday)} - ${getUKFormattedDate(weekEnd)}`;
      document.getElementById('calendarPopup').classList.remove('active');
      updateLoadButtonState();
    }

    // ===== API Functions =====
    async function fetchPaginatedData(url, options = {}) {
      let allEntities = [];
      let nextUrl = url;
      
      while (nextUrl) {
        const response = await fetch(nextUrl, {
          headers: {
            'Authorization': 'Bearer ' + state.accessToken,
            ...options.headers
          },
          ...options
        });
        
        if (!response.ok) throw new Error(`HTTP ${response.status}`);
        const data = await response.json();
        
        if (data.entities) {
          allEntities = allEntities.concat(data.entities);
        } else if (data.results) {
          allEntities = allEntities.concat(data.results);
        } else {
          return data;
        }
        
        nextUrl = data.nextUri ? `https://api.${CONFIG.region}${data.nextUri}` : null;
      }
      
      return allEntities;
    }

    async function pollIntradayResult(businessUnitId, operationId, { maxAttempts = 12, delayMs = 750 } = {}) {
      for (let i = 1; i <= maxAttempts; i++) {
        const response = await fetch(`https://api.${CONFIG.region}/api/v2/workforcemanagement/businessunits/${businessUnitId}/intraday/${operationId}`, {
          headers: { 'Authorization': 'Bearer ' + state.accessToken }
        });
        
        if (!response.ok) throw new Error(`Polling failed: ${response.status}`);
        const data = await response.json();
        
        if (data.status === 'Complete' && data.result) return data;
        await new Promise(resolve => setTimeout(resolve, delayMs));
      }
      
      throw new Error('Intraday operation timed out');
    }

    // ===== Data Fetching =====
    async function fetchBusinessUnits() {
      try {
        const businessUnits = await fetchPaginatedData(
          `https://api.${CONFIG.region}/api/v2/workforcemanagement/businessunits?pageSize=100`
        );
        
        const select = document.getElementById('businessUnitSelect');
        select.innerHTML = '<option value="">-- Select Business Unit --</option>';
        
        businessUnits.forEach(bu => {
          const option = document.createElement('option');
          option.value = bu.id;
          option.textContent = bu.name;
          select.appendChild(option);
        });
        
        select.disabled = false;
      } catch (error) {
        showMessage('Error loading business units: ' + error.message, 'error');
      }
    }

    async function fetchPlanningGroups(businessUnitId) {
      try {
        const planningGroups = await fetchPaginatedData(
          `https://api.${CONFIG.region}/api/v2/workforcemanagement/businessunits/${businessUnitId}/planninggroups?pageSize=100`
        );
        
        const select = document.getElementById('planningGroup');
        select.innerHTML = '';
        
        // Add "All" option
        const allOption = document.createElement('option');
        allOption.value = '__ALL__';
        allOption.textContent = 'All planning groups';
        select.appendChild(allOption);
        
        // Map and add planning groups
        state.planningGroupsMap = {};
        planningGroups.forEach(pg => {
          state.planningGroupsMap[pg.id] = pg.name;
          const option = document.createElement('option');
          option.value = pg.id;
          option.textContent = pg.name;
          select.appendChild(option);
        });
        
        select.disabled = false;
        updateLoadButtonState();
      } catch (error) {
        showMessage('Error loading planning groups: ' + error.message, 'error');
        document.getElementById('planningGroup').innerHTML = '<option value="">-- Error loading groups --</option>';
      }
    }

    async function fetchIntradayData(date) {
      const businessUnitId = document.getElementById('businessUnitSelect').value;
      const planningGroupId = document.getElementById('planningGroup').value;
      
      if (!businessUnitId) {
        return { date, data: null, error: 'No business unit selected' };
      }
      
      try {
        const requestBody = {
          businessUnitDate: date,
          categories: ["ForecastData", "ScheduleData", "PerformancePredictionData"],
          intervalLengthMinutes: 15
        };
        
        if (planningGroupId && planningGroupId !== '__ALL__') {
          requestBody.planningGroupIds = [planningGroupId];
        }
        
        const response = await fetch(`https://api.${CONFIG.region}/api/v2/workforcemanagement/businessunits/${businessUnitId}/intraday`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': 'Bearer ' + state.accessToken
          },
          body: JSON.stringify(requestBody)
        });
        
        if (!response.ok) {
          if (response.status === 404) {
            return { date, data: null, error: 'No forecast data available for this date' };
          }
          const errorText = await response.text();
          throw new Error(`HTTP ${response.status}: ${errorText}`);
        }
        
        let data = await response.json();
        if (data.status && data.status !== 'Complete' && data.operationId) {
          data = await pollIntradayResult(businessUnitId, data.operationId);
        }
        
        return { date, data };
      } catch (error) {
        return { date, data: null, error: error.message };
      }
    }

    async function fetchDataForWeek(startDate) {
      const days = getWeekDates(startDate);
      showMessage(`Loading forecast data for week starting ${days[0].uk}...`, 'info');
      
      state.weekData = await Promise.all(
        days.map(day => fetchIntradayData(day.raw).then(result => ({ ...result, uk: day.uk })))
      );
      
      refreshMediaTypeOptions();
      renderAllData();
      showMessage('Forecast data loaded successfully!', 'success');
    }

    // ===== UI Event Handlers =====
    function onBusinessUnitChange() {
      const businessUnitId = this.value;
      const planningGroupSelect = document.getElementById('planningGroup');
      
      planningGroupSelect.innerHTML = '<option value="">-- Loading Planning Groups --</option>';
      planningGroupSelect.disabled = true;
      document.getElementById('loadDataBtn').disabled = true;
      
      if (businessUnitId) {
        fetchPlanningGroups(businessUnitId);
      } else {
        planningGroupSelect.innerHTML = '<option value="">-- Select Business Unit First --</option>';
      }
    }

    function onPlanningGroupChange() {
      updateLoadButtonState();
    }

    function onConfigChange() {
      if (state.weekData.length > 0) {
        renderAllData();
        updateComparisonViewDisplay();
        updateCharts();
      }
    }

    function updateLoadButtonState() {
      const businessUnitId = document.getElementById('businessUnitSelect').value;
      const planningGroupId = document.getElementById('planningGroup').value;
      const weekSelected = state.selectedWeekStart;
      
      document.getElementById('loadDataBtn').disabled = !(businessUnitId && planningGroupId && weekSelected);
    }

    function loadData() {
      const weekStart = state.selectedWeekStart;
      if (!weekStart) return;
      
      document.getElementById('weeklySummary').className = 'loading';
      document.getElementById('weeklySummary').textContent = 'Loading forecast data...';
      document.getElementById('loadDataBtn').disabled = true;
      document.getElementById('loadDataBtn').textContent = 'Loading...';
      document.getElementById('consolidatedSection').style.display = 'none';
      
      fetchDataForWeek(weekStart).finally(() => {
        document.getElementById('loadDataBtn').disabled = false;
        document.getElementById('loadDataBtn').textContent = 'Load Forecast Data';
        updateComparisonViewDisplay();
        updateCharts();
      });
    }

    function setActiveTab(tabName) {
      // Update tab buttons
      document.getElementById('dailyTabButton').classList.toggle('active', tabName === 'daily');
      document.getElementById('intervalTabButton').classList.toggle('active', tabName === 'interval');
      document.getElementById('comparisonTabButton').classList.toggle('active', tabName === 'comparison');
      document.getElementById('chartsTabButton').classList.toggle('active', tabName === 'charts');
      
      // Update tab content
      document.getElementById('dailyTab').classList.toggle('active', tabName === 'daily');
      document.getElementById('intervalTab').classList.toggle('active', tabName === 'interval');
      document.getElementById('comparisonTab').classList.toggle('active', tabName === 'comparison');
      document.getElementById('chartsTab').classList.toggle('active', tabName === 'charts');

      if (tabName === 'charts') {
        updateCharts();
      }
    }

    // ===== Navigation Functions =====
    async function navigatePrevWeek() {
      state.currentWeekStart.setDate(state.currentWeekStart.getDate() - 7);
      await fetchDataForWeek(isoDate(state.currentWeekStart));
      updateComparisonViewDisplay();
    }

    async function navigateNextWeek() {
      state.currentWeekStart.setDate(state.currentWeekStart.getDate() + 7);
      await fetchDataForWeek(isoDate(state.currentWeekStart));
      updateComparisonViewDisplay();
    }

    async function navigatePrevMonth() {
      state.currentMonthStart.setMonth(state.currentMonthStart.getMonth() - 1);
      updateComparisonViewDisplay();
    }

    async function navigateNextMonth() {
      state.currentMonthStart.setMonth(state.currentMonthStart.getMonth() + 1);
      updateComparisonViewDisplay();
    }

    // ===== Data Rendering Functions =====
    function renderAllData() {
      renderConsolidatedTable();
      updateComparisonViewDisplay();
      updateCharts();
    }

    function renderConsolidatedTable() {
      const container = document.getElementById('consolidatedTableContainer');
      const mediaTypeFilter = document.getElementById('mediaType').value;
      const planningGroups = groupsPresent();
      
      if (planningGroups.length === 0) {
        container.innerHTML = '<div class="no-data">No planning groups in data.</div>';
        document.getElementById('consolidatedSection').style.display = 'none';
        return;
      }

      let html = '';
      
      planningGroups.forEach(group => {
        html += `
          <div class="table-container" style="margin-bottom:30px;">
            <table class="consolidated-table">
              <tr>
                <th colspan="8" class="group-header">Planning Group: ${group.name}${mediaTypeFilter ? ` &nbsp;&nbsp;|&nbsp; Media Type: ${mediaTypeFilter}` : ''}</th>
              </tr>
              <tr>
                <th class="sub-header">Day</th>
                <th class="sub-header">Date</th>
                <th class="sub-header">Offered</th>
                <th class="sub-header">Avg Handle Time</th>
                <th class="sub-header">Service Level</th>
                <th class="sub-header">Avg Speed Answer</th>
                <th class="sub-header">Occupancy</th>
                <th class="sub-header">Staffed</th>
              </tr>
        `;

        let weeklyTotals = { offered: 0, aht: 0, sl: 0, slCount: 0, asa: 0, asaCount: 0, occupancy: 0, occupancyCount: 0, staffed: 0 };
        let dayCount = 0;

        state.weekData.forEach(day => {
          const groupData = day.data?.result?.intradayDataGroupings?.find(g =>
            (!mediaTypeFilter || g.mediaType === mediaTypeFilter) &&
            (!g.planningGroupId || g.planningGroupId === group.id || document.getElementById('planningGroup').value !== '__ALL__')
          );

          if (groupData) {
            // Get forecast data
            const forecast = groupData.forecastDataSummary || {};
            // Get performance prediction data
            const prediction = getPerformancePredictionData(groupData);
            
            const offered = forecast.offered || 0;
            const aht = forecast.averageHandleTimeSeconds || 0;
            const sl = prediction.serviceLevelPercent;
            const asa = prediction.averageSpeedOfAnswerSeconds;
            const occupancy = prediction.occupancyPercent;
            const staffed = forecast.staffed || 0;

            weeklyTotals.offered += offered;
            weeklyTotals.aht += aht;
            if (sl !== null && sl !== undefined) {
              weeklyTotals.sl += sl;
              weeklyTotals.slCount++;
            }
            if (asa !== null && asa !== undefined) {
              weeklyTotals.asa += asa;
              weeklyTotals.asaCount++;
            }
            if (occupancy !== null && occupancy !== undefined) {
              weeklyTotals.occupancy += occupancy;
              weeklyTotals.occupancyCount++;
            }
            weeklyTotals.staffed += staffed;
            dayCount++;

            html += `
              <tr class="clickable-row" data-date="${day.uk}">
                <td>${getDOWFromUK(day.uk)}</td>
                <td>${day.uk}</td>
                <td>${formatNumber(offered)}</td>
                <td>${formatTime(aht)}</td>
                <td>${formatPercentage(sl)}</td>
                <td>${formatTime(asa)}</td>
                <td>${formatPercentage(occupancy)}</td>
                <td>${formatNumber(staffed)}</td>
              </tr>
            `;
          }
        });

        // Add weekly TOTALS (not averages)
        if (dayCount > 0) {
          html += `
            <tr class="weekly-totals-row">
              <td colspan="2"><strong>Weekly Total</strong></td>
              <td><strong>${formatNumber(weeklyTotals.offered)}</strong></td>
              <td><strong>${formatTime(weeklyTotals.aht)}</strong></td>
              <td><strong>${formatPercentage(weeklyTotals.slCount > 0 ? weeklyTotals.sl / weeklyTotals.slCount : null)}</strong></td>
              <td><strong>${formatTime(weeklyTotals.asaCount > 0 ? weeklyTotals.asa / weeklyTotals.asaCount : null)}</strong></td>
              <td><strong>${formatPercentage(weeklyTotals.occupancyCount > 0 ? weeklyTotals.occupancy / weeklyTotals.occupancyCount : null)}</strong></td>
              <td><strong>${formatNumber(weeklyTotals.staffed)}</strong></td>
            </tr>
          `;
        }

        html += `</table></div>`;
      });

      container.innerHTML = html;
      document.getElementById('consolidatedSection').style.display = 'block';
      document.getElementById('weeklySummary').style.display = 'none';

      // Add click handlers for interval view
      document.querySelectorAll('.clickable-row').forEach(row => {
        row.addEventListener('click', function() {
          const date = this.getAttribute('data-date');
          showIntervalData(date);
        });
      });
    }

    function showIntervalData(date) {
      state.selectedDayForIntervals = date;
      setActiveTab('interval');
      render15MinTable(date);
    }

    function render15MinTable(date) {
      const container = document.getElementById('intervalTableContainer');
      const mediaTypeFilter = document.getElementById('mediaType').value;
      
      if (!date) {
        container.innerHTML = '<div class="no-data">Click on a day in the Daily Forecast tab to view interval data</div>';
        return;
      }

      const dayData = state.weekData.find(d => d.uk === date);
      if (!dayData || !dayData.data?.result?.intradayDataGroupings) {
        container.innerHTML = '<div class="no-data">No interval data available for this date</div>';
        return;
      }

      const planningGroups = groupsPresent();
      let html = `<h3>15-minute Interval Data for ${date}</h3>`;
      
      planningGroups.forEach(group => {
        const groupData = dayData.data.result.intradayDataGroupings.find(g =>
          (!mediaTypeFilter || g.mediaType === mediaTypeFilter) &&
          (!g.planningGroupId || g.planningGroupId === group.id || document.getElementById('planningGroup').value !== '__ALL__')
        );

        if (groupData && groupData.forecastDataPerInterval) {
          html += `
            <div class="table-container" style="margin-bottom:30px;">
              <table class="consolidated-table">
                <tr>
                  <th colspan="7" class="group-header">Planning Group: ${group.name} - 15-min Intervals</th>
                </tr>
                <tr>
                  <th class="sub-header">Time</th>
                  <th class="sub-header">Offered</th>
                  <th class="sub-header">Avg Handle Time</th>
                  <th class="sub-header">Service Level</th>
                  <th class="sub-header">Avg Speed Answer</th>
                  <th class="sub-header">Occupancy</th>
                  <th class="sub-header">Staffed</th>
                </tr>
          `;

          groupData.forecastDataPerInterval.forEach(interval => {
            const forecast = interval.forecast || {};
            const prediction = interval.performancePrediction || {};
            
            const time = interval.time || '';
            const offered = forecast.offered || 0;
            const aht = forecast.averageHandleTimeSeconds || 0;
            const sl = prediction.serviceLevelPercent;
            const asa = prediction.averageSpeedOfAnswerSeconds;
            const occupancy = prediction.occupancyPercent;
            const staffed = forecast.staffed || 0;

            html += `
              <tr>
                <td>${time}</td>
                <td>${formatNumber(offered)}</td>
                <td>${formatTime(aht)}</td>
                <td>${formatPercentage(sl)}</td>
                <td>${formatTime(asa)}</td>
                <td>${formatPercentage(occupancy)}</td>
                <td>${formatNumber(staffed)}</td>
              </tr>
            `;
          });

          html += `</table></div>`;
        }
      });

      if (html === `<h3>15-minute Interval Data for ${date}</h3>`) {
        html += '<div class="no-data">No interval data available for this date and planning group</div>';
      }

      container.innerHTML = html;
    }

    function getAllMediaTypesFromData() {
      const mediaTypes = new Set();
      state.weekData.forEach(day => {
        day.data?.result?.intradayDataGroupings?.forEach(group => {
          if (group.mediaType) mediaTypes.add(group.mediaType);
        });
      });
      return Array.from(mediaTypes);
    }

    function refreshMediaTypeOptions() {
      const mediaTypes = getAllMediaTypesFromData();
      const select = document.getElementById('mediaType');
      const currentValue = select.value;
      
      select.innerHTML = `<option value="">-- All Media Types --</option>` + 
        mediaTypes.map(type => `<option value="${type}">${type}</option>`).join('');
      
      if (mediaTypes.includes(currentValue) || currentValue === '') {
        select.value = currentValue;
      }
    }

    function groupsPresent() {
      const groupsMap = new Map();
      
      state.weekData.forEach(day => {
        day.data?.result?.intradayDataGroupings?.forEach(group => {
          const id = group.planningGroupId || document.getElementById('planningGroup').value || 'unknown';
          const name = state.planningGroupsMap[id] || 
            document.getElementById('planningGroup').selectedOptions[0]?.text || '(Planning Group)';
          groupsMap.set(id, name);
        });
      });
      
      return Array.from(groupsMap, ([id, name]) => ({ id, name }));
    }

    // ===== Comparison View Functions =====
    function updateComparisonViewDisplay() {
      const comparisonType = document.getElementById('comparisonType').value;
      const container = document.getElementById('comparisonViewContainer');
      
      if (comparisonType === 'weekly') {
        document.getElementById('weeklyComparisonControls').style.display = 'flex';
        document.getElementById('monthlyComparisonControls').style.display = 'none';
        renderWeeklyComparison();
      } else {
        document.getElementById('weeklyComparisonControls').style.display = 'none';
        document.getElementById('monthlyComparisonControls').style.display = 'flex';
        renderMonthlyComparison();
      }
    }

    function renderWeeklyComparison() {
      const container = document.getElementById('comparisonViewContainer');
      const weekStart = state.currentWeekStart;
      const weekEnd = new Date(weekStart);
      weekEnd.setDate(weekStart.getDate() + 6);
      
      document.getElementById('weekRangeDisplay').textContent = 
        `Week of ${getUKFormattedDate(weekStart)} - ${getUKFormattedDate(weekEnd)}`;
      
      if (state.weekData.length === 0) {
        container.innerHTML = '<div class="no-data">Load forecast data to view weekly comparison</div>';
        return;
      }
      
      // Same as daily view but for comparison
      renderConsolidatedTableForComparison(container);
    }

    function renderMonthlyComparison() {
      const container = document.getElementById('comparisonViewContainer');
      const monthStart = state.currentMonthStart;
      
      document.getElementById('monthRangeDisplay').textContent = 
        `${monthStart.toLocaleString('en-GB', { month: 'long', year: 'numeric' })}`;
      
      // Generate month checkboxes
      updateMonthCheckboxes();
      
      if (state.weekData.length === 0) {
        container.innerHTML = '<div class="no-data">Load forecast data to view monthly comparison</div>';
        return;
      }
      
      container.innerHTML = '<div class="no-data">Monthly comparison view - select months to compare</div>';
    }

    function updateMonthCheckboxes() {
      const container = document.getElementById('monthCheckboxes');
      const months = [];
      const currentDate = new Date();
      
      // Generate next 6 months
      for (let i = -2; i <= 3; i++) {
        const date = new Date(currentDate.getFullYear(), currentDate.getMonth() + i, 1);
        months.push({
          label: date.toLocaleString('en-GB', { month: 'long', year: 'numeric' }),
          value: `${date.getFullYear()}-${date.getMonth() + 1}`
        });
      }
      
      container.innerHTML = months.map(month => `
        <div class="month-checkbox">
          <input type="checkbox" id="month-${month.value}" value="${month.value}" 
                 ${month.value === `${currentDate.getFullYear()}-${currentDate.getMonth() + 1}` ? 'checked' : ''}>
          <label for="month-${month.value}">${month.label}</label>
        </div>
      `).join('');
      
      // Add event listeners
      container.querySelectorAll('input[type="checkbox"]').forEach(checkbox => {
        checkbox.addEventListener('change', updateSelectedMonths);
      });
      
      updateSelectedMonths();
    }

    function updateSelectedMonths() {
      const checkboxes = document.querySelectorAll('#monthCheckboxes input[type="checkbox"]:checked');
      state.selectedMonths = Array.from(checkboxes).map(cb => cb.value);
      // Here you would fetch data for selected months
    }

    function renderConsolidatedTableForComparison(container) {
      const mediaTypeFilter = document.getElementById('mediaType').value;
      const planningGroups = groupsPresent();
      
      if (planningGroups.length === 0) {
        container.innerHTML = '<div class="no-data">No planning groups in data.</div>';
        return;
      }

      let html = '';
      
      planningGroups.forEach(group => {
        html += `
          <div class="table-container" style="margin-bottom:30px;">
            <table class="consolidated-table">
              <tr>
                <th colspan="8" class="group-header">Planning Group: ${group.name}${mediaTypeFilter ? ` &nbsp;&nbsp;|&nbsp; Media Type: ${mediaTypeFilter}` : ''}</th>
              </tr>
              <tr>
                <th class="sub-header">Day</th>
                <th class="sub-header">Date</th>
                <th class="sub-header">Offered</th>
                <th class="sub-header">Avg Handle Time</th>
                <th class="sub-header">Service Level</th>
                <th class="sub-header">Avg Speed Answer</th>
                <th class="sub-header">Occupancy</th>
                <th class="sub-header">Staffed</th>
              </tr>
        `;

        let weeklyTotals = { offered: 0, aht: 0, sl: 0, slCount: 0, asa: 0, asaCount: 0, occupancy: 0, occupancyCount: 0, staffed: 0 };
        let dayCount = 0;

        state.weekData.forEach(day => {
          const groupData = day.data?.result?.intradayDataGroupings?.find(g =>
            (!mediaTypeFilter || g.mediaType === mediaTypeFilter) &&
            (!g.planningGroupId || g.planningGroupId === group.id || document.getElementById('planningGroup').value !== '__ALL__')
          );

          if (groupData) {
            const forecast = groupData.forecastDataSummary || {};
            const prediction = getPerformancePredictionData(groupData);
            
            const offered = forecast.offered || 0;
            const aht = forecast.averageHandleTimeSeconds || 0;
            const sl = prediction.serviceLevelPercent;
            const asa = prediction.averageSpeedOfAnswerSeconds;
            const occupancy = prediction.occupancyPercent;
            const staffed = forecast.staffed || 0;

            weeklyTotals.offered += offered;
            weeklyTotals.aht += aht;
            if (sl !== null && sl !== undefined) {
              weeklyTotals.sl += sl;
              weeklyTotals.slCount++;
            }
            if (asa !== null && asa !== undefined) {
              weeklyTotals.asa += asa;
              weeklyTotals.asaCount++;
            }
            if (occupancy !== null && occupancy !== undefined) {
              weeklyTotals.occupancy += occupancy;
              weeklyTotals.occupancyCount++;
            }
            weeklyTotals.staffed += staffed;
            dayCount++;

            html += `
              <tr>
                <td>${getDOWFromUK(day.uk)}</td>
                <td>${day.uk}</td>
                <td>${formatNumber(offered)}</td>
                <td>${formatTime(aht)}</td>
                <td>${formatPercentage(sl)}</td>
                <td>${formatTime(asa)}</td>
                <td>${formatPercentage(occupancy)}</td>
                <td>${formatNumber(staffed)}</td>
              </tr>
            `;
          }
        });

        // Add weekly TOTALS
        if (dayCount > 0) {
          html += `
            <tr class="weekly-totals-row">
              <td colspan="2"><strong>Weekly Total</strong></td>
              <td><strong>${formatNumber(weeklyTotals.offered)}</strong></td>
              <td><strong>${formatTime(weeklyTotals.aht)}</strong></td>
              <td><strong>${formatPercentage(weeklyTotals.slCount > 0 ? weeklyTotals.sl / weeklyTotals.slCount : null)}</strong></td>
              <td><strong>${formatTime(weeklyTotals.asaCount > 0 ? weeklyTotals.asa / weeklyTotals.asaCount : null)}</strong></td>
              <td><strong>${formatPercentage(weeklyTotals.occupancyCount > 0 ? weeklyTotals.occupancy / weeklyTotals.occupancyCount : null)}</strong></td>
              <td><strong>${formatNumber(weeklyTotals.staffed)}</strong></td>
            </tr>
          `;
        }

        html += `</table></div>`;
      });

      container.innerHTML = html;
    }

    // ===== Chart Functions =====
    function updateCharts() {
      if (state.weekData.length === 0) {
        document.getElementById('chartsDataContainer').innerHTML = '<div class="no-data">Load forecast data to view charts</div>';
        return;
      }

      const metric = document.getElementById('chartMetric').value;
      const chartType = document.getElementById('chartType').value;
      const chartView = document.getElementById('chartView').value;
      
      renderChart(metric, chartType, chartView);
    }

    function renderChart(metric, chartType, chartView) {
      const ctx = document.getElementById('metricsChart').getContext('2d');
      
      // Destroy existing chart
      if (state.charts.metrics) {
        state.charts.metrics.destroy();
      }

      const mediaTypeFilter = document.getElementById('mediaType').value;
      const planningGroups = groupsPresent();
      
      if (planningGroups.length === 0) {
        return;
      }

      // For simplicity, use first planning group
      const group = planningGroups[0];
      const labels = [];
      const data = [];

      if (chartView === 'daily') {
        state.weekData.forEach(day => {
          const groupData = day.data?.result?.intradayDataGroupings?.find(g =>
            (!mediaTypeFilter || g.mediaType === mediaTypeFilter) &&
            (!g.planningGroupId || g.planningGroupId === group.id || document.getElementById('planningGroup').value !== '__ALL__')
          );

          if (groupData) {
            const forecast = groupData.forecastDataSummary || {};
            const prediction = getPerformancePredictionData(groupData);
            
            labels.push(`${getDOWFromUK(day.uk)} ${day.uk}`);
            
            let value;
            switch (metric) {
              case 'offered': value = forecast.offered || 0; break;
              case 'aht': value = forecast.averageHandleTimeSeconds || 0; break;
              case 'serviceLevel': value = prediction.serviceLevelPercent || 0; break;
              case 'asa': value = prediction.averageSpeedOfAnswerSeconds || 0; break;
              case 'occupancy': value = prediction.occupancyPercent || 0; break;
              case 'staffed': value = forecast.staffed || 0; break;
              default: value = 0;
            }
            
            data.push(value);
          }
        });
      }

      const chartConfig = {
        type: chartType,
        data: {
          labels: labels,
          datasets: [{
            label: getMetricLabel(metric),
            data: data,
            backgroundColor: chartType === 'bar' ? 'rgba(99, 171, 143, 0.8)' : 'rgba(99, 171, 143, 1)',
            borderColor: 'rgba(99, 171, 143, 1)',
            borderWidth: 2,
            fill: chartType === 'line'
          }]
        },
        options: {
          responsive: true,
          plugins: {
            title: {
              display: true,
              text: `${getMetricLabel(metric)} - ${chartView} View`
            }
          },
          scales: {
            y: {
              beginAtZero: true
            }
          }
        }
      };

      state.charts.metrics = new Chart(ctx, chartConfig);
      document.getElementById('chartsDataContainer').innerHTML = '';
    }

    function getMetricLabel(metric) {
      const labels = {
        offered: 'Offered',
        aht: 'Average Handle Time',
        serviceLevel: 'Service Level %',
        asa: 'Average Speed of Answer',
        occupancy: 'Occupancy %',
        staffed: 'Staffed'
      };
      return labels[metric] || metric;
    }

    // ===== Authentication =====
    document.addEventListener('DOMContentLoaded', () => {
      const hash = window.location.hash.substring(1);
      const params = new URLSearchParams(hash);
      const queryParams = new URLSearchParams(window.location.search);

      const oauthError = params.get('error') || queryParams.get('error');
      const oauthErrorDesc = params.get('error_description') || queryParams.get('error_description');

      if (oauthError) {
        document.getElementById('auth-message').textContent = `OAuth error: ${oauthErrorDesc || oauthError}`;
        document.getElementById('auth-message').className = 'error-message';
        if (DEBUG) showDebugCard();
        return;
      }

      const tokenFromHash = params.get('access_token');
      const tokenFromSession = sessionStorage.getItem('purecloud_token');

      if (tokenFromHash) {
        state.accessToken = tokenFromHash;
        sessionStorage.setItem('purecloud_token', state.accessToken);
        history.replaceState(null, '', window.location.href.split('#')[0]);
        initializeApplication();
      } else if (tokenFromSession) {
        state.accessToken = tokenFromSession;
        initializeApplication();
      } else {
        if (DEBUG) showDebugCard();
        else window.location.href = oauthUrl;
      }
    });

    function showDebugCard() {
      const debugInfo = {
        clientId: CONFIG.clientId,
        redirectUri: redirectUri,
        oauthUrl: oauthUrl,
        region: CONFIG.region
      };
      
      document.getElementById('authDebug').style.display = 'block';
      document.getElementById('authDump').textContent = JSON.stringify(debugInfo, null, 2);
      document.getElementById('signinBtn').onclick = () => location.href = oauthUrl;
      document.getElementById('auth-message').textContent = 'Debug mode: click "Sign in with Genesys".';
      document.getElementById('auth-message').className = 'info-message';
    }

    function initializeApplication() {
      document.getElementById('auth-message').textContent = 'Authenticated successfully!';
      document.getElementById('auth-message').className = 'success-message';
      
      setTimeout(() => {
        document.getElementById('authCard').style.display = 'none';
        document.getElementById('authDebug').style.display = 'none';
      }, 1200);

      document.getElementById('appContent').style.display = 'block';
      initializeApp();
    }

    function initializeApp() {
      // Set up event listeners
      document.getElementById('businessUnitSelect').addEventListener('change', onBusinessUnitChange);
      document.getElementById('planningGroup').addEventListener('change', onPlanningGroupChange);
      document.getElementById('mediaType').addEventListener('change', onConfigChange);
      document.getElementById('loadDataBtn').addEventListener('click', loadData);
      
      // Tab navigation
      document.getElementById('dailyTabButton').addEventListener('click', () => setActiveTab('daily'));
      document.getElementById('intervalTabButton').addEventListener('click', () => setActiveTab('interval'));
      document.getElementById('comparisonTabButton').addEventListener('click', () => setActiveTab('comparison'));
      document.getElementById('chartsTabButton').addEventListener('click', () => setActiveTab('charts'));
      
      // Comparison view controls
      document.getElementById('comparisonType').addEventListener('change', updateComparisonViewDisplay);
      document.getElementById('prevWeekBtn').addEventListener('click', navigatePrevWeek);
      document.getElementById('nextWeekBtn').addEventListener('click', navigateNextWeek);
      document.getElementById('prevMonthBtn').addEventListener('click', navigatePrevMonth);
      document.getElementById('nextMonthBtn').addEventListener('click', navigateNextMonth);
      
      // Chart controls
      document.getElementById('chartMetric').addEventListener('change', updateCharts);
      document.getElementById('chartType').addEventListener('change', updateCharts);
      document.getElementById('chartView').addEventListener('change', updateCharts);

      // Initialize components
      initCalendar();
      fetchBusinessUnits();

      // Set default week to current week
      const today = new Date();
      const dayOfWeek = today.getDay();
      const diff = today.getDate() - dayOfWeek + (dayOfWeek === 0 ? -6 : 1);
      const monday = new Date(today.setDate(diff));
      selectWeek(monday);

      // Initialize view displays
      updateComparisonViewDisplay();
    }
  </script>
</body>
</html>
