<!DOCTYPE html>
<html>
<head>
  <title>Intraday Weekly Plan</title>
  <meta charset="UTF-8">
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    .container { margin-bottom: 20px; }
    table { width: 100%; border-collapse: collapse; margin-bottom: 20px; }
    th, td { border: 1px solid #ccc; padding: 8px; text-align: left; }
    th { background: #f0f0f0; }
    .tab {
      display: inline-block;
      padding: 10px;
      margin-right: 10px;
      background: #eee;
      cursor: pointer;
    }
    .tab.active {
      background: #ddd;
      font-weight: bold;
    }
    .tab-content {
      display: none;
    }
    .tab-content.active {
      display: block;
    }
    .no-data { color: #999; font-style: italic; }
    button {
      padding: 5px 10px;
      background: #4CAF50;
      color: white;
      border: none;
      border-radius: 3px;
      cursor: pointer;
    }
    button:hover {
      background: #45a049;
    }
    .summary-table {
      width: 100%;
      border-collapse: collapse;
      margin-bottom: 20px;
    }
    .summary-table th, .summary-table td {
      padding: 8px;
      text-align: left;
      border: 1px solid #ccc;
    }
    .summary-table th {
      background: #f0f0f0;
    }
    select {
      padding: 5px;
      min-width: 200px;
    }
    .loading {
      color: #666;
      font-style: italic;
    }
  </style>
</head>
<body>
  <h1>Intraday Weekly Plan</h1>

  <!-- Business Unit Dropdown -->
  <div class="container">
    <label for="businessUnitSelect">Select Business Unit:</label>
    <select id="businessUnitSelect" disabled>
      <option value="">-- Loading Business Units --</option>
    </select>
  </div>

  <!-- Planning Group Dropdown -->
  <div class="container">
    <label for="planningGroup">Select Planning Group:</label>
    <select id="planningGroup" disabled>
      <option value="">-- Select Business Unit First --</option>
    </select>
  </div>

  <!-- Week Selection Dropdown -->
  <div class="container">
    <label for="weekSelect">Select Week:</label>
    <select id="weekSelect" disabled>
      <option value="">-- Loading Weeks --</option>
    </select>
  </div>

  <!-- Media Type Dropdown -->
  <div class="container">
    <label for="mediaType">Media Type:</label>
    <select id="mediaType">
      <option value="">--All--</option>
      <option value="Voice">Voice</option>
      <option value="Message">Message</option>
    </select>
  </div>

  <!-- Tab Navigation -->
  <div class="container">
    <div id="tabs">
      <div id="dailyTabButton" class="tab active">Daily Data</div>
      <div id="intervalTabButton" class="tab">15-min Intervals</div>
    </div>
    <div id="dailyTab" class="tab-content active">
      <h2>Daily Data</h2>
      <div id="weeklySummary" class="loading">Select a week to view data</div>
      <div id="dailyTableContainer"></div>
    </div>
    <div id="intervalTab" class="tab-content">
      <h2>15-min Interval Data</h2>
      <div id="intervalTableContainer" class="loading">Select a day to view interval data</div>
    </div>
  </div>

  <script>
    // Simple configuration
    const config = {
      timeFormat: 'seconds', // 'seconds' or 'hms'
      precision: 1,          // decimal places
      CLIENT_ID: '256876c6-470d-4304-8e7d-2038f8a55d95',
      REGION: 'mypurecloud.ie'
    };

    // State management
    const state = {
      accessToken: null,
      planningGroupName: '',
      weekData: []
    };

    // Initialize the application
    document.addEventListener('DOMContentLoaded', function() {
      // First check for access token in URL hash
      const hashParams = window.location.hash.substring(1).split('&').reduce(function(result, item) {
        const parts = item.split('=');
        result[parts[0]] = parts[1];
        return result;
      }, {});

      if (hashParams.access_token) {
        state.accessToken = hashParams.access_token;
        window.history.replaceState({}, document.title, window.location.pathname);
        initializeApp();
      } else {
        // Redirect to auth if no token
        const redirectUri = encodeURIComponent(window.location.href.split('?')[0].split('#')[0]);
        window.location.href = `https://login.${config.REGION}/oauth/authorize?response_type=token&client_id=${config.CLIENT_ID}&redirect_uri=${redirectUri}`;
      }
    });

    function initializeApp() {
      // Set up event listeners
      document.getElementById('businessUnitSelect').addEventListener('change', onBusinessUnitChange);
      document.getElementById('planningGroup').addEventListener('change', onPlanningGroupChange);
      document.getElementById('weekSelect').addEventListener('change', onWeekSelectChange);
      document.getElementById('mediaType').addEventListener('change', renderDailyTable);
      document.getElementById('dailyTabButton').addEventListener('click', () => setActiveTab('daily'));
      document.getElementById('intervalTabButton').addEventListener('click', () => setActiveTab('interval'));

      // Load initial data
      fetchBusinessUnits();
      populateWeekSelect();
    }

    function onBusinessUnitChange() {
      const buId = this.value;
      const planningGroupSelect = document.getElementById('planningGroup');
      
      planningGroupSelect.innerHTML = '<option value="">-- Loading Planning Groups --</option>';
      planningGroupSelect.disabled = true;
      
      if (buId) {
        fetchPlanningGroups(buId);
      } else {
        planningGroupSelect.innerHTML = '<option value="">-- Select Business Unit First --</option>';
        planningGroupSelect.disabled = true;
      }
    }

    function onPlanningGroupChange() {
      state.planningGroupName = this.options[this.selectedIndex].text;
      document.getElementById('weekSelect').disabled = !this.value;
    }

    function onWeekSelectChange() {
      if (this.value) {
        document.getElementById('weeklySummary').className = 'loading';
        document.getElementById('weeklySummary').textContent = 'Loading data...';
        fetchDataForWeek(this.value);
      }
    }

    function setActiveTab(tabName) {
      document.getElementById('dailyTab').classList.toggle('active', tabName === 'daily');
      document.getElementById('intervalTab').classList.toggle('active', tabName === 'interval');
      document.getElementById('dailyTabButton').classList.toggle('active', tabName === 'daily');
      document.getElementById('intervalTabButton').classList.toggle('active', tabName === 'interval');
    }

    // Helper functions
    function formatTime(seconds) {
      if (!seconds) return '0s';
      seconds = Math.round(seconds);
      
      if (config.timeFormat === 'hms') {
        const h = Math.floor(seconds / 3600);
        const m = Math.floor((seconds % 3600) / 60);
        const s = Math.floor(seconds % 60);
        return h > 0 ? `${h}:${m.toString().padStart(2, '0')}:${s.toString().padStart(2, '0')}` 
                     : `${m}:${s.toString().padStart(2, '0')}`;
      }
      return seconds + 's';
    }

    function formatHours(seconds) {
      if (!seconds) return '0h';
      return (seconds / 3600).toFixed(config.precision) + 'h';
    }

    function formatNumber(num) {
      return num.toFixed(config.precision);
    }

    function getDayOfWeek(dateStr) {
      try {
        // Try parsing as UK format (DD/MM/YYYY)
        const parts = dateStr.split('/');
        if (parts.length === 3) {
          const day = parseInt(parts[0], 10);
          const month = parseInt(parts[1], 10) - 1;
          const year = parseInt(parts[2], 10);
          const date = new Date(year, month, day);
          if (!isNaN(date.getTime())) {
            return date.toLocaleDateString('en-US', { weekday: 'long' });
          }
        }
        
        // Fallback to ISO format
        const date = new Date(dateStr);
        if (!isNaN(date.getTime())) {
          return date.toLocaleDateString('en-US', { weekday: 'long' });
        }
      } catch (e) {
        console.error('Error parsing date:', dateStr, e);
      }
      return 'Unknown';
    }

    function getUKFormattedDate(date) {
      const day = date.getDate();
      const month = date.getMonth() + 1;
      const year = date.getFullYear();
      return (day < 10 ? '0' + day : day) + '/' +
             (month < 10 ? '0' + month : month) + '/' +
             year;
    }

    function getWeekDates(startDate) {
      const dates = [];
      const start = new Date(startDate);
      
      for (let i = 0; i < 7; i++) {
        const currentDate = new Date(start);
        currentDate.setDate(start.getDate() + i);
        const raw = currentDate.toISOString().split('T')[0];
        const uk = getUKFormattedDate(currentDate);
        dates.push({ raw, uk });
      }
      
      return dates;
    }

    function populateWeekSelect() {
      const select = document.getElementById('weekSelect');
      select.innerHTML = '<option value="">-- Select Week --</option>';
      
      const today = new Date();
      const currentYear = today.getFullYear();
      
      // Start from the most recent Monday
      const dayOfWeek = today.getDay();
      const diff = today.getDate() - dayOfWeek + (dayOfWeek === 0 ? -6 : 1);
      const monday = new Date(today.setDate(diff));
      
      // Create options for 52 weeks (1 year)
      for (let w = 0; w < 52; w++) {
        const weekStart = new Date(monday);
        weekStart.setDate(monday.getDate() + (w * 7));
        const weekEnd = new Date(weekStart);
        weekEnd.setDate(weekStart.getDate() + 6);
        
        const weekStartStr = getUKFormattedDate(weekStart);
        const weekEndStr = getUKFormattedDate(weekEnd);
        const isoWeekStart = weekStart.toISOString().split('T')[0];
        
        const option = document.createElement('option');
        option.value = isoWeekStart;
        option.textContent = `Week ${weekStartStr} - ${weekEndStr}`;
        
        // Mark current week as selected
        if (w === 0) {
          option.selected = true;
        }
        
        select.appendChild(option);
      }
      
      select.disabled = false;
    }

    // Data fetching functions
    async function fetchBusinessUnits() {
      try {
        const response = await fetch(`https://api.${config.REGION}/api/v2/workforcemanagement/businessunits`, {
          headers: {
            'Authorization': 'Bearer ' + state.accessToken
          }
        });
        
        if (!response.ok) throw new Error('Failed to fetch business units');
        
        const data = await response.json();
        const select = document.getElementById('businessUnitSelect');
        select.innerHTML = '<option value="">-- Select Business Unit --</option>';
        
        data.entities.forEach(bu => {
          const option = document.createElement('option');
          option.value = bu.id;
          option.textContent = bu.name;
          select.appendChild(option);
        });
        
        select.disabled = false;
      } catch (error) {
        console.error('Error fetching business units:', error);
        document.getElementById('businessUnitSelect').innerHTML = '<option value="">-- Error loading business units --</option>';
      }
    }

    async function fetchPlanningGroups(businessUnitId) {
      try {
        const response = await fetch(`https://api.${config.REGION}/api/v2/workforcemanagement/businessunits/${businessUnitId}/planninggroups`, {
          headers: {
            'Authorization': 'Bearer ' + state.accessToken
          }
        });
        
        if (!response.ok) throw new Error('Failed to fetch planning groups');
        
        const data = await response.json();
        const select = document.getElementById('planningGroup');
        select.innerHTML = '<option value="">-- Select Planning Group --</option>';
        
        data.entities.forEach(pg => {
          const option = document.createElement('option');
          option.value = pg.id;
          option.textContent = pg.name;
          select.appendChild(option);
        });
        
        select.disabled = false;
      } catch (error) {
        console.error('Error fetching planning groups:', error);
        document.getElementById('planningGroup').innerHTML = '<option value="">-- Error loading groups --</option>';
      }
    }

    async function fetchIntradayData(date) {
      const businessUnitId = document.getElementById('businessUnitSelect').value;
      const planningGroupId = document.getElementById('planningGroup').value;
      
      if (!businessUnitId) {
        return { date: date, data: null, error: 'No business unit selected' };
      }
      
      try {
        const response = await fetch(`https://api.${config.REGION}/api/v2/workforcemanagement/businessunits/${businessUnitId}/intraday`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': 'Bearer ' + state.accessToken
          },
          body: JSON.stringify({
            businessUnitDate: date,
            categories: ["ForecastData", "PerformancePredictionData", "ScheduleData"],
            intervalLengthMinutes: 15,
            planningGroupIds: planningGroupId ? [planningGroupId] : null
          })
        });
        
        if (!response.ok) {
          if (response.status === 404) {
            return { date: date, data: null, error: 'No data available for this date' };
          }
          throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const data = await response.json();
        return { date: date, data: data };
      } catch (error) {
        console.error('Error fetching intraday data:', error);
        return { date: date, data: null, error: error.message };
      }
    }

    async function fetchDataForWeek(startDate) {
      const dateObjs = getWeekDates(startDate);
      const fetchPromises = dateObjs.map(dateObj => 
        fetchIntradayData(dateObj.raw).then(result => ({ ...result, uk: dateObj.uk }))
      );
      
      state.weekData = await Promise.all(fetchPromises);
      renderAllData();
    }

    // Rendering functions
    function renderAllData() {
      renderDailyTable();
      
      if (document.getElementById('intervalTab').classList.contains('active')) {
        const intervalTitle = document.querySelector('#intervalTableContainer h3');
        if (intervalTitle) {
          const match = intervalTitle.textContent.match(/for (\d{2}\/\d{2}\/\d{4}) \((Voice|Message)\)/);
          if (match) {
            const day = state.weekData.find(d => d.uk === match[1]);
            if (day) {
              render15MinTable(day, match[2]);
            }
          }
        }
      }
    }

    function renderDailyTable() {
      const mediaTypeFilter = document.getElementById('mediaType').value;
      let tableHTML = `
        <table>
          <thead>
            <tr>
              <th>Date</th>
              <th>Day</th>
              <th>Planning Group</th>
              <th>Media Type</th>
              <th>Forecast Offered</th>
              <th>Forecast AHT</th>
              <th>Scheduled Time</th>
              <th>Service Level</th>
              <th>ASA</th>
              <th>Occupancy</th>
              <th>Action</th>
            </tr>
          </thead>
          <tbody>
      `;

      const weeklyTotals = {
        offered: 0,
        aht: 0,
        scheduledTime: 0,
        serviceLevel: 0,
        asa: 0,
        occupancy: 0,
        count: 0
      };

      state.weekData.forEach(day => {
        if (!day.data || !day.data.result) {
          const dayOfWeek = getDayOfWeek(day.uk);
          tableHTML += `
            <tr>
              <td>${day.uk}</td>
              <td>${dayOfWeek}</td>
              <td colspan="9" class="no-data">${day.error || 'No data available'}</td>
            </tr>
          `;
          return;
        }

        day.data.result.intradayDataGroupings.forEach(group => {
          if (mediaTypeFilter && group.mediaType !== mediaTypeFilter) return;

          const offered = group.forecastDataSummary?.offered || 0;
          const aht = group.forecastDataSummary?.averageHandleTimeSeconds || 0;
          const scheduledTime = group.scheduleDataSummary?.onQueueTimeSeconds || 0;
          const serviceLevel = group.performancePredictionDataSummary?.serviceLevelPercent || 0;
          const asa = group.performancePredictionDataSummary?.averageSpeedOfAnswerSeconds || 0;
          const occupancy = group.performancePredictionDataSummary?.occupancyPercent || 0;

          weeklyTotals.offered += offered;
          weeklyTotals.aht += aht;
          weeklyTotals.scheduledTime += scheduledTime;
          weeklyTotals.serviceLevel += serviceLevel;
          weeklyTotals.asa += asa;
          weeklyTotals.occupancy += occupancy;
          weeklyTotals.count++;

          const dayOfWeek = getDayOfWeek(day.uk);
          
          tableHTML += `
            <tr>
              <td>${day.uk}</td>
              <td>${dayOfWeek}</td>
              <td>${state.planningGroupName}</td>
              <td>${group.mediaType}</td>
              <td>${Math.round(offered)}</td>
              <td>${formatTime(aht)}</td>
              <td>${formatHours(scheduledTime)}</td>
              <td>${formatNumber(serviceLevel)}%</td>
              <td>${formatTime(asa)}</td>
              <td>${formatNumber(occupancy)}%</td>
              <td>
                <button onclick='show15MinDetails(${JSON.stringify(day).replace(/'/g, "&apos;")}, "${group.mediaType}")'>
                  View Details
                </button>
              </td>
            </tr>
          `;
        });
      });

      // Calculate weekly averages
      const weeklyAvgAHT = weeklyTotals.count > 0 ? weeklyTotals.aht / weeklyTotals.count : 0;
      const weeklyAvgSL = weeklyTotals.count > 0 ? weeklyTotals.serviceLevel / weeklyTotals.count : 0;
      const weeklyAvgASA = weeklyTotals.count > 0 ? weeklyTotals.asa / weeklyTotals.count : 0;
      const weeklyAvgOccupancy = weeklyTotals.count > 0 ? weeklyTotals.occupancy / weeklyTotals.count : 0;

      // Create weekly summary
      const summaryHTML = `
        <table class="summary-table">
          <thead>
            <tr>
              <th>Summary</th>
              <th>Forecast Offered</th>
              <th>Avg AHT</th>
              <th>Total Scheduled</th>
              <th>Avg SL</th>
              <th>Avg ASA</th>
              <th>Avg Occupancy</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td>Weekly Totals/Averages</td>
              <td>${Math.round(weeklyTotals.offered)}</td>
              <td>${formatTime(weeklyAvgAHT)}</td>
              <td>${formatHours(weeklyTotals.scheduledTime)}</td>
              <td>${formatNumber(weeklyAvgSL)}%</td>
              <td>${formatTime(weeklyAvgASA)}</td>
              <td>${formatNumber(weeklyAvgOccupancy)}%</td>
            </tr>
          </tbody>
        </table>
      `;

      document.getElementById('weeklySummary').innerHTML = summaryHTML;
      document.getElementById('weeklySummary').className = '';
      tableHTML += '</tbody></table>';
      document.getElementById('dailyTableContainer').innerHTML = tableHTML;
    }

    function render15MinTable(day, mediaType) {
      let tableHTML = `<h3>15-min Intervals for ${day.uk} (${mediaType})</h3>`;
      tableHTML += `
        <table>
          <thead>
            <tr>
              <th>Time</th>
              <th>Forecast Offered</th>
              <th>Forecast AHT</th>
              <th>Scheduled Time</th>
              <th>Service Level</th>
              <th>ASA</th>
              <th>Occupancy</th>
            </tr>
          </thead>
          <tbody>
      `;
      
      if (day.data?.result?.intradayDataGroupings) {
        const grouping = day.data.result.intradayDataGroupings.find(g => g.mediaType === mediaType);
        if (!grouping) {
          tableHTML += '<tr><td colspan="7" class="no-data">No data for selected media type</td></tr>';
        } else {
          const startDate = new Date(day.data.result.startDate);
          let hasDataStarted = false;
          
          for (let i = 0; i < 96; i++) {
            const intervalTime = new Date(startDate);
            intervalTime.setMinutes(intervalTime.getMinutes() + i * 15);
            const timeStr = intervalTime.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
            
            const hasData = (grouping.forecastDataPerInterval?.[i] || 
                            grouping.scheduleDataPerInterval?.[i] || 
                            grouping.performancePredictionDataPerInterval?.[i]);
            
            if (!hasDataStarted && !hasData) continue;
            hasDataStarted = true;
            
            const forecast = grouping.forecastDataPerInterval?.[i] || {};
            const schedule = grouping.scheduleDataPerInterval?.[i] || {};
            const performance = grouping.performancePredictionDataPerInterval?.[i] || {};
            
            tableHTML += `
              <tr>
                <td>${timeStr}</td>
                <td>${Math.round(forecast.offered || 0)}</td>
                <td>${formatTime(forecast.averageHandleTimeSeconds || 0)}</td>
                <td>${formatHours(schedule.onQueueTimeSeconds || 0)}</td>
                <td>${performance.serviceLevelPercent ? formatNumber(performance.serviceLevelPercent) + '%' : '0%'}</td>
                <td>${formatTime(performance.averageSpeedOfAnswerSeconds || 0)}</td>
                <td>${performance.occupancyPercent ? formatNumber(performance.occupancyPercent) + '%' : '0%'}</td>
              </tr>
            `;
          }
        }
      } else {
        tableHTML += '<tr><td colspan="7" class="no-data">No data available</td></tr>';
      }
      
      tableHTML += '</tbody></table>';
      document.getElementById('intervalTableContainer').innerHTML = tableHTML;
      document.getElementById('intervalTableContainer').className = '';
    }

    function show15MinDetails(day, mediaType) {
      setActiveTab('interval');
      render15MinTable(day, mediaType);
    }
  </script>
</body>
</html>
